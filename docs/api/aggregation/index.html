
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stephengenusa.github.io/ai-ensemble-suite/api/aggregation/">
      
      
        <link rel="prev" href="../collaboration/">
      
      
        <link rel="next" href="../utilities/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Aggregation - ai-ensemble-suite</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#aggregation-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ai-ensemble-suite" class="md-header__button md-logo" aria-label="ai-ensemble-suite" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ai-ensemble-suite
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Aggregation
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/StephenGenusa/ai-ensemble-suite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    StephenGenusa/ai-ensemble-suite
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ai-ensemble-suite" class="md-nav__button md-logo" aria-label="ai-ensemble-suite" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ai-ensemble-suite
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/StephenGenusa/ai-ensemble-suite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    StephenGenusa/ai-ensemble-suite
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/installation.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/quickstart.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/configuration.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/advanced.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Usage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/collaboration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Collaboration Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Aggregation Strategies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Production Configurations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ensemble/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ensemble
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../collaboration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Collaboration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Aggregation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Aggregation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      aggregation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.AdaptiveSelection" class="md-nav__link">
    <span class="md-ellipsis">
      AdaptiveSelection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaptiveSelection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.AdaptiveSelection.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.AdaptiveSelection.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAggregator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseAggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_final_phase" class="md-nav__link">
    <span class="md-ellipsis">
      get_final_phase
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_required_models" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_models
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.ConfidenceBased" class="md-nav__link">
    <span class="md-ellipsis">
      ConfidenceBased
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ConfidenceBased">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.ConfidenceBased.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.ConfidenceBased.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.EnsembleFusion" class="md-nav__link">
    <span class="md-ellipsis">
      EnsembleFusion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EnsembleFusion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.EnsembleFusion.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.EnsembleFusion.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.MultidimensionalVoting" class="md-nav__link">
    <span class="md-ellipsis">
      MultidimensionalVoting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultidimensionalVoting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.MultidimensionalVoting.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.MultidimensionalVoting.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.SequentialRefinement" class="md-nav__link">
    <span class="md-ellipsis">
      SequentialRefinement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequentialRefinement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.SequentialRefinement.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.SequentialRefinement.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.WeightedVoting" class="md-nav__link">
    <span class="md-ellipsis">
      WeightedVoting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WeightedVoting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.WeightedVoting.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.WeightedVoting.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      aggregation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.AdaptiveSelection" class="md-nav__link">
    <span class="md-ellipsis">
      AdaptiveSelection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdaptiveSelection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.AdaptiveSelection.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.AdaptiveSelection.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator" class="md-nav__link">
    <span class="md-ellipsis">
      BaseAggregator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseAggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_final_phase" class="md-nav__link">
    <span class="md-ellipsis">
      get_final_phase
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.BaseAggregator.get_required_models" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_models
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.ConfidenceBased" class="md-nav__link">
    <span class="md-ellipsis">
      ConfidenceBased
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ConfidenceBased">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.ConfidenceBased.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.ConfidenceBased.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.EnsembleFusion" class="md-nav__link">
    <span class="md-ellipsis">
      EnsembleFusion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EnsembleFusion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.EnsembleFusion.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.EnsembleFusion.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.MultidimensionalVoting" class="md-nav__link">
    <span class="md-ellipsis">
      MultidimensionalVoting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultidimensionalVoting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.MultidimensionalVoting.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.MultidimensionalVoting.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.SequentialRefinement" class="md-nav__link">
    <span class="md-ellipsis">
      SequentialRefinement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SequentialRefinement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.SequentialRefinement.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.SequentialRefinement.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.WeightedVoting" class="md-nav__link">
    <span class="md-ellipsis">
      WeightedVoting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WeightedVoting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.WeightedVoting.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.aggregation.WeightedVoting.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="aggregation-api">Aggregation API</h1>
<p>API reference for aggregation methods. </p>


<div class="doc doc-object doc-module">



<a id="ai_ensemble_suite.aggregation"></a>
    <div class="doc doc-contents first">

        <p>Aggregation strategies for ai-ensemble-suite.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.AdaptiveSelection" class="doc doc-heading">
            <code>AdaptiveSelection</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAggregator (ai_ensemble_suite.aggregation.base.BaseAggregator)" href="#ai_ensemble_suite.aggregation.BaseAggregator">BaseAggregator</a></code></p>


        <p>Adaptive Selection aggregation strategy.</p>
<p>Dynamically selects and executes another aggregation strategy based on
analysis of the query, context, phase outputs, or an explicit selector model.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\adaptive_selection.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveSelection</span><span class="p">(</span><span class="n">BaseAggregator</span><span class="p">):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptive Selection aggregation strategy.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    Dynamically selects and executes another aggregation strategy based on</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    analysis of the query, context, phase outputs, or an explicit selector model.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="c1"># Override __init__ to accept model_manager</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># Should be &#39;adaptive_selection&#39;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Required for selector model</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the AdaptiveSelection aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">if</span> <span class="n">strategy_name</span> <span class="o">!=</span> <span class="s2">&quot;adaptive_selection&quot;</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdaptiveSelection initialized with unexpected strategy name &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the most appropriate strategy and execute it.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            outputs: Dictionary mapping phase names to their outputs.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            context: Context information from collaboration phases (should include &#39;query&#39;).</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            Dictionary containing the result from the executed sub-strategy, potentially</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            augmented with information about which strategy was selected.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            AggregationError: If selection or execution of the sub-strategy fails.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Adaptive Selection aggregation...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Adaptive Selection.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="c1"># Get the configuration for available strategies FROM THIS strategy&#39;s config</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="c1"># The &#39;strategies&#39; key should contain definitions like { &quot;name&quot;: { &quot;config_details&quot; } }</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="n">available_strategies_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategies&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="c1"># Provide default strategies if none are defined in config</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">available_strategies_config</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">available_strategies_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid &#39;strategies&#39; defined in AdaptiveSelection config, using defaults.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="n">available_strategies_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                    <span class="s2">&quot;sequential_refinement&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Uses the output of the final phase in a sequence.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                        <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="s2">&quot;refinement&quot;</span><span class="p">,</span> <span class="s2">&quot;conversation&quot;</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">],</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                        <span class="c1"># Example config for this strategy if run directly</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                        <span class="s2">&quot;final_phase&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="p">[])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                    <span class="p">},</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                    <span class="s2">&quot;confidence_based&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Selects the output with the highest confidence score.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                        <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;factual&quot;</span><span class="p">,</span> <span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;specific&quot;</span><span class="p">,</span> <span class="s2">&quot;high confidence&quot;</span><span class="p">],</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                        <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1"># Example config</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                    <span class="p">},</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="s2">&quot;weighted_voting&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Combines outputs based on pre-defined weights.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                        <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;opinion&quot;</span><span class="p">,</span> <span class="s2">&quot;subjective&quot;</span><span class="p">,</span> <span class="s2">&quot;creative&quot;</span><span class="p">,</span> <span class="s2">&quot;multiple options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                        <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># Example config (should ideally be populated)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="p">},</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                     <span class="s2">&quot;multidimensional_voting&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Evaluates outputs on multiple dimensions and selects highest weighted score.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                        <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;complex query&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-faceted&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluation needed&quot;</span><span class="p">],</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                        <span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">],</span> <span class="c1"># Example</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                        <span class="s2">&quot;dimension_weights&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># Example</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="p">},</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="s2">&quot;ensemble_fusion&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                         <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Uses a model to fuse multiple outputs into one.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                         <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;integration&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;combine perspectives&quot;</span><span class="p">],</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                         <span class="c1"># Needs fusion_model specified here or via context</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                    <span class="p">}</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="p">}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="c1"># Get contextual info like query type, if available</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="n">query</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="n">query_type</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Often determined earlier</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="c1"># --- Select the best strategy ---</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="n">selected_strategy_name</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_strategy</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">available_strategies_config</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_type</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adaptive Selection chose strategy: &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="c1"># Get the specific configuration for the selected strategy</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="c1"># This config will be passed as an override to the selected aggregator instance</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">strategy_config</span> <span class="o">=</span> <span class="n">available_strategies_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_strategy_name</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">strategy_config</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No configuration found for selected strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;, using empty config.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                 <span class="n">strategy_config</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>             <span class="c1"># Ensure the strategy name is part of its config for consistency</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="n">strategy_config</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_strategy_name</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="c1"># --- Instantiate and Execute the Selected Strategy ---</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="c1"># Get the class corresponding to the selected strategy name</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="n">aggregator_class</span> <span class="o">=</span> <span class="n">STRATEGY_CLASS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_strategy_name</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="k">if</span> <span class="n">aggregator_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot execute selected strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;: Class not found in registry. Falling back to default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="n">aggregator_class</span> <span class="o">=</span> <span class="n">DEFAULT_STRATEGY_CLASS</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="n">selected_strategy_name</span> <span class="o">=</span> <span class="n">DEFAULT_STRATEGY_NAME</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="c1"># Get default config? For now, use empty, BaseAggregator will load defaults.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">strategy_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">selected_strategy_name</span><span class="p">}</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="c1"># Create the aggregator instance, passing:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="c1"># - The *original* config_manager (for template access etc.)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="c1"># - The selected strategy name</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="c1"># - The model_manager (needed by some strategies)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="c1"># - The *specific configuration* for the selected strategy as an override</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">aggregator_instance</span> <span class="o">=</span> <span class="n">aggregator_class</span><span class="p">(</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="n">config_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="p">,</span> <span class="c1"># Original manager</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="n">selected_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                    <span class="n">model_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="p">,</span>    <span class="c1"># Pass model manager</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="n">strategy_config_override</span><span class="o">=</span><span class="n">strategy_config</span> <span class="c1"># Pass specific config</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to instantiate aggregator for strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create instance for strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="c1"># Execute the chosen strategy&#39;s aggregate method</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aggregator_instance</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="c1"># Add adaptive selection information to the final result</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;selected_strategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_strategy_name</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="sa">f</span><span class="s2">&quot;Adaptive Selection completed using &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="c1"># Add trace for AdaptiveSelection itself, including the sub-result</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="c1"># Name of THIS strategy</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span> <span class="c1"># &quot;adaptive_selection&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                        <span class="s2">&quot;available_strategies&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">available_strategies_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                        <span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="n">query_type</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                    <span class="p">},</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                    <span class="c1"># Output includes the result from the sub-strategy + selection info</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="n">output</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                        <span class="s2">&quot;_selected_strategy&quot;</span><span class="p">:</span> <span class="n">selected_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                        <span class="o">**</span><span class="n">result</span> <span class="c1"># Unpack the sub-strategy&#39;s result here</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="p">},</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters of THIS strategy</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                        <span class="c1"># Store the config structure used for selection</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                        <span class="s2">&quot;strategy_definitions&quot;</span><span class="p">:</span> <span class="n">available_strategies_config</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                        <span class="s2">&quot;selector_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selector_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                    <span class="p">}</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adaptive Selection aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>             <span class="k">raise</span> <span class="c1"># Re-raise known aggregation errors</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Adaptive Selection aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adaptive Selection aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_select_strategy</span><span class="p">(</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">available_strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="c1"># Configs for potential strategies</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">query_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the most appropriate aggregation strategy based on various factors.</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">            outputs: Outputs from collaboration phases.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">            context: Context dictionary.</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">            available_strategies: Dictionary mapping strategy names to their configurations/metadata.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">            query: The original user query.</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">            query_type: Pre-determined type/category of the query (if available).</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">            The name (string) of the selected strategy. Falls back to a default if selection fails.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Selecting aggregation strategy...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">strategies_to_consider</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">available_strategies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">strategies_to_consider</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No available strategies defined for selection. Falling back to default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>             <span class="k">return</span> <span class="n">DEFAULT_STRATEGY_NAME</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="c1"># --- Selection Logic (Priority Order) ---</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="c1"># 1. Check for explicit strategy preference in context</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">preferred_strategy</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferred_strategy&quot;</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="k">if</span> <span class="n">preferred_strategy</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preferred_strategy</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">preferred_strategy</span> <span class="ow">in</span> <span class="n">strategies_to_consider</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using preferred strategy from context: &#39;</span><span class="si">{</span><span class="n">preferred_strategy</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="k">return</span> <span class="n">preferred_strategy</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="c1"># 2. Use dedicated strategy selector model if configured</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">selector_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selector_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">if</span> <span class="n">selector_model_id</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Selector model specified, but ModelManager not available. Cannot use selector model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using selector model &#39;</span><span class="si">{</span><span class="n">selector_model_id</span><span class="si">}</span><span class="s2">&#39; to choose strategy.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                      <span class="c1"># Format strategy options for the selector prompt</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                      <span class="n">strategy_options_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">available_strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                           <span class="n">description</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Strategy: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                           <span class="n">conditions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                           <span class="n">conditions_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span> <span class="k">if</span> <span class="n">conditions</span> <span class="k">else</span> <span class="s2">&quot;General purpose&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                           <span class="n">strategy_options_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2"> (Best for: </span><span class="si">{</span><span class="n">conditions_str</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                      <span class="c1"># Create the prompt for the selector model</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                      <span class="n">selector_prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selector_prompt_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adaptive_selector_default&quot;</span><span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                      <span class="n">default_selector_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Given the user query and available aggregation strategies, select the *single best* strategy name.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="s2">USER QUERY:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="se">{{</span><span class="s2">query</span><span class="se">}}</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="s2">AVAILABLE STRATEGIES:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="se">{{</span><span class="s2">strategy_options</span><span class="se">}}</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="s2">Analyze the query and choose the strategy name from the list above that is most suitable.</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="s2">Respond with ONLY the strategy name (e.g., &#39;confidence_based&#39;, &#39;ensemble_fusion&#39;).&quot;&quot;&quot;</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                      <span class="n">selector_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                      <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                           <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;strategy_options&quot;</span><span class="p">:</span> <span class="n">strategy_options_prompt</span><span class="p">}</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                           <span class="n">selector_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">render_prompt</span><span class="p">(</span><span class="n">selector_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                      <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selector template &#39;</span><span class="si">{</span><span class="n">selector_prompt_template</span><span class="si">}</span><span class="s2">&#39; failed, using default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                            <span class="n">selector_prompt</span> <span class="o">=</span> <span class="n">default_selector_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">strategy_options</span><span class="o">=</span><span class="n">strategy_options_prompt</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                      <span class="c1"># Run the selector model inference</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                      <span class="n">selector_result_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                          <span class="n">model_id</span><span class="o">=</span><span class="n">selector_model_id</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                          <span class="n">prompt</span><span class="o">=</span><span class="n">selector_prompt</span><span class="p">,</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                          <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># Low temp for deterministic selection</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                          <span class="n">max_tokens</span><span class="o">=</span><span class="mi">50</span>    <span class="c1"># Expect short response (name only)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                      <span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                      <span class="c1"># Add trace for the selector model call</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                      <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                           <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                               <span class="n">model_id</span><span class="o">=</span><span class="n">selector_model_id</span><span class="p">,</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                               <span class="n">input_prompt</span><span class="o">=</span><span class="n">selector_prompt</span><span class="p">,</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                               <span class="n">output</span><span class="o">=</span><span class="n">selector_result_raw</span><span class="p">,</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                               <span class="n">execution_time</span><span class="o">=</span><span class="n">selector_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                               <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;strategy_selector&quot;</span><span class="p">}</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                           <span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                      <span class="c1"># Extract the selected strategy name from the model&#39;s response</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                      <span class="n">selected_name_raw</span> <span class="o">=</span> <span class="n">selector_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                      <span class="c1"># Clean up potential extra text</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                      <span class="n">selected_name_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\s:,\.\-]+&#39;</span><span class="p">,</span> <span class="n">selected_name_raw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                      <span class="c1"># Validate if the selected name is one of the available strategies</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                      <span class="k">if</span> <span class="n">selected_name_clean</span> <span class="ow">in</span> <span class="n">strategies_to_consider</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                          <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selector model chose strategy: &#39;</span><span class="si">{</span><span class="n">selected_name_clean</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                          <span class="k">return</span> <span class="n">selected_name_clean</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                      <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selector model returned invalid strategy name: &#39;</span><span class="si">{</span><span class="n">selected_name_raw</span><span class="si">}</span><span class="s2">&#39;. Ignoring.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                <span class="k">except</span> <span class="n">ModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy selector model &#39;</span><span class="si">{</span><span class="n">selector_model_id</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error using strategy selector model: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="c1"># 3. Use query type matching based on &#39;conditions&#39; in strategy config</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="k">if</span> <span class="n">query_type</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying strategy selection based on query_type: &#39;</span><span class="si">{</span><span class="n">query_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">query_type_lower</span> <span class="o">=</span> <span class="n">query_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">available_strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                 <span class="n">conditions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                      <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cond</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">query_type_lower</span><span class="p">:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matched query_type &#39;</span><span class="si">{</span><span class="n">query_type</span><span class="si">}</span><span class="s2">&#39; to condition &#39;</span><span class="si">{</span><span class="n">cond</span><span class="si">}</span><span class="s2">&#39; for strategy &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                                <span class="k">return</span> <span class="n">name</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="c1"># 4. Check phase outputs for keywords matching &#39;conditions&#39; (Less reliable)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="c1"># Combine text from all phase outputs</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="c1"># all_output_text = &quot; &quot;.join([self._extract_output(o_data) for o_data in outputs.values()])</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="c1"># if len(all_output_text) &gt; 50: # Only if there&#39;s substantial text</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="c1">#     all_output_text_lower = all_output_text.lower()</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="c1">#     match_counts: Dict[str, int] = {}</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="c1">#     for name, config in available_strategies.items():</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="c1">#         conditions = config.get(&quot;conditions&quot;, [])</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="c1">#         count = 0</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="c1">#         if isinstance(conditions, list):</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="c1">#             for cond in conditions:</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="c1">#                 if isinstance(cond, str) and cond.lower() in all_output_text_lower:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="c1">#                      count += 1</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="c1">#         if count &gt; 0: match_counts[name] = count</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="c1">#</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="c1">#     if match_counts:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="c1">#         # Select strategy with the most condition matches in the text</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="c1">#         best_match_strategy = max(match_counts, key=match_counts.get)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="c1">#         logger.debug(f&quot;Selected strategy &#39;{best_match_strategy}&#39; based on keyword matches in outputs &quot;</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="c1">#                      f&quot;(Matches: {match_counts[best_match_strategy]})&quot;)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="c1">#         return best_match_strategy</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="c1"># 5. Fallback: Use weighted selection if weights are defined (less common for adaptive)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="c1"># Or simply fallback to the default strategy if no specific selection criteria met.</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="c1"># --- Final Fallback ---</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No specific strategy selected based on criteria. Falling back to default: &#39;</span><span class="si">{</span><span class="n">DEFAULT_STRATEGY_NAME</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="c1"># Ensure the default is actually in the available list, otherwise pick the first available one</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="k">if</span> <span class="n">DEFAULT_STRATEGY_NAME</span> <span class="ow">in</span> <span class="n">strategies_to_consider</span><span class="p">:</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>             <span class="k">return</span> <span class="n">DEFAULT_STRATEGY_NAME</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">elif</span> <span class="n">strategies_to_consider</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>             <span class="n">first_available</span> <span class="o">=</span> <span class="n">strategies_to_consider</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default strategy &#39;</span><span class="si">{</span><span class="n">DEFAULT_STRATEGY_NAME</span><span class="si">}</span><span class="s2">&#39; not available, using first available: &#39;</span><span class="si">{</span><span class="n">first_available</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>             <span class="k">return</span> <span class="n">first_available</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>             <span class="c1"># This case should be caught earlier, but as a safety net:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Cannot select strategy: No available strategies defined and no default applicable.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.AdaptiveSelection.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the AdaptiveSelection aggregator.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\adaptive_selection.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># Should be &#39;adaptive_selection&#39;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Required for selector model</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the AdaptiveSelection aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">strategy_name</span> <span class="o">!=</span> <span class="s2">&quot;adaptive_selection&quot;</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdaptiveSelection initialized with unexpected strategy name &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.AdaptiveSelection.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Select the most appropriate strategy and execute it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>outputs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping phase names to their outputs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from collaboration phases (should include 'query').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the result from the executed sub-strategy, potentially</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>augmented with information about which strategy was selected.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.AggregationError">AggregationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If selection or execution of the sub-strategy fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\adaptive_selection.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Select the most appropriate strategy and execute it.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        outputs: Dictionary mapping phase names to their outputs.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        context: Context information from collaboration phases (should include &#39;query&#39;).</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        Dictionary containing the result from the executed sub-strategy, potentially</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        augmented with information about which strategy was selected.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        AggregationError: If selection or execution of the sub-strategy fails.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Adaptive Selection aggregation...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>         <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Adaptive Selection.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="c1"># Get the configuration for available strategies FROM THIS strategy&#39;s config</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="c1"># The &#39;strategies&#39; key should contain definitions like { &quot;name&quot;: { &quot;config_details&quot; } }</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">available_strategies_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategies&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="c1"># Provide default strategies if none are defined in config</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_strategies_config</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">available_strategies_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid &#39;strategies&#39; defined in AdaptiveSelection config, using defaults.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">available_strategies_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="s2">&quot;sequential_refinement&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Uses the output of the final phase in a sequence.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="s2">&quot;refinement&quot;</span><span class="p">,</span> <span class="s2">&quot;conversation&quot;</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">],</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                    <span class="c1"># Example config for this strategy if run directly</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                    <span class="s2">&quot;final_phase&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="p">[])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="p">},</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="s2">&quot;confidence_based&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Selects the output with the highest confidence score.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;factual&quot;</span><span class="p">,</span> <span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;specific&quot;</span><span class="p">,</span> <span class="s2">&quot;high confidence&quot;</span><span class="p">],</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                    <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1"># Example config</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="p">},</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="s2">&quot;weighted_voting&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Combines outputs based on pre-defined weights.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;opinion&quot;</span><span class="p">,</span> <span class="s2">&quot;subjective&quot;</span><span class="p">,</span> <span class="s2">&quot;creative&quot;</span><span class="p">,</span> <span class="s2">&quot;multiple options&quot;</span><span class="p">],</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                    <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># Example config (should ideally be populated)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="p">},</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                 <span class="s2">&quot;multidimensional_voting&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Evaluates outputs on multiple dimensions and selects highest weighted score.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;complex query&quot;</span><span class="p">,</span> <span class="s2">&quot;multi-faceted&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluation needed&quot;</span><span class="p">],</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">],</span> <span class="c1"># Example</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="s2">&quot;dimension_weights&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># Example</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="p">},</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="s2">&quot;ensemble_fusion&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                     <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Uses a model to fuse multiple outputs into one.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                     <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;integration&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;combine perspectives&quot;</span><span class="p">],</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                     <span class="c1"># Needs fusion_model specified here or via context</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="p">}</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="p">}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="c1"># Get contextual info like query type, if available</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">query_type</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Often determined earlier</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="c1"># --- Select the best strategy ---</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">selected_strategy_name</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_strategy</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">available_strategies_config</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_type</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adaptive Selection chose strategy: &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="c1"># Get the specific configuration for the selected strategy</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="c1"># This config will be passed as an override to the selected aggregator instance</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">strategy_config</span> <span class="o">=</span> <span class="n">available_strategies_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_strategy_name</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">strategy_config</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No configuration found for selected strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;, using empty config.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>             <span class="n">strategy_config</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>         <span class="c1"># Ensure the strategy name is part of its config for consistency</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">strategy_config</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_strategy_name</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="c1"># --- Instantiate and Execute the Selected Strategy ---</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="c1"># Get the class corresponding to the selected strategy name</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">aggregator_class</span> <span class="o">=</span> <span class="n">STRATEGY_CLASS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_strategy_name</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">if</span> <span class="n">aggregator_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot execute selected strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;: Class not found in registry. Falling back to default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">aggregator_class</span> <span class="o">=</span> <span class="n">DEFAULT_STRATEGY_CLASS</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">selected_strategy_name</span> <span class="o">=</span> <span class="n">DEFAULT_STRATEGY_NAME</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="c1"># Get default config? For now, use empty, BaseAggregator will load defaults.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">strategy_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">selected_strategy_name</span><span class="p">}</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="c1"># Create the aggregator instance, passing:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="c1"># - The *original* config_manager (for template access etc.)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="c1"># - The selected strategy name</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="c1"># - The model_manager (needed by some strategies)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="c1"># - The *specific configuration* for the selected strategy as an override</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">aggregator_instance</span> <span class="o">=</span> <span class="n">aggregator_class</span><span class="p">(</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">config_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="p">,</span> <span class="c1"># Original manager</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">strategy_name</span><span class="o">=</span><span class="n">selected_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="n">model_manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="p">,</span>    <span class="c1"># Pass model manager</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="n">strategy_config_override</span><span class="o">=</span><span class="n">strategy_config</span> <span class="c1"># Pass specific config</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to instantiate aggregator for strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create instance for strategy &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="c1"># Execute the chosen strategy&#39;s aggregate method</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aggregator_instance</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="c1"># Add adaptive selection information to the final result</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;selected_strategy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_strategy_name</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="sa">f</span><span class="s2">&quot;Adaptive Selection completed using &#39;</span><span class="si">{</span><span class="n">selected_strategy_name</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s.&quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="c1"># Add trace for AdaptiveSelection itself, including the sub-result</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="c1"># Name of THIS strategy</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span> <span class="c1"># &quot;adaptive_selection&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                    <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                    <span class="s2">&quot;available_strategies&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">available_strategies_config</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                    <span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="n">query_type</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="p">},</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="c1"># Output includes the result from the sub-strategy + selection info</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">output</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                    <span class="s2">&quot;_selected_strategy&quot;</span><span class="p">:</span> <span class="n">selected_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                    <span class="o">**</span><span class="n">result</span> <span class="c1"># Unpack the sub-strategy&#39;s result here</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="p">},</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters of THIS strategy</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="c1"># Store the config structure used for selection</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="s2">&quot;strategy_definitions&quot;</span><span class="p">:</span> <span class="n">available_strategies_config</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="s2">&quot;selector_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selector_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="p">}</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adaptive Selection aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>         <span class="k">raise</span> <span class="c1"># Re-raise known aggregation errors</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Adaptive Selection aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adaptive Selection aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.BaseAggregator" class="doc doc-heading">
            <code>BaseAggregator</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for aggregation strategies.</p>
<p>Defines the interface for aggregators and provides common functionality
like configuration handling and default confidence calculation.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">BaseAggregator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for aggregation strategies.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Defines the interface for aggregators and provides common functionality</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    like configuration handling and default confidence calculation.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Added model_manager</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Added override</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the aggregator.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            config_manager: The main ConfigManager instance.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            strategy_name: The name of the strategy for configuration lookup.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            model_manager: Optional ModelManager instance, required by some strategies.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            strategy_config_override: Optional dictionary to directly use as the</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">                                      strategy&#39;s config, bypassing config_manager lookup.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">                                      Used by AdaptiveSelection.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            ConfigurationError: If strategy configuration loading fails (and no override).</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            TypeError: If config_manager is not provided.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">if</span> <span class="n">config_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>             <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ConfigManager instance is required for BaseAggregator.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span> <span class="o">=</span> <span class="n">config_manager</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span> <span class="o">=</span> <span class="n">strategy_name</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="o">=</span> <span class="n">model_manager</span> <span class="c1"># Store the model manager</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="c1"># Load strategy configuration</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">if</span> <span class="n">strategy_config_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using provided config override for strategy &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>             <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>             <span class="c1"># Ensure &#39;strategy&#39; key exists in override for consistency? Maybe not needed.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>             <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="c1"># Fetch config using the strategy name</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_aggregation_config</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="c1"># Re-raise with more context</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                    <span class="sa">f</span><span class="s2">&quot;Failed to load configuration for aggregation strategy &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized aggregation strategy &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate the outputs from collaboration phases.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">            outputs: Dictionary mapping phase names to their full output dictionaries.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">                     Each value typically contains &#39;output&#39;, &#39;confidence&#39;, etc.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            context: Dictionary containing context information from the ensemble run,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">                     potentially including the original query, phase sequence, etc.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            A dictionary containing at least:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">                response: The final aggregated output as a string.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">                confidence: A float score (0.0-1.0) representing the confidence</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">                            in the aggregated response.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            May contain additional strategy-specific information (e.g., &#39;best_phase&#39;).</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">            AggregationError: If the aggregation process fails significantly.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="k">pass</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_output_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract the primary output text content from a phase&#39;s result data.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            phase_output_data: The data structure returned by a collaboration phase.</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="sd">            The extracted output text as a string, or an empty string if none found.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="k">return</span> <span class="n">phase_output_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="c1"># Try common keys in preferred order</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="c1"># Added &#39;result&#39; based on potential model outputs</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;final_output&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;critique&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># Fallback for nested results (like AsyncThinking might have &#39;outputs&#39;: {&#39;model_id&#39;: {&#39;text&#39;: ...}})</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">outputs_dict</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">outputs_dict</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                 <span class="c1"># Try to get the first output&#39;s text, somewhat arbitrary</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                 <span class="n">first_output_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">outputs_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                 <span class="k">if</span> <span class="n">first_output_key</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                      <span class="n">first_output_data</span> <span class="o">=</span> <span class="n">outputs_dict</span><span class="p">[</span><span class="n">first_output_key</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                      <span class="c1"># Check if the nested output data itself is a dict with text</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                           <span class="c1"># Check common keys again within the nested structure</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                           <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                                <span class="n">content</span> <span class="o">=</span> <span class="n">first_output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                                     <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted text from nested output under key &#39;</span><span class="si">{</span><span class="n">first_output_key</span><span class="si">}</span><span class="s2">&#39;-&gt;&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                                     <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                      <span class="c1"># Check if the nested output data is just the string itself</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_output_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                          <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted text directly from nested output under key &#39;</span><span class="si">{</span><span class="n">first_output_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                          <span class="k">return</span> <span class="n">first_output_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="c1"># If no common key found or input is not dict/str, try converting non-complex types</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="c1"># Avoid converting large dicts/lists/bytes directly, might indicate wrong field access or hide errors</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                 <span class="c1"># Check if it&#39;s a simple dict/list with a single string value (less common)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                      <span class="n">single_value</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                           <span class="n">single_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">phase_output_data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                           <span class="n">single_value</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">single_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                           <span class="k">return</span> <span class="n">single_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                 <span class="c1"># Otherwise, assume complex structure we can&#39;t reliably stringify</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot reliably extract text from complex data structure: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                 <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>             <span class="c1"># Check if it&#39;s a simple type that can be stringified safely (int, float, bool, NoneType)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="k">elif</span> <span class="n">phase_output_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Explicitly handle None</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span> <span class="c1"># Add other simple types as needed</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                 <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># Unknown potentially complex type</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot extract text from phase output of unexpected type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span><span class="si">}</span><span class="s2">. Returning empty string.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                 <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert phase output of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> to string: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Return empty string if conversion fails or is inappropriate</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the configuration specific to this aggregation strategy.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">            A deep copy of the strategy&#39;s configuration dictionary.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of this aggregation strategy.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">            The strategy name string.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="c1"># Kept this method, but note that model requirements might be needed for some strategies</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="c1"># Consider moving model requirement logic elsewhere or making it dynamic?</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the set of models specifically required BY THE AGGREGATOR itself.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        Note: This usually applies only to model-based aggregators like EnsembleFusion</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">              or evaluation models used in MultidimensionalVoting/AdaptiveSelection.</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">            Set of model IDs required directly by this aggregation strategy.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="c1"># Default: Most aggregators don&#39;t inherently require specific models themselves.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="c1"># Strategies needing models should override this or get models from config.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="c1"># Example for model-based aggregators (they should override this):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="k">if</span> <span class="s2">&quot;fusion_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>             <span class="n">required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;fusion_model&quot;</span><span class="p">])</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">if</span> <span class="s2">&quot;evaluator_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>             <span class="n">required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;evaluator_model&quot;</span><span class="p">])</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="k">if</span> <span class="s2">&quot;selector_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span> <span class="c1"># For AdaptiveSelection</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>             <span class="n">required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;selector_model&quot;</span><span class="p">])</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">return</span> <span class="n">required</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_final_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the phase considered &#39;final&#39; by this strategy&#39;s config.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        Used by strategies like SequentialRefinement or as a fallback.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">            The name of the final phase string, or None if not specified.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="c1"># Get from the strategy-specific config</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_phase&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_confidence</span><span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">phase_outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate an overall confidence score based on input phase outputs.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        Provides a default implementation that averages confidence scores found</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">        in the phase outputs. Subclasses can override this for more specific logic.</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">            phase_outputs: Dictionary mapping phase names to their outputs.</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">            A confidence score between 0.0 and 1.0.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">confidence_scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">output_data</span> <span class="ow">in</span> <span class="n">phase_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="c1"># Check if the output is a dict and contains a &#39;confidence&#39; key</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">output_data</span><span class="p">:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="n">confidence_value</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confidence_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="c1"># Direct numeric confidence score</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">confidence_value</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confidence_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="c1"># Nested dictionary, look for a &#39;combined&#39; score first</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="n">score</span> <span class="o">=</span> <span class="n">confidence_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="c1"># Fallback: average all numeric values in the confidence dict? Risky.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="c1"># Or maybe use a specific metric like &#39;token_prob&#39;?</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                    <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">score</span> <span class="o">=</span> <span class="n">confidence_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_prob&quot;</span><span class="p">)</span> <span class="c1"># Example fallback</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="c1"># Ensure score is a valid number</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                     <span class="c1"># Clamp score to valid range [0, 1]</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                     <span class="n">clamped_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                     <span class="n">confidence_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clamped_score</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="c1"># else:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                <span class="c1">#     logger.debug(f&quot;Non-numeric or missing &#39;combined&#39; confidence found in phase &#39;{phase_name}&#39;.&quot;)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="c1"># Calculate average confidence or return default if no scores available</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">if</span> <span class="n">confidence_scores</span><span class="p">:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="n">average_confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_scores</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated average confidence from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">confidence_scores</span><span class="p">)</span><span class="si">}</span><span class="s2"> phases: </span><span class="si">{</span><span class="n">average_confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="k">return</span> <span class="n">average_confidence</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid confidence scores found in any phase outputs, returning default confidence 0.7&quot;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="k">return</span> <span class="mf">0.7</span>  <span class="c1"># Default medium-high confidence</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.BaseAggregator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the aggregator.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConfigManager (ai_ensemble_suite.config.ConfigManager)" href="../configuration/#ai_ensemble_suite.config.ConfigManager">ConfigManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The main ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the strategy for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ModelManager (ai_ensemble_suite.models.ModelManager)" href="../models/#ai_ensemble_suite.models.ModelManager">ModelManager</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ModelManager instance, required by some strategies.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy_config_override</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dictionary to directly use as the
                      strategy's config, bypassing config_manager lookup.
                      Used by AdaptiveSelection.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If strategy configuration loading fails (and no override).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If config_manager is not provided.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Added model_manager</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Added override</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the aggregator.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        config_manager: The main ConfigManager instance.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        strategy_name: The name of the strategy for configuration lookup.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        model_manager: Optional ModelManager instance, required by some strategies.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        strategy_config_override: Optional dictionary to directly use as the</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">                                  strategy&#39;s config, bypassing config_manager lookup.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">                                  Used by AdaptiveSelection.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        ConfigurationError: If strategy configuration loading fails (and no override).</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        TypeError: If config_manager is not provided.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">if</span> <span class="n">config_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ConfigManager instance is required for BaseAggregator.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span> <span class="o">=</span> <span class="n">config_manager</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span> <span class="o">=</span> <span class="n">strategy_name</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="o">=</span> <span class="n">model_manager</span> <span class="c1"># Store the model manager</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># Load strategy configuration</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">if</span> <span class="n">strategy_config_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using provided config override for strategy &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>         <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>         <span class="c1"># Ensure &#39;strategy&#39; key exists in override for consistency? Maybe not needed.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>         <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="c1"># Fetch config using the strategy name</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_aggregation_config</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="c1"># Re-raise with more context</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to load configuration for aggregation strategy &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized aggregation strategy &#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.BaseAggregator.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate the outputs from collaboration phases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>outputs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping phase names to their full output dictionaries.
     Each value typically contains 'output', 'confidence', etc.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing context information from the ensemble run,
     potentially including the original query, phase sequence, etc.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing at least:
response: The final aggregated output as a string.
confidence: A float score (0.0-1.0) representing the confidence
            in the aggregated response.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>May contain additional strategy-specific information (e.g., 'best_phase').</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.AggregationError">AggregationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the aggregation process fails significantly.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span>
<span class="normal"><a href="#__codelineno-0-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="nd">@abstractmethod</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate the outputs from collaboration phases.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        outputs: Dictionary mapping phase names to their full output dictionaries.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">                 Each value typically contains &#39;output&#39;, &#39;confidence&#39;, etc.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        context: Dictionary containing context information from the ensemble run,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">                 potentially including the original query, phase sequence, etc.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        A dictionary containing at least:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            response: The final aggregated output as a string.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            confidence: A float score (0.0-1.0) representing the confidence</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">                        in the aggregated response.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        May contain additional strategy-specific information (e.g., &#39;best_phase&#39;).</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        AggregationError: If the aggregation process fails significantly.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.BaseAggregator.get_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the configuration specific to this aggregation strategy.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A deep copy of the strategy's configuration dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the configuration specific to this aggregation strategy.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        A deep copy of the strategy&#39;s configuration dictionary.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.BaseAggregator.get_final_phase" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_final_phase</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the name of the phase considered 'final' by this strategy's config.</p>
<p>Used by strategies like SequentialRefinement or as a fallback.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the final phase string, or None if not specified.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_final_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the name of the phase considered &#39;final&#39; by this strategy&#39;s config.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Used by strategies like SequentialRefinement or as a fallback.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        The name of the final phase string, or None if not specified.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="c1"># Get from the strategy-specific config</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_phase&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.BaseAggregator.get_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_name</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the name of this aggregation strategy.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The strategy name string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the name of this aggregation strategy.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        The strategy name string.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.BaseAggregator.get_required_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_required_models</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the set of models specifically required BY THE AGGREGATOR itself.</p>


<details class="note" open>
  <summary>This usually applies only to model-based aggregators like EnsembleFusion</summary>
  <p>or evaluation models used in MultidimensionalVoting/AdaptiveSelection.</p>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Set">Set</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Set of model IDs required directly by this aggregation strategy.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_required_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the set of models specifically required BY THE AGGREGATOR itself.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">    Note: This usually applies only to model-based aggregators like EnsembleFusion</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">          or evaluation models used in MultidimensionalVoting/AdaptiveSelection.</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        Set of model IDs required directly by this aggregation strategy.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="c1"># Default: Most aggregators don&#39;t inherently require specific models themselves.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="c1"># Strategies needing models should override this or get models from config.</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="c1"># Example for model-based aggregators (they should override this):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="k">if</span> <span class="s2">&quot;fusion_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>         <span class="n">required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;fusion_model&quot;</span><span class="p">])</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="k">if</span> <span class="s2">&quot;evaluator_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>         <span class="n">required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;evaluator_model&quot;</span><span class="p">])</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">if</span> <span class="s2">&quot;selector_model&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span> <span class="c1"># For AdaptiveSelection</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>         <span class="n">required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;selector_model&quot;</span><span class="p">])</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="k">return</span> <span class="n">required</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.ConfidenceBased" class="doc doc-heading">
            <code>ConfidenceBased</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAggregator (ai_ensemble_suite.aggregation.base.BaseAggregator)" href="#ai_ensemble_suite.aggregation.BaseAggregator">BaseAggregator</a></code></p>


        <p>Confidence-Based aggregation strategy.</p>
<p>Selects the output from the collaboration phase that has the highest
associated confidence score, potentially applying a minimum threshold.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\confidence_based.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConfidenceBased</span><span class="p">(</span><span class="n">BaseAggregator</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Confidence-Based aggregation strategy.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Selects the output from the collaboration phase that has the highest</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    associated confidence score, potentially applying a minimum threshold.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="c1"># Override __init__ to accept optional model_manager and override</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="c1"># Although this strategy doesn&#39;t use model_manager, maintain signature consistency</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ConfidenceBased aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="c1"># No specific init needed</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate outputs by selecting the one with the highest confidence score.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            context: Context information from collaboration phases.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">                response: The text output from the highest confidence phase.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">                confidence: The confidence score of the selected output.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">                source_phase: The name of the phase providing the selected output.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">                confidence_scores: Dictionary mapping all phase names to their scores.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            AggregationError: If no outputs with valid confidence scores are available.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Confidence-Based aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Confidence-Based aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="c1"># Get confidence threshold from strategy configuration</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># Default is 0.0 (consider all)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid confidence threshold &#39;</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&#39;, using 0.0.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                 <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="c1"># --- Extract confidence scores and outputs ---</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">scored_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># (phase_name, output_text, confidence_score)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">all_phase_confidences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Store all scores for tracing/result</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="n">output_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="c1"># Skip phases where text extraction failed</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">output_text</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract text from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                    <span class="n">all_phase_confidences</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Indicate missing text</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Default to invalid score</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">phase_output_data</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                    <span class="n">conf_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">conf_val</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                        <span class="c1"># Prioritize &#39;combined&#39; score if available</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                        <span class="n">combined_score</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                             <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_score</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="c1"># Ensure confidence is within [0, 1] range</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">confidence</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                     <span class="n">all_phase_confidences</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                     <span class="c1"># Add to list if above the configured threshold</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                     <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                         <span class="n">scored_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">confidence</span><span class="p">))</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; added with confidence </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (&gt;= threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                     <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                          <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; skipped, confidence </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &lt; threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="c1"># Log phases with missing or invalid confidence</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; has missing or invalid confidence score.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                    <span class="n">all_phase_confidences</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Mark as invalid</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="c1"># --- Determine the best output ---</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">scored_outputs</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="c1"># No outputs met the threshold (or none had valid confidence)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No outputs met the confidence threshold &gt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                               <span class="sa">f</span><span class="s2">&quot;Falling back to highest available score (ignoring threshold) or default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="c1"># Fallback 1: Find highest score among *all* phases with valid scores</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">score</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">all_phase_confidences</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">}</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="k">if</span> <span class="n">valid_scores</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                     <span class="n">best_fallback_phase</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">valid_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                     <span class="n">best_fallback_score</span> <span class="o">=</span> <span class="n">valid_scores</span><span class="p">[</span><span class="n">best_fallback_phase</span><span class="p">]</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                     <span class="n">best_fallback_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">best_fallback_phase</span><span class="p">])</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fallback phase &#39;</span><span class="si">{</span><span class="n">best_fallback_phase</span><span class="si">}</span><span class="s2">&#39; with confidence </span><span class="si">{</span><span class="n">best_fallback_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                     <span class="n">scored_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">best_fallback_phase</span><span class="p">,</span> <span class="n">best_fallback_text</span><span class="p">,</span> <span class="n">best_fallback_score</span><span class="p">))</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="c1"># Fallback 2: If NO valid scores at all, error out</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No outputs with valid confidence scores available for aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="c1"># Sort the valid (above threshold or best fallback) outputs by confidence (descending)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">scored_outputs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="c1"># Get the highest confidence output from the filtered/sorted list</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">best_phase_name</span><span class="p">,</span> <span class="n">best_output_text</span><span class="p">,</span> <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">scored_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="sa">f</span><span class="s2">&quot;Confidence-Based aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="sa">f</span><span class="s2">&quot;Selected phase: &#39;</span><span class="si">{</span><span class="n">best_phase_name</span><span class="si">}</span><span class="s2">&#39; (Confidence: </span><span class="si">{</span><span class="n">best_confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                 <span class="n">extra</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">threshold</span> <span class="p">}</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">best_output_text</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_confidence</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="s2">&quot;source_phase&quot;</span><span class="p">:</span> <span class="n">best_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="c1"># Include map of all phase confidences (even invalid ones marked as -1)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                <span class="s2">&quot;confidence_scores&quot;</span><span class="p">:</span> <span class="n">all_phase_confidences</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="p">}</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                    <span class="p">},</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span> <span class="c1"># Contains response, confidence, source, scores map</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters used by this strategy</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                        <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                        <span class="c1"># Maybe trace the sorted list for debugging? Could be large.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                        <span class="c1"># &quot;sorted_scored_outputs&quot;: [(p, c) for p, _, c in scored_outputs]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                    <span class="p">}</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence-based aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>             <span class="k">raise</span> <span class="c1"># Re-raise known aggregation errors</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Confidence-Based aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence-Based aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.ConfidenceBased.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the ConfidenceBased aggregator.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\confidence_based.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the ConfidenceBased aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.ConfidenceBased.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate outputs by selecting the one with the highest confidence score.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>outputs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping phase names to their output data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from collaboration phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
response: The text output from the highest confidence phase.
confidence: The confidence score of the selected output.
source_phase: The name of the phase providing the selected output.
confidence_scores: Dictionary mapping all phase names to their scores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.AggregationError">AggregationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no outputs with valid confidence scores are available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\confidence_based.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate outputs by selecting the one with the highest confidence score.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        context: Context information from collaboration phases.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            response: The text output from the highest confidence phase.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            confidence: The confidence score of the selected output.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            source_phase: The name of the phase providing the selected output.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            confidence_scores: Dictionary mapping all phase names to their scores.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        AggregationError: If no outputs with valid confidence scores are available.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Confidence-Based aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>         <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Confidence-Based aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># Get confidence threshold from strategy configuration</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># Default is 0.0 (consider all)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid confidence threshold &#39;</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&#39;, using 0.0.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>             <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="c1"># --- Extract confidence scores and outputs ---</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">scored_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># (phase_name, output_text, confidence_score)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">all_phase_confidences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Store all scores for tracing/result</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">output_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="c1"># Skip phases where text extraction failed</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">output_text</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract text from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="n">all_phase_confidences</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Indicate missing text</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="k">continue</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Default to invalid score</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">phase_output_data</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="n">conf_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                    <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">conf_val</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="c1"># Prioritize &#39;combined&#39; score if available</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="n">combined_score</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                         <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_score</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="c1"># Ensure confidence is within [0, 1] range</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">confidence</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                 <span class="n">all_phase_confidences</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                 <span class="c1"># Add to list if above the configured threshold</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                 <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                     <span class="n">scored_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">output_text</span><span class="p">,</span> <span class="n">confidence</span><span class="p">))</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; added with confidence </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (&gt;= threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; skipped, confidence </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &lt; threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="c1"># Log phases with missing or invalid confidence</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; has missing or invalid confidence score.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">all_phase_confidences</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="c1"># Mark as invalid</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="c1"># --- Determine the best output ---</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">scored_outputs</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># No outputs met the threshold (or none had valid confidence)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No outputs met the confidence threshold &gt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                           <span class="sa">f</span><span class="s2">&quot;Falling back to highest available score (ignoring threshold) or default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="c1"># Fallback 1: Find highest score among *all* phases with valid scores</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">score</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">all_phase_confidences</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">}</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">if</span> <span class="n">valid_scores</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                 <span class="n">best_fallback_phase</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">valid_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                 <span class="n">best_fallback_score</span> <span class="o">=</span> <span class="n">valid_scores</span><span class="p">[</span><span class="n">best_fallback_phase</span><span class="p">]</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                 <span class="n">best_fallback_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">best_fallback_phase</span><span class="p">])</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fallback phase &#39;</span><span class="si">{</span><span class="n">best_fallback_phase</span><span class="si">}</span><span class="s2">&#39; with confidence </span><span class="si">{</span><span class="n">best_fallback_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                 <span class="n">scored_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">best_fallback_phase</span><span class="p">,</span> <span class="n">best_fallback_text</span><span class="p">,</span> <span class="n">best_fallback_score</span><span class="p">))</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="c1"># Fallback 2: If NO valid scores at all, error out</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No outputs with valid confidence scores available for aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="c1"># Sort the valid (above threshold or best fallback) outputs by confidence (descending)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">scored_outputs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="c1"># Get the highest confidence output from the filtered/sorted list</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">best_phase_name</span><span class="p">,</span> <span class="n">best_output_text</span><span class="p">,</span> <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">scored_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="sa">f</span><span class="s2">&quot;Confidence-Based aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="sa">f</span><span class="s2">&quot;Selected phase: &#39;</span><span class="si">{</span><span class="n">best_phase_name</span><span class="si">}</span><span class="s2">&#39; (Confidence: </span><span class="si">{</span><span class="n">best_confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>             <span class="n">extra</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">threshold</span> <span class="p">}</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">best_output_text</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_confidence</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="s2">&quot;source_phase&quot;</span><span class="p">:</span> <span class="n">best_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="c1"># Include map of all phase confidences (even invalid ones marked as -1)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="s2">&quot;confidence_scores&quot;</span><span class="p">:</span> <span class="n">all_phase_confidences</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="p">}</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                    <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="p">},</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span> <span class="c1"># Contains response, confidence, source, scores map</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters used by this strategy</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                    <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="c1"># Maybe trace the sorted list for debugging? Could be large.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="c1"># &quot;sorted_scored_outputs&quot;: [(p, c) for p, _, c in scored_outputs]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="p">}</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence-based aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>         <span class="k">raise</span> <span class="c1"># Re-raise known aggregation errors</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Confidence-Based aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence-Based aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.EnsembleFusion" class="doc doc-heading">
            <code>EnsembleFusion</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAggregator (ai_ensemble_suite.aggregation.base.BaseAggregator)" href="#ai_ensemble_suite.aggregation.BaseAggregator">BaseAggregator</a></code></p>


        <p>Ensemble Fusion aggregation strategy.</p>
<p>Uses a designated 'fusion' model to synthesize multiple phase outputs into
a single, coherent response, aiming to integrate the best aspects of each input.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\ensemble_fusion.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnsembleFusion</span><span class="p">(</span><span class="n">BaseAggregator</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensemble Fusion aggregation strategy.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Uses a designated &#39;fusion&#39; model to synthesize multiple phase outputs into</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    a single, coherent response, aiming to integrate the best aspects of each input.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the EnsembleFusion aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EnsembleFusion strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39; initialized without a ModelManager. Aggregation will likely fail.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate phase outputs by using a specified model to fuse them.&quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Ensemble Fusion aggregation using strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;ModelManager is required for Ensemble Fusion but not available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Ensemble Fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="c1"># Determine the Fusion Model</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">fusion_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_model&quot;</span><span class="p">)</span> <span class="c1"># Key checked by schema</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">fusion_model_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_model&quot;</span><span class="p">,</span> <span class="n">fusion_model_id</span><span class="p">)</span> <span class="c1"># Allow context override</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">fusion_model_id</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                 <span class="c1"># Schema validation should require fusion_model, so this is unlikely</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Configuration Error: &#39;fusion_model&#39; is required but missing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Missing required &#39;fusion_model&#39; configuration for Ensemble Fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="c1"># Ensure the selected fusion model actually exists</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>                 <span class="n">fusion_model_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">fusion_model_id</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fusion model: </span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="k">except</span> <span class="n">ModelError</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specified fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; not found in ModelManager.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; not available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="c1"># Prepare Inputs for Fusion</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">outputs_to_fuse</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="n">extracted_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="k">if</span> <span class="n">extracted_text</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="n">outputs_to_fuse</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_text</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract usable text from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; for fusion input.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs_to_fuse</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                 <span class="c1"># Handle case where only one valid input exists - fusion might still be useful</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only one valid output found, using it directly instead of fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                      <span class="n">single_phase_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                      <span class="n">single_output_data</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">single_phase_name</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                      <span class="n">single_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">single_output_data</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                      <span class="n">single_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_confidence</span><span class="p">({</span><span class="n">single_phase_name</span><span class="p">:</span> <span class="n">single_output_data</span><span class="p">})</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                      <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                           <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">single_text</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                           <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">single_confidence</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                           <span class="s2">&quot;fusion_model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Indicate no fusion occurred</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                           <span class="s2">&quot;source_outputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">single_phase_name</span><span class="p">:</span> <span class="n">single_text</span><span class="p">}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                      <span class="p">}</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                      <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No valid outputs found to provide as input for fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="c1"># Format the collected outputs into a single string</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">fusion_input_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_fusion_input</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="c1"># Prepare and Run Fusion Prompt</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">fusion_template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_template&quot;</span><span class="p">,</span> <span class="s2">&quot;ensemble_fusion&quot;</span><span class="p">)</span> <span class="c1"># Checked by schema</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># Robust default template (in case formatting fails)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">default_fusion_template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Synthesize the following outputs into a single, high-quality response to the original query. Focus on integrating the best aspects, ensuring accuracy, clarity, and coherence. Avoid simply listing the inputs; create a unified final answer.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="s2">ORIGINAL QUERY:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="se">{{</span><span class="s2">query</span><span class="se">}}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="s2">INPUTS TO FUSE:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="se">{{</span><span class="s2">fusion_input</span><span class="se">}}</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="s2">Based on the query and the provided inputs, generate a comprehensive and well-structured final response:&quot;&quot;&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">query_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">if</span> <span class="n">query_context</span> <span class="o">==</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Query not found in context for fusion prompt.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query_context</span><span class="p">,</span> <span class="s2">&quot;fusion_input&quot;</span><span class="p">:</span> <span class="n">fusion_input_str</span><span class="p">}</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">fusion_template_name</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error formatting fusion template &#39;</span><span class="si">{</span><span class="n">fusion_template_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                 <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                      <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="n">default_fusion_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">,</span> <span class="n">fusion_input</span><span class="o">=</span><span class="n">fusion_input_str</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                 <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># Catch issues with the default template itself</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to format even the default fusion template.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                       <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Failed to create fusion prompt.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error formatting fusion prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                 <span class="c1"># Fallback to default on unexpected errors</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                 <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                      <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="n">default_fusion_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">,</span> <span class="n">fusion_input</span><span class="o">=</span><span class="n">fusion_input_str</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                 <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to format even the default fusion template on unexpected error.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                       <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Failed to create fusion prompt.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="c1"># Run the fusion model</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending fusion prompt to model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39;. Prompt length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fusion_prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">fusion_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                 <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_temperature&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                 <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_max_tokens&quot;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                 <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_top_p&quot;</span><span class="p">),</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                 <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_top_k&quot;</span><span class="p">),</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                 <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_repeat_penalty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">fusion_params_filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fusion_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion inference parameters: </span><span class="si">{</span><span class="n">fusion_params_filtered</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">fusion_result_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="n">model_id</span><span class="o">=</span><span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">fusion_prompt</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">compute_confidence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="o">**</span><span class="n">fusion_params_filtered</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received fusion result from model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="c1"># Process Fusion Result</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="n">fused_output_text</span> <span class="o">=</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">fused_output_text</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; returned empty text.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                 <span class="c1"># Consider fallback - maybe return best input based on confidence?</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                 <span class="c1"># For now, raise error if fusion genuinely failed.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; failed to generate output.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="c1"># Determine confidence score</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">fusion_model_confidence_data</span> <span class="o">=</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                 <span class="n">combined_conf</span> <span class="o">=</span> <span class="n">fusion_model_confidence_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">):</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                      <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                      <span class="n">numeric_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fusion_model_confidence_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                      <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numeric_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">numeric_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">numeric_scores</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">):</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                 <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">confidence</span><span class="p">))</span> <span class="c1"># Clamp [0, 1]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="c1"># Fallback confidence calculation if model confidence is low/zero</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fusion model did not provide significant confidence, calculating average from input phases.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                 <span class="c1"># Use helper to calculate avg confidence of phases that contributed to the input</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                 <span class="n">input_phase_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                 <span class="c1"># Filter original outputs dict to only include those used for fusion</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                 <span class="n">fusion_source_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_phase_names</span><span class="p">}</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                 <span class="n">average_input_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_confidence</span><span class="p">(</span><span class="n">fusion_source_outputs</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                 <span class="n">confidence</span> <span class="o">=</span> <span class="n">average_input_confidence</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using average input confidence as fallback: </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="sa">f</span><span class="s2">&quot;Ensemble Fusion aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s using model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="sa">f</span><span class="s2">&quot;Input phases fused: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">}</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="c1"># Prepare final result</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">fused_output_text</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="s2">&quot;fusion_model&quot;</span><span class="p">:</span> <span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="s2">&quot;source_outputs&quot;</span><span class="p">:</span> <span class="n">outputs_to_fuse</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="p">}</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1"># Add trace</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                 <span class="n">model_exec_time</span> <span class="o">=</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">,</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                 <span class="c1"># Add trace for the fusion model call itself</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                 <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                      <span class="n">model_id</span><span class="o">=</span><span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                      <span class="n">input_prompt</span><span class="o">=</span><span class="n">fusion_prompt</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                      <span class="n">output</span><span class="o">=</span><span class="n">fusion_result_raw</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                      <span class="n">execution_time</span><span class="o">=</span><span class="n">model_exec_time</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                      <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;fusion_aggregator&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">fusion_params_filtered</span><span class="p">}</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                 <span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                 <span class="c1"># Add trace for the aggregation step</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                 <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                    <span class="p">},</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                        <span class="s2">&quot;fusion_model_used&quot;</span><span class="p">:</span> <span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                        <span class="s2">&quot;fusion_template&quot;</span><span class="p">:</span> <span class="n">fusion_template_name</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                        <span class="o">**</span><span class="n">fusion_params_filtered</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="p">}</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                 <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble Fusion aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>             <span class="k">raise</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">except</span> <span class="n">ModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model error during Ensemble Fusion: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble Fusion failed due to model error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Ensemble Fusion aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble Fusion aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_fusion_input</span><span class="p">(</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">outputs_to_fuse</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Formats the extracted phase outputs into a structured string for the fusion prompt.&quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">formatted_input_parts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="c1"># Determine order: Use context sequence if available, else dict order</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">phase_sequence</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">ordered_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase_sequence</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">outputs_to_fuse</span><span class="p">]</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="n">remaining_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">outputs_to_fuse</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ordered_phases</span><span class="p">]</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">final_phase_order</span> <span class="o">=</span> <span class="n">ordered_phases</span> <span class="o">+</span> <span class="n">remaining_phases</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_phase_order</span><span class="p">):</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>             <span class="n">output_text</span> <span class="o">=</span> <span class="n">outputs_to_fuse</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>             <span class="c1"># Use clear separators and headers</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>             <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--- Input </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (from Phase: </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">) ---&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>             <span class="n">formatted_input_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="c1"># Join with double newline for separation</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_input_parts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.EnsembleFusion.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the EnsembleFusion aggregator.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\ensemble_fusion.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the EnsembleFusion aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EnsembleFusion strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39; initialized without a ModelManager. Aggregation will likely fail.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.EnsembleFusion.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate phase outputs by using a specified model to fuse them.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\ensemble_fusion.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate phase outputs by using a specified model to fuse them.&quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Ensemble Fusion aggregation using strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;ModelManager is required for Ensemble Fusion but not available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Ensemble Fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="c1"># Determine the Fusion Model</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">fusion_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_model&quot;</span><span class="p">)</span> <span class="c1"># Key checked by schema</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">fusion_model_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_model&quot;</span><span class="p">,</span> <span class="n">fusion_model_id</span><span class="p">)</span> <span class="c1"># Allow context override</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">fusion_model_id</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                 <span class="c1"># Schema validation should require fusion_model, so this is unlikely</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Configuration Error: &#39;fusion_model&#39; is required but missing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Missing required &#39;fusion_model&#39; configuration for Ensemble Fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="c1"># Ensure the selected fusion model actually exists</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>                 <span class="n">fusion_model_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">fusion_model_id</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using fusion model: </span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="k">except</span> <span class="n">ModelError</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specified fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; not found in ModelManager.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; not available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="c1"># Prepare Inputs for Fusion</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">outputs_to_fuse</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="n">extracted_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="k">if</span> <span class="n">extracted_text</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="n">outputs_to_fuse</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_text</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract usable text from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; for fusion input.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs_to_fuse</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                 <span class="c1"># Handle case where only one valid input exists - fusion might still be useful</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only one valid output found, using it directly instead of fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                      <span class="n">single_phase_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                      <span class="n">single_output_data</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">single_phase_name</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                      <span class="n">single_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">single_output_data</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                      <span class="n">single_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_confidence</span><span class="p">({</span><span class="n">single_phase_name</span><span class="p">:</span> <span class="n">single_output_data</span><span class="p">})</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                      <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                           <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">single_text</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                           <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">single_confidence</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                           <span class="s2">&quot;fusion_model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Indicate no fusion occurred</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                           <span class="s2">&quot;source_outputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">single_phase_name</span><span class="p">:</span> <span class="n">single_text</span><span class="p">}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                      <span class="p">}</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                      <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No valid outputs found to provide as input for fusion.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="c1"># Format the collected outputs into a single string</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">fusion_input_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_fusion_input</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="c1"># Prepare and Run Fusion Prompt</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">fusion_template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_template&quot;</span><span class="p">,</span> <span class="s2">&quot;ensemble_fusion&quot;</span><span class="p">)</span> <span class="c1"># Checked by schema</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># Robust default template (in case formatting fails)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">default_fusion_template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Synthesize the following outputs into a single, high-quality response to the original query. Focus on integrating the best aspects, ensuring accuracy, clarity, and coherence. Avoid simply listing the inputs; create a unified final answer.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="s2">ORIGINAL QUERY:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="se">{{</span><span class="s2">query</span><span class="se">}}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="s2">INPUTS TO FUSE:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="se">{{</span><span class="s2">fusion_input</span><span class="se">}}</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="s2">Based on the query and the provided inputs, generate a comprehensive and well-structured final response:&quot;&quot;&quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">query_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">if</span> <span class="n">query_context</span> <span class="o">==</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Query not found in context for fusion prompt.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query_context</span><span class="p">,</span> <span class="s2">&quot;fusion_input&quot;</span><span class="p">:</span> <span class="n">fusion_input_str</span><span class="p">}</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">fusion_template_name</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error formatting fusion template &#39;</span><span class="si">{</span><span class="n">fusion_template_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                 <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                      <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="n">default_fusion_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">,</span> <span class="n">fusion_input</span><span class="o">=</span><span class="n">fusion_input_str</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                 <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c1"># Catch issues with the default template itself</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to format even the default fusion template.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                       <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Failed to create fusion prompt.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error formatting fusion prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                 <span class="c1"># Fallback to default on unexpected errors</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                 <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                      <span class="n">fusion_prompt</span> <span class="o">=</span> <span class="n">default_fusion_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">,</span> <span class="n">fusion_input</span><span class="o">=</span><span class="n">fusion_input_str</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                 <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to format even the default fusion template on unexpected error.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                       <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Failed to create fusion prompt.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="c1"># Run the fusion model</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending fusion prompt to model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39;. Prompt length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fusion_prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">fusion_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                 <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_temperature&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                 <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_max_tokens&quot;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">),</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                 <span class="s2">&quot;top_p&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_top_p&quot;</span><span class="p">),</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                 <span class="s2">&quot;top_k&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_top_k&quot;</span><span class="p">),</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                 <span class="s2">&quot;repeat_penalty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fusion_repeat_penalty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">fusion_params_filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fusion_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion inference parameters: </span><span class="si">{</span><span class="n">fusion_params_filtered</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">fusion_result_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="n">model_id</span><span class="o">=</span><span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">fusion_prompt</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">compute_confidence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="o">**</span><span class="n">fusion_params_filtered</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received fusion result from model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="c1"># Process Fusion Result</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="n">fused_output_text</span> <span class="o">=</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">fused_output_text</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; returned empty text.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                 <span class="c1"># Consider fallback - maybe return best input based on confidence?</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                 <span class="c1"># For now, raise error if fusion genuinely failed.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39; failed to generate output.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="c1"># Determine confidence score</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">fusion_model_confidence_data</span> <span class="o">=</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                 <span class="n">combined_conf</span> <span class="o">=</span> <span class="n">fusion_model_confidence_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">):</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                      <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                      <span class="n">numeric_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fusion_model_confidence_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                      <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numeric_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">numeric_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">numeric_scores</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">):</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                 <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fusion_model_confidence_data</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">confidence</span><span class="p">))</span> <span class="c1"># Clamp [0, 1]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="c1"># Fallback confidence calculation if model confidence is low/zero</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fusion model did not provide significant confidence, calculating average from input phases.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                 <span class="c1"># Use helper to calculate avg confidence of phases that contributed to the input</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                 <span class="n">input_phase_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                 <span class="c1"># Filter original outputs dict to only include those used for fusion</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                 <span class="n">fusion_source_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_phase_names</span><span class="p">}</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                 <span class="n">average_input_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_confidence</span><span class="p">(</span><span class="n">fusion_source_outputs</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                 <span class="n">confidence</span> <span class="o">=</span> <span class="n">average_input_confidence</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using average input confidence as fallback: </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="sa">f</span><span class="s2">&quot;Ensemble Fusion aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s using model &#39;</span><span class="si">{</span><span class="n">fusion_model_id</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="sa">f</span><span class="s2">&quot;Input phases fused: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs_to_fuse</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">}</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="c1"># Prepare final result</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">fused_output_text</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="s2">&quot;fusion_model&quot;</span><span class="p">:</span> <span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="s2">&quot;source_outputs&quot;</span><span class="p">:</span> <span class="n">outputs_to_fuse</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="p">}</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1"># Add trace</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                 <span class="n">model_exec_time</span> <span class="o">=</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">,</span> <span class="n">fusion_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                 <span class="c1"># Add trace for the fusion model call itself</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                 <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                      <span class="n">model_id</span><span class="o">=</span><span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                      <span class="n">input_prompt</span><span class="o">=</span><span class="n">fusion_prompt</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                      <span class="n">output</span><span class="o">=</span><span class="n">fusion_result_raw</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                      <span class="n">execution_time</span><span class="o">=</span><span class="n">model_exec_time</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                      <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;fusion_aggregator&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">fusion_params_filtered</span><span class="p">}</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                 <span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                 <span class="c1"># Add trace for the aggregation step</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                 <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                    <span class="p">},</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                        <span class="s2">&quot;fusion_model_used&quot;</span><span class="p">:</span> <span class="n">fusion_model_id</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                        <span class="s2">&quot;fusion_template&quot;</span><span class="p">:</span> <span class="n">fusion_template_name</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                        <span class="o">**</span><span class="n">fusion_params_filtered</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="p">}</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                 <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble Fusion aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>             <span class="k">raise</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">except</span> <span class="n">ModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model error during Ensemble Fusion: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble Fusion failed due to model error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Ensemble Fusion aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensemble Fusion aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.MultidimensionalVoting" class="doc doc-heading">
            <code>MultidimensionalVoting</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAggregator (ai_ensemble_suite.aggregation.base.BaseAggregator)" href="#ai_ensemble_suite.aggregation.BaseAggregator">BaseAggregator</a></code></p>


        <p>Multi-dimensional Voting aggregation strategy.</p>
<p>Evaluates phase outputs along multiple configured dimensions (e.g., accuracy,
clarity) using scores potentially generated by an evaluator model or extracted
from context, then selects the output with the highest weighted score.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\multidimensional_voting.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultidimensionalVoting</span><span class="p">(</span><span class="n">BaseAggregator</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-dimensional Voting aggregation strategy.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Evaluates phase outputs along multiple configured dimensions (e.g., accuracy,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    clarity) using scores potentially generated by an evaluator model or extracted</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    from context, then selects the output with the highest weighted score.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="c1"># Override __init__ to accept model_manager</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Required for evaluation</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the MultidimensionalVoting aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="c1"># No specific initialization needed here currently</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="c1"># Context received here</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate outputs by evaluating multiple dimensions and voting.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            outputs: Dictionary mapping phase names to their outputs.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            context: Context information from collaboration phases (includes &#39;query&#39;).</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">                response: The aggregated output (from the best phase) as a string.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">                confidence: The weighted score of the best phase as confidence.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">                best_phase: The name of the phase selected as best.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">                dimension_scores: Scores for each phase across dimensions (0.0-1.0).</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">                weighted_scores: Final weighted score for each phase (0.0-1.0).</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            AggregationError: If aggregation fails (e.g., no outputs, evaluation fails).</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Multidimensional Voting aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Multidimensional Voting aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="c1"># Get dimensions from strategy configuration</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="c1"># Default dimensions if not specified or invalid</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="n">default_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid or empty &#39;dimensions&#39; in config, using defaults: </span><span class="si">{</span><span class="n">default_dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="n">dimensions</span> <span class="o">=</span> <span class="n">default_dims</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="c1"># Get dimension weights from strategy configuration</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">dimension_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimension_weights&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimension_weights</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;dimension_weights&#39; in config (must be dict), using equal weights.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                 <span class="n">dimension_weights</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="c1"># Ensure all specified dimensions have a weight, defaulting to equal if needed</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="n">normalized_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">dimensions_with_weight</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">total_weight_specified</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="n">weight</span> <span class="o">=</span> <span class="n">dimension_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Use -1 to detect unspecified</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">weight</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                     <span class="n">normalized_weights</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                     <span class="n">dimensions_with_weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                     <span class="n">total_weight_specified</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="c1"># Else: Skip dimensions with invalid or negative weights defined</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="c1"># If no valid weights specified or sum is zero, use equal weights for *all* original dimensions</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dimensions_with_weight</span> <span class="ow">or</span> <span class="n">total_weight_specified</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using default equal weights for all dimensions.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="n">equal_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span> <span class="k">if</span> <span class="n">dimensions</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="n">equal_weight</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="n">dimensions_with_weight</span> <span class="o">=</span> <span class="n">dimensions</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="n">total_weight_after_default</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="c1"># Should be close to 1.0</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default equal weights applied: </span><span class="si">{</span><span class="n">normalized_weights</span><span class="si">}</span><span class="s2"> (Sum: </span><span class="si">{</span><span class="n">total_weight_after_default</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="c1"># If weights were specified and sum &gt; 0, normalize them if they don&#39;t sum to 1</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">total_weight_specified</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalizing specified dimension weights from sum </span><span class="si">{</span><span class="n">total_weight_specified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                 <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="n">w</span> <span class="o">/</span> <span class="n">total_weight_specified</span> <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">normalized_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                 <span class="n">total_weight_after_normalize</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalized weights: </span><span class="si">{</span><span class="n">normalized_weights</span><span class="si">}</span><span class="s2"> (Sum: </span><span class="si">{</span><span class="n">total_weight_after_normalize</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># --- Get scores for each phase and dimension ---</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">dimension_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># { phase_name: { dimension: score } }</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="c1"># 1. Look for pre-evaluated scores within phase outputs</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; output as it&#39;s not a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                      <span class="k">continue</span> <span class="c1"># Skip non-dict outputs</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                 <span class="n">phase_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                 <span class="c1"># Check common locations for scores (evaluations dict, specific keys, text parsing)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                 <span class="c1"># Prioritize &#39;evaluations&#39; dict if present</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                 <span class="n">evals_dict</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evals_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                      <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span> <span class="c1"># Only look for relevant dimensions</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                           <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">evals_dict</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evals_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                                <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">evals_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">])))</span> <span class="c1"># Normalize/clamp 0-1</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                 <span class="c1"># Look for direct keys like &#39;accuracy_score&#39; if not found above</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                 <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                      <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_scores</span><span class="p">:</span> <span class="c1"># Only if not already found in &#39;evaluations&#39;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                           <span class="n">dim_key_score</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_score&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                           <span class="n">dim_key_rating</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_rating&quot;</span> <span class="c1"># Another common pattern</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                           <span class="n">score_val</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                           <span class="k">if</span> <span class="n">dim_key_score</span> <span class="ow">in</span> <span class="n">phase_output_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_score</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                                <span class="n">score_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_score</span><span class="p">]</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                           <span class="k">elif</span> <span class="n">dim_key_rating</span> <span class="ow">in</span> <span class="n">phase_output_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_rating</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                                <span class="n">score_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_rating</span><span class="p">]</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                           <span class="k">if</span> <span class="n">score_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                                <span class="c1"># Assume scores/ratings are 0-1 or 0-10, 1-10 etc. Normalize best guess.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                                <span class="k">if</span> <span class="n">score_val</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">score_val</span> <span class="o">=</span> <span class="n">score_val</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c1"># Assume out of 10</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                                <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">score_val</span><span class="p">)))</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                 <span class="c1"># Attempt regex extraction from output text if scores still missing for some dims</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                 <span class="n">output_text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                 <span class="k">if</span> <span class="n">output_text_content</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                      <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                           <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_scores</span><span class="p">:</span> <span class="c1"># Only parse if score not found yet</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                                <span class="c1"># Regex looks for &quot;dimension: score/10&quot; patterns, more robustly</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                                <span class="n">score_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s1">\s*[:\-]?\s*score\s*[:\-]?\s*(\d+(?:\.\d+)?)\s*/\s*10&#39;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern</span><span class="p">,</span> <span class="n">output_text_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span> <span class="c1"># Try alternate pattern like &quot;dimension: 8&quot; (assume out of 10)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                                     <span class="n">score_pattern_alt</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s1">\s*[:\-]?\s*(\d+(?:\.\d+)?)(?!\s*/)&#39;</span> <span class="c1"># Number not followed by /</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                                     <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern_alt</span><span class="p">,</span> <span class="n">output_text_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                                         <span class="n">score_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                                         <span class="c1"># Normalize if it seems to be out of 10</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                                         <span class="k">if</span> <span class="n">score_val</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="s1">&#39;/10&#39;</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                                              <span class="n">score_val</span> <span class="o">=</span> <span class="n">score_val</span> <span class="o">/</span> <span class="mf">10.0</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                                         <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">score_val</span><span class="p">))</span> <span class="c1"># Normalize 0-1</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse score for dim &#39;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&#39; in phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; output via regex.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                 <span class="c1"># Store scores found for this phase if any relevant ones were found</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                 <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">phase_scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                      <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_scores</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial dimension scores extracted: </span><span class="si">{</span><span class="n">dimension_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="c1"># 2. If scores incomplete or missing, use evaluator model if configured</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">evaluator_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluator_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="n">evaluator_model_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluator_model&quot;</span><span class="p">,</span> <span class="n">evaluator_model_id</span><span class="p">)</span> <span class="c1"># Allow context override</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="c1"># Determine if evaluation is needed</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">phases_needing_scores</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">phases_with_incomplete_scores</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                 <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="p">}</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">needs_evaluation</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">phases_needing_scores</span> <span class="ow">or</span> <span class="n">phases_with_incomplete_scores</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="k">if</span> <span class="n">needs_evaluation</span> <span class="ow">and</span> <span class="n">evaluator_model_id</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Evaluator model specified, but ModelManager not available to aggregator. Cannot perform model-based evaluation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing dimension evaluation using model: </span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                      <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                           <span class="c1"># *** FIX: Pass context to _evaluate_phases ***</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                           <span class="c1"># Pass only the dimensions that have weights assigned</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                           <span class="n">evaluated_scores</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_phases</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                               <span class="n">outputs</span><span class="p">,</span> <span class="n">dimensions_with_weight</span><span class="p">,</span> <span class="n">evaluator_model_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                           <span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                           <span class="c1"># Merge evaluated scores, filling gaps. Evaluated scores take precedence? Let&#39;s say yes.</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                           <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">evaluated_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                               <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                                    <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                               <span class="c1"># Update existing dict, overwriting with newly evaluated scores</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                               <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                               <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated/Added evaluated scores for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                      <span class="k">except</span> <span class="n">ModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Continuing without its evaluation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                            <span class="c1"># Continue without evaluated scores if evaluation fails</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                           <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during phase evaluation using model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                           <span class="c1"># Continue without evaluated scores</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="c1"># 3. Fallback: Use confidence scores if dimension scores are STILL missing/incomplete</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">phases_still_needing_scores</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">phases_still_incomplete</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                 <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="p">}</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="k">if</span> <span class="n">phases_still_needing_scores</span> <span class="ow">or</span> <span class="n">phases_still_incomplete</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dimension scores still incomplete after potential evaluation, using phase confidence scores as fallback.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                 <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                      <span class="c1"># Check if scores are needed for this phase</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                      <span class="n">needs_score_fill</span> <span class="o">=</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases_still_needing_scores</span> <span class="ow">or</span> \
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                                         <span class="p">(</span><span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases_still_incomplete</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phase_name</span><span class="p">),</span> <span class="nb">dict</span><span class="p">))</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                      <span class="k">if</span> <span class="n">needs_score_fill</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                           <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">phase_output_data</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                                <span class="n">conf_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                                     <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)))</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                                     <span class="n">combined_conf</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                                         <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">)))</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                           <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                                <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                                     <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                                <span class="c1"># Fill in missing scores for dimensions_with_weight using confidence</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                                     <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                                          <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using confidence </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> to fill missing dimension scores for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="c1"># 4. Final Fallback: Assign default scores (e.g., 0.5) if still no scores for some phases</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">phases_finally_needing_scores</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="n">phases_finally_incomplete</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                 <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                 <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="p">}</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="k">if</span> <span class="n">phases_finally_needing_scores</span> <span class="ow">or</span> <span class="n">phases_finally_incomplete</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                 <span class="n">default_fallback_score</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Use a neutral default</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No scores or confidence available for some phases/dimensions, assigning default score (</span><span class="si">{</span><span class="n">default_fallback_score</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                 <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                      <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                          <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="n">default_fallback_score</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">}</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                      <span class="k">elif</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases_finally_incomplete</span><span class="p">:</span> <span class="c1"># Already has a dict, fill missing</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                           <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                                <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">default_fallback_score</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="c1"># --- Calculate weighted scores for each phase ---</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">weighted_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">dimension_scores</span><span class="p">:</span> <span class="c1"># Check if somehow still empty</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Could not determine dimension scores for any phase.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                 <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># Skip if phase wasn&#39;t in original outputs</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                 <span class="n">current_weighted_score</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                 <span class="n">current_total_weight</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Track weight used *for this phase*</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                 <span class="c1"># Calculate weighted sum using the normalized weights</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                 <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                     <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">normalized_weights</span><span class="p">:</span> <span class="c1"># Use only dimensions with defined, normalized weights</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                          <span class="n">weight</span> <span class="o">=</span> <span class="n">normalized_weights</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                          <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Skip dimensions with zero or negative weight</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                               <span class="n">current_weighted_score</span> <span class="o">+=</span> <span class="n">score</span> <span class="o">*</span> <span class="n">weight</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                               <span class="n">current_total_weight</span> <span class="o">+=</span> <span class="n">weight</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                          <span class="c1"># Else: Ignore dimensions without weight or with zero weight</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                 <span class="c1"># Normalize score by total weight actually used for this phase&#39;s scoring</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                 <span class="c1"># This handles cases where some dimensions might be missing scores or weights</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                 <span class="k">if</span> <span class="n">current_total_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                       <span class="n">weighted_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_weighted_score</span> <span class="o">/</span> <span class="n">current_total_weight</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                 <span class="k">elif</span> <span class="n">scores</span><span class="p">:</span> <span class="c1"># If weights were zero/missing but scores existed, use simple average of available scores</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total applicable weight for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; was zero, using average score.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                       <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                       <span class="n">weighted_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">valid_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">valid_scores</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                 <span class="k">else</span><span class="p">:</span> <span class="c1"># No scores and no applicable weights</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No scores or applicable weights for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, assigning default weighted score 0.5.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                      <span class="n">weighted_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated final weighted scores: </span><span class="si">{</span><span class="n">weighted_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="c1"># --- Select the best phase ---</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">weighted_scores</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phases remaining after scoring for aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="c1"># Select the phase with the highest weighted score</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="c1"># Use max(), handling potential ties by taking the first one found (dict order dependent in &lt;3.7)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="c1"># For more robust tie-breaking, could use confidence or other factors.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="n">best_phase_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weighted_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">weighted_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">best_score</span> <span class="o">=</span> <span class="n">weighted_scores</span><span class="p">[</span><span class="n">best_phase_name</span><span class="p">]</span> <span class="c1"># This is the final normalized weighted score</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="c1"># Extract the output content from the best phase</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="n">best_output_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">best_phase_name</span><span class="p">])</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                <span class="sa">f</span><span class="s2">&quot;Multidimensional Voting aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                <span class="sa">f</span><span class="s2">&quot;Best phase: &#39;</span><span class="si">{</span><span class="n">best_phase_name</span><span class="si">}</span><span class="s2">&#39; (Weighted Score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;dimensions_used&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">}</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">best_output_content</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span> <span class="c1"># Use the final weighted score as confidence</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="s2">&quot;best_phase&quot;</span><span class="p">:</span> <span class="n">best_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                 <span class="c1"># Include detailed scores for dimensions that had weights</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                <span class="s2">&quot;dimension_scores&quot;</span><span class="p">:</span> <span class="n">dimension_scores</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="s2">&quot;weighted_scores&quot;</span><span class="p">:</span> <span class="n">weighted_scores</span> <span class="c1"># Include final weighted scores per phase</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="p">}</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                        <span class="s2">&quot;configured_dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions</span><span class="p">,</span> <span class="c1"># Original list from config</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                        <span class="s2">&quot;configured_weights&quot;</span><span class="p">:</span> <span class="n">dimension_weights</span><span class="p">,</span> <span class="c1"># Original weights from config</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                    <span class="p">},</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters influencing the outcome</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                        <span class="s2">&quot;effective_dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions_with_weight</span><span class="p">,</span> <span class="c1"># Dimensions actually used</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                        <span class="s2">&quot;normalized_weights&quot;</span><span class="p">:</span> <span class="n">normalized_weights</span><span class="p">,</span> <span class="c1"># Weights used in calculation</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                        <span class="s2">&quot;evaluator_model&quot;</span><span class="p">:</span> <span class="n">evaluator_model_id</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                    <span class="p">}</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>                <span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multidimensional voting aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>             <span class="k">raise</span> <span class="c1"># Re-raise known aggregation errors</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Multidimensional Voting aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="c1"># Wrap unexpected errors in AggregationError</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multidimensional Voting aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_phases</span><span class="p">(</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="n">evaluator_model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>  <span class="c1"># Added missing context parameter</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate phase outputs using a specified model along multiple dimensions.</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">            outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">            dimensions: List of dimension names (strings) to evaluate.</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">            evaluator_model_id: ID of the model to use for evaluation.</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">            context: Context dictionary (needed for the query).</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">            Dictionary mapping phase names to their evaluated dimension scores (0.0-1.0).</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">            Returns empty dict if evaluation fails significantly.</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">            ModelError: If the evaluation model fails.</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">            AggregationError: If required components like ModelManager are missing.</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;ModelManager is required for evaluation but not available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> phases using model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39; on dimensions: </span><span class="si">{</span><span class="n">dimensions</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="c1"># Format outputs for the evaluation prompt</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">formatted_outputs_for_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">valid_outputs_to_eval</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Keep track of which outputs we could format</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">output_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="k">if</span> <span class="n">output_text</span><span class="p">:</span> <span class="c1"># Only include phases with extractable text</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="n">formatted_outputs_for_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## Output from Phase: </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="n">valid_outputs_to_eval</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_text</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract text from output of phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; for evaluation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">formatted_outputs_for_prompt</span><span class="p">:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid outputs found to format for evaluation prompt.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>             <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="c1"># Create dimensions string for the prompt</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">dimensions_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="c1"># Get evaluation prompt template from config (or use a robust default)</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="n">evaluation_template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_template&quot;</span><span class="p">,</span> <span class="s2">&quot;multidimensional_evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="c1"># Default template asking for scores 0-10</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">default_eval_template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Please evaluate the following outputs based on the user query and the specified dimensions.</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="s2">USER QUERY:</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="se">{{</span><span class="s2">query</span><span class="se">}}</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a><span class="s2">DIMENSIONS TO EVALUATE: </span><span class="si">{</span><span class="n">dimensions_str</span><span class="si">}</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="s2">For each output below, provide a score from 0 to 10 for each dimension, where 0 is worst and 10 is best.</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="s2">OUTPUTS TO EVALUATE:</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a><span class="si">{</span><span class="n">formatted_outputs_for_prompt</span><span class="si">}</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="s2">Provide your evaluation clearly for each phase, like this example:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a><span class="s2">## Evaluation for Phase: [phase_name_1]</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a><span class="s2">- </span><span class="si">{</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: [score]/10</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a><span class="s2">- </span><span class="si">{</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">: [score]/10</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="s2">...</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="s2">## Evaluation for Phase: [phase_name_2]</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="s2">- </span><span class="si">{</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: [score]/10</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="s2">...</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="s2">(End your response after evaluating all phases)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="c1"># Try formatting using ConfigManager, fallback to default if template missing/fails</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>             <span class="c1"># *** FIX: Use context parameter to get query ***</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>             <span class="n">query_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span> <span class="c1"># Default if query missing in context</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>             <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                 <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query_context</span><span class="p">,</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                 <span class="s2">&quot;outputs_section&quot;</span><span class="p">:</span> <span class="n">formatted_outputs_for_prompt</span><span class="p">,</span> <span class="c1"># Keep the variable name simple</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                 <span class="s2">&quot;dimensions_list&quot;</span><span class="p">:</span> <span class="n">dimensions_str</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="p">}</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>             <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">evaluation_template_name</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">)</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="k">except</span> <span class="n">ConfigurationError</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation template &#39;</span><span class="si">{</span><span class="n">evaluation_template_name</span><span class="si">}</span><span class="s2">&#39; not found, using default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>             <span class="c1"># *** FIX: Use context parameter to get query for default template ***</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>             <span class="n">query_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>             <span class="c1"># Format the default template string directly</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>             <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="n">default_eval_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catch missing keys or other format errors</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error formatting template &#39;</span><span class="si">{</span><span class="n">evaluation_template_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using default.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>             <span class="c1"># *** FIX: Use context parameter to get query for default template ***</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>             <span class="n">query_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>             <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="n">default_eval_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error formatting evaluation prompt: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>             <span class="c1"># *** FIX: Use context parameter to get query for default template ***</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>             <span class="n">query_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>             <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="n">default_eval_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query_context</span><span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="c1"># Run evaluator model</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending evaluation prompt to model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="c1"># Use model manager&#39;s run_inference</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="n">evaluation_result_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                <span class="n">model_id</span><span class="o">=</span><span class="n">evaluator_model_id</span><span class="p">,</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">evaluation_prompt</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                <span class="c1"># Add params suitable for evaluation (e.g., lower temp)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_temperature&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="c1"># More deterministic eval</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                <span class="n">max_tokens</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_max_tokens&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span> <span class="c1"># Allow enough space</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received evaluation result from model.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="c1"># Add trace for the evaluation model call</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="n">evaluator_model_id</span><span class="p">,</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">evaluation_prompt</span><span class="p">,</span> <span class="c1"># Can be large</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">evaluation_result_raw</span><span class="p">,</span> <span class="c1"># Store raw eval output</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">evaluation_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;dimension_evaluator&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluated_dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions</span><span class="p">}</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                <span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>            <span class="n">evaluation_text</span> <span class="o">=</span> <span class="n">evaluation_result_raw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">evaluation_text</span><span class="p">:</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39; returned empty text.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                 <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="c1"># --- Parse scores from the evaluation text ---</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="n">parsed_dimension_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="c1"># Iterate through the phases we expected to evaluate</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">valid_outputs_to_eval</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                <span class="n">phase_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="c1"># Look for the section corresponding to this phase&#39;s evaluation</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                <span class="c1"># Make regex more robust: allows for variations in header, non-greedy match</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="n">phase_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;^\s*(?:#+)?\s*(?:Evaluation for Phase|Output from Phase|Phase):\s*</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span><span class="si">}</span><span class="s2">\s*$(.*?)(?:^\s*(?:#+)?\s*(?:Evaluation for Phase|Output from Phase|Phase):|\Z)&quot;</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>                <span class="n">phase_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">phase_pattern</span><span class="p">,</span> <span class="n">evaluation_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>                <span class="k">if</span> <span class="n">phase_match</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                    <span class="n">phase_section_text</span> <span class="o">=</span> <span class="n">phase_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found evaluation section for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>                    <span class="c1"># Extract scores for each dimension within this section</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                         <span class="c1"># Regex: dimension name, optional colon/hyphen, space, score / 10</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                         <span class="n">score_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;^\s*[\*\-]?\s*</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s1">\s*[:\-]?\s*(\d+(?:\.\d+)?)\s*/\s*10&#39;</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                         <span class="n">score_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern</span><span class="p">,</span> <span class="n">phase_section_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                         <span class="k">if</span> <span class="ow">not</span> <span class="n">score_match</span><span class="p">:</span> <span class="c1"># Try alt pattern without /10</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                             <span class="n">score_pattern_alt</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;^\s*[\*\-]?\s*</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s1">\s*[:\-]?\s*(\d+(?:\.\d+)?)(?![\d\.]|\s*/)&#39;</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                             <span class="n">score_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern_alt</span><span class="p">,</span> <span class="n">phase_section_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                         <span class="k">if</span> <span class="n">score_match</span><span class="p">:</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>                             <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                                  <span class="n">score_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                                   <span class="c1"># Normalize if likely out of 10</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>                                  <span class="k">if</span> <span class="n">score_val</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="s1">&#39;/10&#39;</span> <span class="ow">in</span> <span class="n">score_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                                       <span class="n">score_val</span> <span class="o">/=</span> <span class="mf">10.0</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>                                  <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">score_val</span><span class="p">))</span> <span class="c1"># Clamp score [0, 1]</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>                                  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed score for &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>                             <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse score &#39;</span><span class="si">{</span><span class="n">score_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; for dim &#39;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&#39; in phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                         <span class="c1"># else:</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>                         <span class="c1">#     logger.debug(f&quot;Score pattern not found for dim &#39;{dim}&#39; in phase &#39;{phase_name}&#39; section.&quot;)</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>                <span class="c1"># else:</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>                <span class="c1">#     logger.debug(f&quot;Evaluation section pattern not found for phase &#39;{phase_name}&#39;.&quot;)</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>                <span class="c1"># Add scores found for this phase to the result if any were parsed</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>                <span class="k">if</span> <span class="n">phase_scores</span><span class="p">:</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>                    <span class="n">parsed_dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_scores</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed_dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse any scores from the evaluation model&#39;s output.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="k">return</span> <span class="n">parsed_dimension_scores</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="k">except</span> <span class="n">ModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>             <span class="c1"># Specific error from the model run</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39; failed during inference: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>             <span class="k">raise</span> <span class="c1"># Re-raise ModelError to be caught by the main aggregate method</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>            <span class="c1"># Unexpected errors during the evaluation process</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during phase evaluation process: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="c1"># Raise as AggregationError to indicate evaluation step failed</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during evaluation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.MultidimensionalVoting.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the MultidimensionalVoting aggregator.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\multidimensional_voting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Required for evaluation</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the MultidimensionalVoting aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.MultidimensionalVoting.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate outputs by evaluating multiple dimensions and voting.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>outputs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping phase names to their outputs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from collaboration phases (includes 'query').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
response: The aggregated output (from the best phase) as a string.
confidence: The weighted score of the best phase as confidence.
best_phase: The name of the phase selected as best.
dimension_scores: Scores for each phase across dimensions (0.0-1.0).
weighted_scores: Final weighted score for each phase (0.0-1.0).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.AggregationError">AggregationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If aggregation fails (e.g., no outputs, evaluation fails).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\multidimensional_voting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="c1"># Context received here</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate outputs by evaluating multiple dimensions and voting.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        outputs: Dictionary mapping phase names to their outputs.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        context: Context information from collaboration phases (includes &#39;query&#39;).</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            response: The aggregated output (from the best phase) as a string.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            confidence: The weighted score of the best phase as confidence.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            best_phase: The name of the phase selected as best.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            dimension_scores: Scores for each phase across dimensions (0.0-1.0).</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            weighted_scores: Final weighted score for each phase (0.0-1.0).</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        AggregationError: If aggregation fails (e.g., no outputs, evaluation fails).</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Multidimensional Voting aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>         <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Multidimensional Voting aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="c1"># Get dimensions from strategy configuration</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="c1"># Default dimensions if not specified or invalid</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">default_dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">]</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid or empty &#39;dimensions&#39; in config, using defaults: </span><span class="si">{</span><span class="n">default_dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="n">dimensions</span> <span class="o">=</span> <span class="n">default_dims</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="c1"># Get dimension weights from strategy configuration</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">dimension_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimension_weights&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimension_weights</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;dimension_weights&#39; in config (must be dict), using equal weights.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>             <span class="n">dimension_weights</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="c1"># Ensure all specified dimensions have a weight, defaulting to equal if needed</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">normalized_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">dimensions_with_weight</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">total_weight_specified</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">dimension_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Use -1 to detect unspecified</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">weight</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                 <span class="n">normalized_weights</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                 <span class="n">dimensions_with_weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                 <span class="n">total_weight_specified</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="c1"># Else: Skip dimensions with invalid or negative weights defined</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="c1"># If no valid weights specified or sum is zero, use equal weights for *all* original dimensions</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">dimensions_with_weight</span> <span class="ow">or</span> <span class="n">total_weight_specified</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using default equal weights for all dimensions.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">equal_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span> <span class="k">if</span> <span class="n">dimensions</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="n">equal_weight</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">dimensions_with_weight</span> <span class="o">=</span> <span class="n">dimensions</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">total_weight_after_default</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="c1"># Should be close to 1.0</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default equal weights applied: </span><span class="si">{</span><span class="n">normalized_weights</span><span class="si">}</span><span class="s2"> (Sum: </span><span class="si">{</span><span class="n">total_weight_after_default</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="c1"># If weights were specified and sum &gt; 0, normalize them if they don&#39;t sum to 1</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">total_weight_specified</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalizing specified dimension weights from sum </span><span class="si">{</span><span class="n">total_weight_specified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>             <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="n">w</span> <span class="o">/</span> <span class="n">total_weight_specified</span> <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">normalized_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>             <span class="n">total_weight_after_normalize</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalized weights: </span><span class="si">{</span><span class="n">normalized_weights</span><span class="si">}</span><span class="s2"> (Sum: </span><span class="si">{</span><span class="n">total_weight_after_normalize</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="c1"># --- Get scores for each phase and dimension ---</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">dimension_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># { phase_name: { dimension: score } }</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="c1"># 1. Look for pre-evaluated scores within phase outputs</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; output as it&#39;s not a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                  <span class="k">continue</span> <span class="c1"># Skip non-dict outputs</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>             <span class="n">phase_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>             <span class="c1"># Check common locations for scores (evaluations dict, specific keys, text parsing)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>             <span class="c1"># Prioritize &#39;evaluations&#39; dict if present</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>             <span class="n">evals_dict</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evals_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                  <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span> <span class="c1"># Only look for relevant dimensions</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                       <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">evals_dict</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evals_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                            <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">evals_dict</span><span class="p">[</span><span class="n">dim</span><span class="p">])))</span> <span class="c1"># Normalize/clamp 0-1</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>             <span class="c1"># Look for direct keys like &#39;accuracy_score&#39; if not found above</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>             <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                  <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_scores</span><span class="p">:</span> <span class="c1"># Only if not already found in &#39;evaluations&#39;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                       <span class="n">dim_key_score</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_score&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                       <span class="n">dim_key_rating</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_rating&quot;</span> <span class="c1"># Another common pattern</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                       <span class="n">score_val</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                       <span class="k">if</span> <span class="n">dim_key_score</span> <span class="ow">in</span> <span class="n">phase_output_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_score</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                            <span class="n">score_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_score</span><span class="p">]</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                       <span class="k">elif</span> <span class="n">dim_key_rating</span> <span class="ow">in</span> <span class="n">phase_output_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_rating</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                            <span class="n">score_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="n">dim_key_rating</span><span class="p">]</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                       <span class="k">if</span> <span class="n">score_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                            <span class="c1"># Assume scores/ratings are 0-1 or 0-10, 1-10 etc. Normalize best guess.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                            <span class="k">if</span> <span class="n">score_val</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">score_val</span> <span class="o">=</span> <span class="n">score_val</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c1"># Assume out of 10</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                            <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">score_val</span><span class="p">)))</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>             <span class="c1"># Attempt regex extraction from output text if scores still missing for some dims</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>             <span class="n">output_text_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>             <span class="k">if</span> <span class="n">output_text_content</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                  <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                       <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_scores</span><span class="p">:</span> <span class="c1"># Only parse if score not found yet</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                            <span class="c1"># Regex looks for &quot;dimension: score/10&quot; patterns, more robustly</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                            <span class="n">score_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s1">\s*[:\-]?\s*score\s*[:\-]?\s*(\d+(?:\.\d+)?)\s*/\s*10&#39;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern</span><span class="p">,</span> <span class="n">output_text_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span> <span class="c1"># Try alternate pattern like &quot;dimension: 8&quot; (assume out of 10)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                                 <span class="n">score_pattern_alt</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="si">}</span><span class="s1">\s*[:\-]?\s*(\d+(?:\.\d+)?)(?!\s*/)&#39;</span> <span class="c1"># Number not followed by /</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                                 <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern_alt</span><span class="p">,</span> <span class="n">output_text_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                                     <span class="n">score_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                                     <span class="c1"># Normalize if it seems to be out of 10</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                                     <span class="k">if</span> <span class="n">score_val</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="s1">&#39;/10&#39;</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                                          <span class="n">score_val</span> <span class="o">=</span> <span class="n">score_val</span> <span class="o">/</span> <span class="mf">10.0</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                                     <span class="n">phase_scores</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">score_val</span><span class="p">))</span> <span class="c1"># Normalize 0-1</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse score for dim &#39;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&#39; in phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; output via regex.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>             <span class="c1"># Store scores found for this phase if any relevant ones were found</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>             <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">phase_scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                  <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_scores</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial dimension scores extracted: </span><span class="si">{</span><span class="n">dimension_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="c1"># 2. If scores incomplete or missing, use evaluator model if configured</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">evaluator_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluator_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">evaluator_model_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluator_model&quot;</span><span class="p">,</span> <span class="n">evaluator_model_id</span><span class="p">)</span> <span class="c1"># Allow context override</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="c1"># Determine if evaluation is needed</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">phases_needing_scores</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">phases_with_incomplete_scores</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>             <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="p">}</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">needs_evaluation</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">phases_needing_scores</span> <span class="ow">or</span> <span class="n">phases_with_incomplete_scores</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">if</span> <span class="n">needs_evaluation</span> <span class="ow">and</span> <span class="n">evaluator_model_id</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Evaluator model specified, but ModelManager not available to aggregator. Cannot perform model-based evaluation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>             <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing dimension evaluation using model: </span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                  <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                       <span class="c1"># *** FIX: Pass context to _evaluate_phases ***</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                       <span class="c1"># Pass only the dimensions that have weights assigned</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                       <span class="n">evaluated_scores</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_phases</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                           <span class="n">outputs</span><span class="p">,</span> <span class="n">dimensions_with_weight</span><span class="p">,</span> <span class="n">evaluator_model_id</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                       <span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                       <span class="c1"># Merge evaluated scores, filling gaps. Evaluated scores take precedence? Let&#39;s say yes.</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                       <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">evaluated_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                           <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                                <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                           <span class="c1"># Update existing dict, overwriting with newly evaluated scores</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                           <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                           <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated/Added evaluated scores for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                  <span class="k">except</span> <span class="n">ModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluation model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Continuing without its evaluation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                        <span class="c1"># Continue without evaluated scores if evaluation fails</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during phase evaluation using model &#39;</span><span class="si">{</span><span class="n">evaluator_model_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                       <span class="c1"># Continue without evaluated scores</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="c1"># 3. Fallback: Use confidence scores if dimension scores are STILL missing/incomplete</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">phases_still_needing_scores</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">phases_still_incomplete</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>             <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="p">}</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="k">if</span> <span class="n">phases_still_needing_scores</span> <span class="ow">or</span> <span class="n">phases_still_incomplete</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dimension scores still incomplete after potential evaluation, using phase confidence scores as fallback.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>             <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                  <span class="c1"># Check if scores are needed for this phase</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                  <span class="n">needs_score_fill</span> <span class="o">=</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases_still_needing_scores</span> <span class="ow">or</span> \
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                                     <span class="p">(</span><span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases_still_incomplete</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phase_name</span><span class="p">),</span> <span class="nb">dict</span><span class="p">))</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                  <span class="k">if</span> <span class="n">needs_score_fill</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                       <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">phase_output_data</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                            <span class="n">conf_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                                 <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)))</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                                 <span class="n">combined_conf</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                                     <span class="n">confidence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_conf</span><span class="p">)))</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                       <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                            <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                                 <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                            <span class="c1"># Fill in missing scores for dimensions_with_weight using confidence</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                                 <span class="k">if</span> <span class="n">dim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                                      <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using confidence </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> to fill missing dimension scores for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="c1"># 4. Final Fallback: Assign default scores (e.g., 0.5) if still no scores for some phases</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">phases_finally_needing_scores</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimension_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">phases_finally_incomplete</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>             <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="n">scores</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="p">}</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">if</span> <span class="n">phases_finally_needing_scores</span> <span class="ow">or</span> <span class="n">phases_finally_incomplete</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>             <span class="n">default_fallback_score</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Use a neutral default</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No scores or confidence available for some phases/dimensions, assigning default score (</span><span class="si">{</span><span class="n">default_fallback_score</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>             <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                  <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                      <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="n">default_fallback_score</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">}</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                  <span class="k">elif</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases_finally_incomplete</span><span class="p">:</span> <span class="c1"># Already has a dict, fill missing</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                       <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions_with_weight</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                            <span class="n">dimension_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">default_fallback_score</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="c1"># --- Calculate weighted scores for each phase ---</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">weighted_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">dimension_scores</span><span class="p">:</span> <span class="c1"># Check if somehow still empty</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Could not determine dimension scores for any phase.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">dimension_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>             <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span> <span class="k">continue</span> <span class="c1"># Skip if phase wasn&#39;t in original outputs</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>             <span class="n">current_weighted_score</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>             <span class="n">current_total_weight</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Track weight used *for this phase*</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>             <span class="c1"># Calculate weighted sum using the normalized weights</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>             <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                 <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">normalized_weights</span><span class="p">:</span> <span class="c1"># Use only dimensions with defined, normalized weights</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                      <span class="n">weight</span> <span class="o">=</span> <span class="n">normalized_weights</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                      <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Skip dimensions with zero or negative weight</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                           <span class="n">current_weighted_score</span> <span class="o">+=</span> <span class="n">score</span> <span class="o">*</span> <span class="n">weight</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                           <span class="n">current_total_weight</span> <span class="o">+=</span> <span class="n">weight</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                      <span class="c1"># Else: Ignore dimensions without weight or with zero weight</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>             <span class="c1"># Normalize score by total weight actually used for this phase&#39;s scoring</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>             <span class="c1"># This handles cases where some dimensions might be missing scores or weights</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>             <span class="k">if</span> <span class="n">current_total_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                   <span class="n">weighted_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_weighted_score</span> <span class="o">/</span> <span class="n">current_total_weight</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>             <span class="k">elif</span> <span class="n">scores</span><span class="p">:</span> <span class="c1"># If weights were zero/missing but scores existed, use simple average of available scores</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                   <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total applicable weight for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; was zero, using average score.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                   <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                   <span class="n">weighted_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">valid_scores</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">valid_scores</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>             <span class="k">else</span><span class="p">:</span> <span class="c1"># No scores and no applicable weights</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No scores or applicable weights for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, assigning default weighted score 0.5.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                  <span class="n">weighted_scores</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated final weighted scores: </span><span class="si">{</span><span class="n">weighted_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="c1"># --- Select the best phase ---</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">weighted_scores</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phases remaining after scoring for aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="c1"># Select the phase with the highest weighted score</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="c1"># Use max(), handling potential ties by taking the first one found (dict order dependent in &lt;3.7)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="c1"># For more robust tie-breaking, could use confidence or other factors.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">best_phase_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weighted_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">weighted_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="n">best_score</span> <span class="o">=</span> <span class="n">weighted_scores</span><span class="p">[</span><span class="n">best_phase_name</span><span class="p">]</span> <span class="c1"># This is the final normalized weighted score</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="c1"># Extract the output content from the best phase</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">best_output_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">best_phase_name</span><span class="p">])</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="sa">f</span><span class="s2">&quot;Multidimensional Voting aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="sa">f</span><span class="s2">&quot;Best phase: &#39;</span><span class="si">{</span><span class="n">best_phase_name</span><span class="si">}</span><span class="s2">&#39; (Weighted Score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;dimensions_used&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">}</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">best_output_content</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span> <span class="c1"># Use the final weighted score as confidence</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="s2">&quot;best_phase&quot;</span><span class="p">:</span> <span class="n">best_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>             <span class="c1"># Include detailed scores for dimensions that had weights</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="s2">&quot;dimension_scores&quot;</span><span class="p">:</span> <span class="n">dimension_scores</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="s2">&quot;weighted_scores&quot;</span><span class="p">:</span> <span class="n">weighted_scores</span> <span class="c1"># Include final weighted scores per phase</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="p">}</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                    <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                    <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                    <span class="s2">&quot;configured_dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions</span><span class="p">,</span> <span class="c1"># Original list from config</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                    <span class="s2">&quot;configured_weights&quot;</span><span class="p">:</span> <span class="n">dimension_weights</span><span class="p">,</span> <span class="c1"># Original weights from config</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="p">},</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters influencing the outcome</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                    <span class="s2">&quot;effective_dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions_with_weight</span><span class="p">,</span> <span class="c1"># Dimensions actually used</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                    <span class="s2">&quot;normalized_weights&quot;</span><span class="p">:</span> <span class="n">normalized_weights</span><span class="p">,</span> <span class="c1"># Weights used in calculation</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                    <span class="s2">&quot;evaluator_model&quot;</span><span class="p">:</span> <span class="n">evaluator_model_id</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                <span class="p">}</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multidimensional voting aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>         <span class="k">raise</span> <span class="c1"># Re-raise known aggregation errors</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Multidimensional Voting aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="c1"># Wrap unexpected errors in AggregationError</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multidimensional Voting aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.SequentialRefinement" class="doc doc-heading">
            <code>SequentialRefinement</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAggregator (ai_ensemble_suite.aggregation.base.BaseAggregator)" href="#ai_ensemble_suite.aggregation.BaseAggregator">BaseAggregator</a></code></p>


        <p>Sequential Refinement aggregation strategy.</p>
<p>Assumes phases run in a sequence where later phases refine earlier ones.
This strategy simply selects the output of the designated 'final' phase.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\sequential_refinement.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">SequentialRefinement</span><span class="p">(</span><span class="n">BaseAggregator</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequential Refinement aggregation strategy.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Assumes phases run in a sequence where later phases refine earlier ones.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    This strategy simply selects the output of the designated &#39;final&#39; phase.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="c1"># Override __init__ for consistency, though model_manager isn&#39;t used here</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the SequentialRefinement aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1"># No specific init needed</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate by selecting the output from the designated final phase.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            context: Context information (used to infer final phase if not configured).</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">                response: The text output from the final phase.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">                confidence: The confidence score associated with the final phase output.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">                final_phase: The name of the phase selected as final.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            AggregationError: If no final phase can be determined or its output is missing.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Sequential Refinement aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Sequential Refinement aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">final_phase_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="c1"># --- Determine the Final Phase ---</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="c1"># 1. Check strategy configuration for &#39;final_phase&#39;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">configured_final_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_phase</span><span class="p">()</span> <span class="c1"># Method uses self._config</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">if</span> <span class="n">configured_final_phase</span> <span class="ow">and</span> <span class="n">configured_final_phase</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using configured final_phase: &#39;</span><span class="si">{</span><span class="n">configured_final_phase</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">configured_final_phase</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="c1"># 2. Infer from &#39;sequence&#39; key in strategy config if final_phase not set/found</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sequence</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                    <span class="n">potential_final</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="k">if</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred final phase from config sequence: &#39;</span><span class="si">{</span><span class="n">potential_final</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                        <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">potential_final</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="c1"># 3. Infer from &#39;phase_sequence&#39; in the main context if still not found</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="n">context_sequence</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sequence</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context_sequence</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                    <span class="n">potential_final</span> <span class="o">=</span> <span class="n">context_sequence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                    <span class="k">if</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred final phase from context sequence: &#39;</span><span class="si">{</span><span class="n">potential_final</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                        <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">potential_final</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="c1"># 4. Fallback: Look for phases named like &#39;refinement&#39;, &#39;integration&#39;, &#39;final&#39; etc.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                 <span class="n">candidate_suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span> <span class="s2">&quot;integration&quot;</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;committee&quot;</span><span class="p">]</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                 <span class="c1"># Check in reverse order of phase execution if possible</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                 <span class="n">phases_to_check</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                 <span class="k">for</span> <span class="n">phase_name_to_check</span> <span class="ow">in</span> <span class="n">phases_to_check</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                      <span class="k">if</span> <span class="n">phase_name_to_check</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                           <span class="n">lower_name</span> <span class="o">=</span> <span class="n">phase_name_to_check</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                           <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">lower_name</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">candidate_suffixes</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using phase &#39;</span><span class="si">{</span><span class="n">phase_name_to_check</span><span class="si">}</span><span class="s2">&#39; as likely final phase based on name.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                                <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">phase_name_to_check</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                                <span class="k">break</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="c1"># 5. Last Resort: If still no final phase determined, use the last available output based on context sequence or dict order</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">phases_in_order</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="c1"># Find the last phase in the order that actually exists in outputs</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="k">for</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">phases_in_order</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                     <span class="k">if</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine specific final phase, using last available phase: &#39;</span><span class="si">{</span><span class="n">potential_final</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                          <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">potential_final</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                          <span class="k">break</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="c1"># If even that fails (e.g., sequence empty and outputs empty, though caught earlier)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                     <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Cannot determine final phase: No outputs available or sequence context missing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="c1"># --- Extract Output and Confidence from Final Phase ---</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected final phase for aggregation: &#39;</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">final_output_data</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">final_phase_name</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="k">if</span> <span class="n">final_output_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="c1"># Should not happen if logic above is correct, but safety check</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected final phase &#39;</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">&#39; not found in outputs dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="c1"># Extract the response text using the utility method</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="n">final_response_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">final_output_data</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="c1"># Note: _extract_output returns &quot;&quot; if extraction fails</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="c1"># Get confidence score from the final phase&#39;s output data</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Default if not found</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">final_output_data</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="n">conf_val</span> <span class="o">=</span> <span class="n">final_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                    <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">conf_val</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                    <span class="c1"># Prioritize &#39;combined&#39; score</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                    <span class="n">combined_score</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_score</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="c1"># Ensure confidence is valid [0, 1] range</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="c1"># If confidence is still very low/zero, maybe use the average from all phases?</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span> <span class="c1"># Threshold check</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                 <span class="n">average_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_confidence</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                 <span class="k">if</span> <span class="n">average_confidence</span> <span class="o">&gt;</span> <span class="n">confidence</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final phase confidence (</span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) is low, using average confidence (</span><span class="si">{</span><span class="n">average_confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) instead.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                      <span class="n">confidence</span> <span class="o">=</span> <span class="n">average_confidence</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="sa">f</span><span class="s2">&quot;Sequential Refinement aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="sa">f</span><span class="s2">&quot;Using output from phase: &#39;</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                 <span class="n">extra</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;final_confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span> <span class="p">}</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">final_response_text</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="s2">&quot;final_phase&quot;</span><span class="p">:</span> <span class="n">final_phase_name</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="p">}</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                        <span class="s2">&quot;determined_final_phase&quot;</span><span class="p">:</span> <span class="n">final_phase_name</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                    <span class="p">},</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span> <span class="c1"># Response, confidence, final_phase name</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_phase_configured&quot;</span><span class="p">:</span> <span class="n">configured_final_phase</span><span class="p">}</span> <span class="c1"># Specific params</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequential refinement aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>             <span class="k">raise</span> <span class="c1"># Re-raise known errors</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Sequential Refinement aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequential Refinement aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.SequentialRefinement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the SequentialRefinement aggregator.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\sequential_refinement.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the SequentialRefinement aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.SequentialRefinement.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate by selecting the output from the designated final phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>outputs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping phase names to their output data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information (used to infer final phase if not configured).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
response: The text output from the final phase.
confidence: The confidence score associated with the final phase output.
final_phase: The name of the phase selected as final.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.AggregationError">AggregationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no final phase can be determined or its output is missing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\sequential_refinement.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate by selecting the output from the designated final phase.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        context: Context information (used to infer final phase if not configured).</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            response: The text output from the final phase.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            confidence: The confidence score associated with the final phase output.</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            final_phase: The name of the phase selected as final.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        AggregationError: If no final phase can be determined or its output is missing.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Sequential Refinement aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>         <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Sequential Refinement aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">final_phase_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># --- Determine the Final Phase ---</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># 1. Check strategy configuration for &#39;final_phase&#39;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">configured_final_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_phase</span><span class="p">()</span> <span class="c1"># Method uses self._config</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">if</span> <span class="n">configured_final_phase</span> <span class="ow">and</span> <span class="n">configured_final_phase</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using configured final_phase: &#39;</span><span class="si">{</span><span class="n">configured_final_phase</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">configured_final_phase</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="c1"># 2. Infer from &#39;sequence&#39; key in strategy config if final_phase not set/found</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sequence</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="n">potential_final</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="k">if</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred final phase from config sequence: &#39;</span><span class="si">{</span><span class="n">potential_final</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                    <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">potential_final</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="c1"># 3. Infer from &#39;phase_sequence&#39; in the main context if still not found</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">context_sequence</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sequence</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context_sequence</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="n">potential_final</span> <span class="o">=</span> <span class="n">context_sequence</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="k">if</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inferred final phase from context sequence: &#39;</span><span class="si">{</span><span class="n">potential_final</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                    <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">potential_final</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="c1"># 4. Fallback: Look for phases named like &#39;refinement&#39;, &#39;integration&#39;, &#39;final&#39; etc.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>             <span class="n">candidate_suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span> <span class="s2">&quot;integration&quot;</span><span class="p">,</span> <span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;committee&quot;</span><span class="p">]</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>             <span class="c1"># Check in reverse order of phase execution if possible</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>             <span class="n">phases_to_check</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>             <span class="k">for</span> <span class="n">phase_name_to_check</span> <span class="ow">in</span> <span class="n">phases_to_check</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                  <span class="k">if</span> <span class="n">phase_name_to_check</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                       <span class="n">lower_name</span> <span class="o">=</span> <span class="n">phase_name_to_check</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                       <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">lower_name</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">candidate_suffixes</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using phase &#39;</span><span class="si">{</span><span class="n">phase_name_to_check</span><span class="si">}</span><span class="s2">&#39; as likely final phase based on name.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                            <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">phase_name_to_check</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                            <span class="k">break</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="c1"># 5. Last Resort: If still no final phase determined, use the last available output based on context sequence or dict order</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">phases_in_order</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phase_sequence&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="c1"># Find the last phase in the order that actually exists in outputs</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="k">for</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">phases_in_order</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                 <span class="k">if</span> <span class="n">potential_final</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine specific final phase, using last available phase: &#39;</span><span class="si">{</span><span class="n">potential_final</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                      <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">potential_final</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                      <span class="k">break</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="c1"># If even that fails (e.g., sequence empty and outputs empty, though caught earlier)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_phase_name</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Cannot determine final phase: No outputs available or sequence context missing.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="c1"># --- Extract Output and Confidence from Final Phase ---</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected final phase for aggregation: &#39;</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">final_output_data</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">final_phase_name</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">if</span> <span class="n">final_output_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Should not happen if logic above is correct, but safety check</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected final phase &#39;</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">&#39; not found in outputs dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="c1"># Extract the response text using the utility method</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">final_response_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">final_output_data</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="c1"># Note: _extract_output returns &quot;&quot; if extraction fails</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="c1"># Get confidence score from the final phase&#39;s output data</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Default if not found</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">final_output_data</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">conf_val</span> <span class="o">=</span> <span class="n">final_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">conf_val</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="c1"># Prioritize &#39;combined&#39; score</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">combined_score</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">combined_score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                    <span class="n">confidence</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_score</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="c1"># Ensure confidence is valid [0, 1] range</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="c1"># If confidence is still very low/zero, maybe use the average from all phases?</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="k">if</span> <span class="n">confidence</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span> <span class="c1"># Threshold check</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>             <span class="n">average_confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_confidence</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>             <span class="k">if</span> <span class="n">average_confidence</span> <span class="o">&gt;</span> <span class="n">confidence</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final phase confidence (</span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) is low, using average confidence (</span><span class="si">{</span><span class="n">average_confidence</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) instead.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                  <span class="n">confidence</span> <span class="o">=</span> <span class="n">average_confidence</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="sa">f</span><span class="s2">&quot;Sequential Refinement aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="sa">f</span><span class="s2">&quot;Using output from phase: &#39;</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>             <span class="n">extra</span><span class="o">=</span><span class="p">{</span> <span class="s2">&quot;final_confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span> <span class="p">}</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">final_response_text</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="s2">&quot;final_phase&quot;</span><span class="p">:</span> <span class="n">final_phase_name</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="p">}</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                    <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                    <span class="s2">&quot;determined_final_phase&quot;</span><span class="p">:</span> <span class="n">final_phase_name</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="p">},</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span> <span class="c1"># Response, confidence, final_phase name</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_phase_configured&quot;</span><span class="p">:</span> <span class="n">configured_final_phase</span><span class="p">}</span> <span class="c1"># Specific params</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequential refinement aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>         <span class="k">raise</span> <span class="c1"># Re-raise known errors</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Sequential Refinement aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequential Refinement aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.aggregation.WeightedVoting" class="doc doc-heading">
            <code>WeightedVoting</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseAggregator (ai_ensemble_suite.aggregation.base.BaseAggregator)" href="#ai_ensemble_suite.aggregation.BaseAggregator">BaseAggregator</a></code></p>


        <p>Weighted Voting aggregation strategy.</p>
<p>Aggregates by assigning weights to different phase outputs (based on config)
and selecting the output text that receives the highest total weight.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\aggregation\weighted_voting.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">WeightedVoting</span><span class="p">(</span><span class="n">BaseAggregator</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Weighted Voting aggregation strategy.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Aggregates by assigning weights to different phase outputs (based on config)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    and selecting the output text that receives the highest total weight.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>     <span class="c1"># Override __init__ for consistency</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the WeightedVoting aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="c1"># No specific init needed</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate phase outputs using weighted voting based on configuration.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">            context: Context information from collaboration phases.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">                response: The output text that received the highest total weight.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">                confidence: Confidence score, potentially combining weights and source confidence.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">                weights: Dictionary mapping output texts to their normalized weights.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">                source_phase: Name(s) of the phase(s) that produced the winning output.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            AggregationError: If no valid outputs or weights are available.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Weighted Voting aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Weighted Voting aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="c1"># Get weights from strategy configuration: { &quot;phase_name&quot;: weight }</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">phase_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weights&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_weights</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;weights&#39; config (must be dict), using default weights.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                 <span class="n">phase_weights</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">default_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_weight</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid &#39;default_weight&#39; </span><span class="si">{</span><span class="n">default_weight</span><span class="si">}</span><span class="s2">, using 1.0.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                 <span class="n">default_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="c1"># --- Tally weighted votes for each unique output text ---</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">output_votes</span><span class="p">:</span> <span class="n">Counter</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span> <span class="c1"># Use Counter for summing weights per text</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">valid_phases_processed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                 <span class="c1"># Get the configured weight for this phase, or use default</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                 <span class="n">weight</span> <span class="o">=</span> <span class="n">phase_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">default_weight</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                 <span class="c1"># Skip phases with non-positive weight</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                 <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; due to weight &lt;= 0.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                      <span class="k">continue</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                 <span class="c1"># Extract the output text content</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                 <span class="n">output_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                 <span class="c1"># Skip phases where text extraction failed or resulted in empty string</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                 <span class="k">if</span> <span class="ow">not</span> <span class="n">output_text</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                      <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract valid text from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, skipping vote.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                      <span class="k">continue</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                 <span class="c1"># Add the weight to the vote count for this specific output text</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                 <span class="n">output_votes</span><span class="p">[</span><span class="n">output_text</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                 <span class="n">valid_phases_processed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; voted for output (hash:</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">output_text</span><span class="p">)</span><span class="o">%</span><span class="mi">1000</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">) with weight </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># Check if any valid votes were cast</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">output_votes</span> <span class="ow">or</span> <span class="n">valid_phases_processed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="c1"># If no weights were configured AND a final phase exists, use fallback logic?</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="c1"># This duplicates logic from base/other strategies, maybe avoid here.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="c1"># Let&#39;s just error if no votes.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No valid outputs or positive weights found for aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Weighted voting failed: No valid weighted outputs available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="c1"># --- Determine the winning output ---</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># Find the output text with the highest total weight</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="c1"># most_common(1) returns list of tuples: [ (text, total_weight) ]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">winner_list</span> <span class="o">=</span> <span class="n">output_votes</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">winner_list</span><span class="p">:</span> <span class="c1"># Should not happen if output_votes is not empty</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                 <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Internal error: Could not determine winner from votes.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">best_output_text</span><span class="p">,</span> <span class="n">highest_total_weight</span> <span class="o">=</span> <span class="n">winner_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="c1"># --- Calculate Normalized Weights and Confidence ---</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Calculate the sum of all weights cast</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">total_weight_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output_votes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="c1"># Normalize the weights for each unique output (for reporting/tracing)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="k">if</span> <span class="n">total_weight_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                 <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="p">:</span> <span class="n">votes</span> <span class="o">/</span> <span class="n">total_weight_sum</span> <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">votes</span> <span class="ow">in</span> <span class="n">output_votes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                 <span class="c1"># The weight of the winning output corresponds to its normalized score</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                 <span class="n">best_output_normalized_weight</span> <span class="o">=</span> <span class="n">normalized_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">best_output_text</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># Should not happen if weights &gt; 0</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Total weight sum is zero, cannot normalize.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                 <span class="n">best_output_normalized_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_votes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="c1"># Assign 1 if only one option</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="c1"># Calculate confidence: Blend the normalized weight of the winner</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="c1"># with the average confidence of the phases that produced the winning output.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">source_phases_confidences</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">source_phase_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">best_output_text</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                      <span class="n">source_phase_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                      <span class="c1"># Extract confidence from this source phase</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">phase_output_data</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                           <span class="n">conf_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                           <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span> <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                           <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="n">score</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                                <span class="n">source_phases_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">avg_source_confidence</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">source_phases_confidences</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_phases_confidences</span><span class="p">))</span> \
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                                     <span class="k">if</span> <span class="n">source_phases_confidences</span> <span class="k">else</span> <span class="mf">0.7</span> <span class="c1"># Default if no source confidences</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="c1"># Blend: e.g., 60% weight score, 40% source confidence average</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">final_confidence</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">best_output_normalized_weight</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">avg_source_confidence</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">final_confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">final_confidence</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Clamp to [0, 1]</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="sa">f</span><span class="s2">&quot;Weighted Voting aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="sa">f</span><span class="s2">&quot;Winner score: </span><span class="si">{</span><span class="n">best_output_normalized_weight</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="sa">f</span><span class="s2">&quot;(from phases: </span><span class="si">{</span><span class="n">source_phase_names</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                 <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">}</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="c1"># Sort normalized weights for clearer reporting/tracing</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="n">sorted_normalized_weights</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">best_output_text</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                 <span class="c1"># Report normalized weights per unique text output</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">sorted_normalized_weights</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                 <span class="c1"># List phases that produced the winning output</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="s2">&quot;source_phase&quot;</span><span class="p">:</span> <span class="n">source_phase_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_phase_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">source_phase_names</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="p">}</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                        <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                        <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                        <span class="s2">&quot;configured_weights&quot;</span><span class="p">:</span> <span class="n">phase_weights</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                        <span class="s2">&quot;default_weight&quot;</span><span class="p">:</span> <span class="n">default_weight</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="p">},</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span> <span class="c1"># Contains response, conf, normalized weights map, source(s)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters influencing the vote</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                        <span class="s2">&quot;configured_weights&quot;</span><span class="p">:</span> <span class="n">phase_weights</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                        <span class="s2">&quot;default_weight&quot;</span><span class="p">:</span> <span class="n">default_weight</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                         <span class="c1"># Trace the raw votes before normalization for debugging</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                        <span class="s2">&quot;raw_votes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">output_votes</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                    <span class="p">}</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted voting aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>             <span class="k">raise</span> <span class="c1"># Re-raise known errors</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Weighted Voting aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted Voting aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.WeightedVoting.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the WeightedVoting aggregator.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\weighted_voting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ModelManager&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">strategy_config_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the WeightedVoting aggregator.&quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config_manager</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">model_manager</span><span class="p">,</span> <span class="n">strategy_config_override</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.aggregation.WeightedVoting.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate phase outputs using weighted voting based on configuration.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>outputs</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping phase names to their output data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from collaboration phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
response: The output text that received the highest total weight.
confidence: Confidence score, potentially combining weights and source confidence.
weights: Dictionary mapping output texts to their normalized weights.
source_phase: Name(s) of the phase(s) that produced the winning output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.AggregationError">AggregationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no valid outputs or weights are available.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\aggregation\weighted_voting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate phase outputs using weighted voting based on configuration.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        outputs: Dictionary mapping phase names to their output data.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        context: Context information from collaboration phases.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">        trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            response: The output text that received the highest total weight.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            confidence: Confidence score, potentially combining weights and source confidence.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            weights: Dictionary mapping output texts to their normalized weights.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            source_phase: Name(s) of the phase(s) that produced the winning output.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        AggregationError: If no valid outputs or weights are available.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Weighted Voting aggregation for strategy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>         <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;No phase outputs provided for Weighted Voting aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># Get weights from strategy configuration: { &quot;phase_name&quot;: weight }</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">phase_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weights&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_weights</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;weights&#39; config (must be dict), using default weights.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>             <span class="n">phase_weights</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">default_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_weight&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_weight</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid &#39;default_weight&#39; </span><span class="si">{</span><span class="n">default_weight</span><span class="si">}</span><span class="s2">, using 1.0.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>             <span class="n">default_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="c1"># --- Tally weighted votes for each unique output text ---</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">output_votes</span><span class="p">:</span> <span class="n">Counter</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span> <span class="c1"># Use Counter for summing weights per text</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">valid_phases_processed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>             <span class="c1"># Get the configured weight for this phase, or use default</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>             <span class="n">weight</span> <span class="o">=</span> <span class="n">phase_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">default_weight</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>             <span class="c1"># Skip phases with non-positive weight</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>             <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; due to weight &lt;= 0.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                  <span class="k">continue</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>             <span class="c1"># Extract the output text content</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>             <span class="n">output_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>             <span class="c1"># Skip phases where text extraction failed or resulted in empty string</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="n">output_text</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract valid text from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, skipping vote.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                  <span class="k">continue</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>             <span class="c1"># Add the weight to the vote count for this specific output text</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>             <span class="n">output_votes</span><span class="p">[</span><span class="n">output_text</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>             <span class="n">valid_phases_processed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; voted for output (hash:</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">output_text</span><span class="p">)</span><span class="o">%</span><span class="mi">1000</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">) with weight </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="c1"># Check if any valid votes were cast</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_votes</span> <span class="ow">or</span> <span class="n">valid_phases_processed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="c1"># If no weights were configured AND a final phase exists, use fallback logic?</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="c1"># This duplicates logic from base/other strategies, maybe avoid here.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="c1"># Let&#39;s just error if no votes.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No valid outputs or positive weights found for aggregation.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Weighted voting failed: No valid weighted outputs available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="c1"># --- Determine the winning output ---</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="c1"># Find the output text with the highest total weight</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="c1"># most_common(1) returns list of tuples: [ (text, total_weight) ]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">winner_list</span> <span class="o">=</span> <span class="n">output_votes</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">winner_list</span><span class="p">:</span> <span class="c1"># Should not happen if output_votes is not empty</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>             <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="s2">&quot;Internal error: Could not determine winner from votes.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">best_output_text</span><span class="p">,</span> <span class="n">highest_total_weight</span> <span class="o">=</span> <span class="n">winner_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="c1"># --- Calculate Normalized Weights and Confidence ---</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="c1"># Calculate the sum of all weights cast</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">total_weight_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output_votes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="c1"># Normalize the weights for each unique output (for reporting/tracing)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">if</span> <span class="n">total_weight_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>             <span class="n">normalized_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="p">:</span> <span class="n">votes</span> <span class="o">/</span> <span class="n">total_weight_sum</span> <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">votes</span> <span class="ow">in</span> <span class="n">output_votes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>             <span class="c1"># The weight of the winning output corresponds to its normalized score</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>             <span class="n">best_output_normalized_weight</span> <span class="o">=</span> <span class="n">normalized_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">best_output_text</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Should not happen if weights &gt; 0</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Total weight sum is zero, cannot normalize.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>             <span class="n">best_output_normalized_weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_votes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="c1"># Assign 1 if only one option</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="c1"># Calculate confidence: Blend the normalized weight of the winner</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="c1"># with the average confidence of the phases that produced the winning output.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">source_phases_confidences</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">source_phase_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output_data</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_output</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">)</span> <span class="o">==</span> <span class="n">best_output_text</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                  <span class="n">source_phase_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                  <span class="c1"># Extract confidence from this source phase</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">phase_output_data</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                       <span class="n">conf_val</span> <span class="o">=</span> <span class="n">phase_output_data</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                       <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span> <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf_val</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                       <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conf_val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span> <span class="n">score</span> <span class="o">=</span> <span class="n">conf_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                            <span class="n">source_phases_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">))</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">avg_source_confidence</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">source_phases_confidences</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_phases_confidences</span><span class="p">))</span> \
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                                 <span class="k">if</span> <span class="n">source_phases_confidences</span> <span class="k">else</span> <span class="mf">0.7</span> <span class="c1"># Default if no source confidences</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="c1"># Blend: e.g., 60% weight score, 40% source confidence average</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">final_confidence</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">best_output_normalized_weight</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">avg_source_confidence</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">final_confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">final_confidence</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Clamp to [0, 1]</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="sa">f</span><span class="s2">&quot;Weighted Voting aggregation completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="sa">f</span><span class="s2">&quot;Winner score: </span><span class="si">{</span><span class="n">best_output_normalized_weight</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="sa">f</span><span class="s2">&quot;(from phases: </span><span class="si">{</span><span class="n">source_phase_names</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>             <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">}</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="c1"># Prepare final result dictionary</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="c1"># Sort normalized weights for clearer reporting/tracing</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">sorted_normalized_weights</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">normalized_weights</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">aggregation_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">best_output_text</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">final_confidence</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>             <span class="c1"># Report normalized weights per unique text output</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">sorted_normalized_weights</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>             <span class="c1"># List phases that produced the winning output</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="s2">&quot;source_phase&quot;</span><span class="p">:</span> <span class="n">source_phase_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_phase_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">source_phase_names</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="p">}</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_aggregation_trace</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="n">strategy_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy_name</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="n">inputs</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="s2">&quot;phase_output_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                    <span class="s2">&quot;context_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                    <span class="s2">&quot;configured_weights&quot;</span><span class="p">:</span> <span class="n">phase_weights</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="s2">&quot;default_weight&quot;</span><span class="p">:</span> <span class="n">default_weight</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="p">},</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">output</span><span class="o">=</span><span class="n">aggregation_result</span><span class="p">,</span> <span class="c1"># Contains response, conf, normalized weights map, source(s)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="n">parameters</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Parameters influencing the vote</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                    <span class="s2">&quot;configured_weights&quot;</span><span class="p">:</span> <span class="n">phase_weights</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                    <span class="s2">&quot;default_weight&quot;</span><span class="p">:</span> <span class="n">default_weight</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                     <span class="c1"># Trace the raw votes before normalization for debugging</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                    <span class="s2">&quot;raw_votes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">output_votes</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="p">}</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">return</span> <span class="n">aggregation_result</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">except</span> <span class="n">AggregationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted voting aggregation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>         <span class="k">raise</span> <span class="c1"># Re-raise known errors</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during Weighted Voting aggregation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="c1"># Wrap unexpected errors</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">raise</span> <span class="n">AggregationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted Voting aggregation failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>