
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://stephengenusa.github.io/ai-ensemble-suite/api/collaboration/">
      
      
        <link rel="prev" href="../models/">
      
      
        <link rel="next" href="../aggregation/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Collaboration - ai-ensemble-suite</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#collaboration-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="ai-ensemble-suite" class="md-header__button md-logo" aria-label="ai-ensemble-suite" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ai-ensemble-suite
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Collaboration
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/StephenGenusa/ai-ensemble-suite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    StephenGenusa/ai-ensemble-suite
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="ai-ensemble-suite" class="md-nav__button md-logo" aria-label="ai-ensemble-suite" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ai-ensemble-suite
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/StephenGenusa/ai-ensemble-suite" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    StephenGenusa/ai-ensemble-suite
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/installation.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/quickstart.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/configuration.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guide/advanced.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Usage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/collaboration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Collaboration Patterns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Aggregation Strategies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/production/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Production Configurations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ensemble/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ensemble
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Collaboration
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Collaboration
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration" class="md-nav__link">
    <span class="md-ellipsis">
      collaboration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AdversarialImprovement" class="md-nav__link">
    <span class="md-ellipsis">
      AdversarialImprovement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdversarialImprovement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AdversarialImprovement.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AdversarialImprovement.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AsyncThinking" class="md-nav__link">
    <span class="md-ellipsis">
      AsyncThinking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AsyncThinking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AsyncThinking.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Bagging" class="md-nav__link">
    <span class="md-ellipsis">
      Bagging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bagging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Bagging.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Bagging.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase" class="md-nav__link">
    <span class="md-ellipsis">
      BaseCollaborationPhase
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseCollaborationPhase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_input_phases" class="md-nav__link">
    <span class="md-ellipsis">
      get_input_phases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_required_models" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_type" class="md-nav__link">
    <span class="md-ellipsis">
      get_type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.render_template" class="md-nav__link">
    <span class="md-ellipsis">
      render_template
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseDebate" class="md-nav__link">
    <span class="md-ellipsis">
      BaseDebate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseDebate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseDebate.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseDebate.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ChainOfThoughtBranching" class="md-nav__link">
    <span class="md-ellipsis">
      ChainOfThoughtBranching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ChainOfThoughtBranching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ChainOfThoughtBranching.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ChainOfThoughtBranching.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.CompetitiveEvaluation" class="md-nav__link">
    <span class="md-ellipsis">
      CompetitiveEvaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CompetitiveEvaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.CompetitiveEvaluation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.CompetitiveEvaluation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ExpertCommittee" class="md-nav__link">
    <span class="md-ellipsis">
      ExpertCommittee
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExpertCommittee">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ExpertCommittee.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ExpertCommittee.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.HierarchicalReview" class="md-nav__link">
    <span class="md-ellipsis">
      HierarchicalReview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HierarchicalReview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.HierarchicalReview.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.HierarchicalReview.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Integration" class="md-nav__link">
    <span class="md-ellipsis">
      Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Integration.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.PerspectiveRotation" class="md-nav__link">
    <span class="md-ellipsis">
      PerspectiveRotation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerspectiveRotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.PerspectiveRotation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.PerspectiveRotation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedDebate" class="md-nav__link">
    <span class="md-ellipsis">
      RoleBasedDebate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RoleBasedDebate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedDebate.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedWorkflow" class="md-nav__link">
    <span class="md-ellipsis">
      RoleBasedWorkflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RoleBasedWorkflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedWorkflow.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedWorkflow.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StackedGeneralization" class="md-nav__link">
    <span class="md-ellipsis">
      StackedGeneralization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StackedGeneralization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StackedGeneralization.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StackedGeneralization.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StructuredCritique" class="md-nav__link">
    <span class="md-ellipsis">
      StructuredCritique
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.SynthesisOriented" class="md-nav__link">
    <span class="md-ellipsis">
      SynthesisOriented
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration" class="md-nav__link">
    <span class="md-ellipsis">
      UncertaintyBasedCollaboration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UncertaintyBasedCollaboration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Aggregation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration" class="md-nav__link">
    <span class="md-ellipsis">
      collaboration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AdversarialImprovement" class="md-nav__link">
    <span class="md-ellipsis">
      AdversarialImprovement
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AdversarialImprovement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AdversarialImprovement.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AdversarialImprovement.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AsyncThinking" class="md-nav__link">
    <span class="md-ellipsis">
      AsyncThinking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AsyncThinking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.AsyncThinking.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Bagging" class="md-nav__link">
    <span class="md-ellipsis">
      Bagging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bagging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Bagging.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Bagging.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase" class="md-nav__link">
    <span class="md-ellipsis">
      BaseCollaborationPhase
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseCollaborationPhase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_input_phases" class="md-nav__link">
    <span class="md-ellipsis">
      get_input_phases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_required_models" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_type" class="md-nav__link">
    <span class="md-ellipsis">
      get_type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase.render_template" class="md-nav__link">
    <span class="md-ellipsis">
      render_template
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseDebate" class="md-nav__link">
    <span class="md-ellipsis">
      BaseDebate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseDebate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseDebate.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.BaseDebate.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ChainOfThoughtBranching" class="md-nav__link">
    <span class="md-ellipsis">
      ChainOfThoughtBranching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ChainOfThoughtBranching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ChainOfThoughtBranching.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ChainOfThoughtBranching.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.CompetitiveEvaluation" class="md-nav__link">
    <span class="md-ellipsis">
      CompetitiveEvaluation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CompetitiveEvaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.CompetitiveEvaluation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.CompetitiveEvaluation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ExpertCommittee" class="md-nav__link">
    <span class="md-ellipsis">
      ExpertCommittee
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExpertCommittee">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ExpertCommittee.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.ExpertCommittee.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.HierarchicalReview" class="md-nav__link">
    <span class="md-ellipsis">
      HierarchicalReview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HierarchicalReview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.HierarchicalReview.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.HierarchicalReview.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Integration" class="md-nav__link">
    <span class="md-ellipsis">
      Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.Integration.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.PerspectiveRotation" class="md-nav__link">
    <span class="md-ellipsis">
      PerspectiveRotation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerspectiveRotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.PerspectiveRotation.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.PerspectiveRotation.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedDebate" class="md-nav__link">
    <span class="md-ellipsis">
      RoleBasedDebate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RoleBasedDebate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedDebate.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedWorkflow" class="md-nav__link">
    <span class="md-ellipsis">
      RoleBasedWorkflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RoleBasedWorkflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedWorkflow.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.RoleBasedWorkflow.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StackedGeneralization" class="md-nav__link">
    <span class="md-ellipsis">
      StackedGeneralization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StackedGeneralization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StackedGeneralization.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StackedGeneralization.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.StructuredCritique" class="md-nav__link">
    <span class="md-ellipsis">
      StructuredCritique
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.SynthesisOriented" class="md-nav__link">
    <span class="md-ellipsis">
      SynthesisOriented
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration" class="md-nav__link">
    <span class="md-ellipsis">
      UncertaintyBasedCollaboration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="UncertaintyBasedCollaboration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration.execute" class="md-nav__link">
    <span class="md-ellipsis">
      execute
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="collaboration-api">Collaboration API</h1>
<p>API reference for collaboration mechanisms. </p>


<div class="doc doc-object doc-module">



<a id="ai_ensemble_suite.collaboration"></a>
    <div class="doc doc-contents first">

        <p>Collaboration phases for ai-ensemble-suite.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.AdversarialImprovement" class="doc doc-heading">
            <code>AdversarialImprovement</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Adversarial Improvement collaboration phase.</p>
<p>Models improve a solution by actively seeking its weaknesses
and addressing them in an iterative process.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\adversarial_improvement.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">AdversarialImprovement</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Adversarial Improvement collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models improve a solution by actively seeking its weaknesses</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    and addressing them in an iterative process.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the adversarial improvement phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Get number of iterations</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iterations&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                <span class="sa">f</span><span class="s2">&quot;Invalid iterations (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="s2">&quot;using default: 3&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="c1"># Get template names</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adversarial_initial&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_critique_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critique_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adversarial_critique&quot;</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvement_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adversarial_improvement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="c1"># Get model roles</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critique_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvement_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># If roles not specified, assign them based on available models</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized AdversarialImprovement phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="si">}</span><span class="s2"> iterations&quot;</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Adversarial Improvement phase.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">                output: The final improved response.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">                context: Updated context with iteration history.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="c1"># Step 1: Generate initial solution</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">initial_solution</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_initial_solution</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="c1"># Initialize iteration history</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">iterations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">current_solution</span> <span class="o">=</span> <span class="n">initial_solution</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="c1"># Step 2: Iterative improvement</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="p">):</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting adversarial iteration </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="c1"># Generate critique</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">critique</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_critique</span><span class="p">(</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="n">query</span><span class="p">,</span> <span class="n">current_solution</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="c1"># Generate improvement</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">improved_solution</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_improvement</span><span class="p">(</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                    <span class="n">query</span><span class="p">,</span> <span class="n">current_solution</span><span class="p">,</span> <span class="n">critique</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="c1"># Store iteration</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="n">iterations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">current_solution</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="s2">&quot;critique&quot;</span><span class="p">:</span> <span class="n">critique</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                    <span class="s2">&quot;improvement&quot;</span><span class="p">:</span> <span class="n">improved_solution</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="p">})</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="c1"># Update current solution for next iteration</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="n">current_solution</span> <span class="o">=</span> <span class="n">improved_solution</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="sa">f</span><span class="s2">&quot;AdversarialImprovement phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="p">}</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                        <span class="s2">&quot;initial_solution&quot;</span><span class="p">:</span> <span class="n">initial_solution</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                        <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">iterations</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                        <span class="s2">&quot;final_solution&quot;</span><span class="p">:</span> <span class="n">current_solution</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                    <span class="p">},</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">current_solution</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="s2">&quot;initial_solution&quot;</span><span class="p">:</span> <span class="n">initial_solution</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">iterations</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.7</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># Confidence increases with iterations</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="p">}</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="sa">f</span><span class="s2">&quot;AdversarialImprovement phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_initial_solution</span><span class="p">(</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the initial solution.</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">            Initial solution text.</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">            CollaborationError: If generation fails.</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating initial solution&quot;</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="c1"># Check if initial solution came from previous phase</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="ow">and</span> <span class="n">inputs</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                    <span class="n">source_data</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using solution from previous phase: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                        <span class="k">return</span> <span class="n">source_data</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;output&quot;</span> <span class="ow">in</span> <span class="n">source_data</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using solution from previous phase: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                        <span class="k">return</span> <span class="n">source_data</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="c1"># If no solution from previous phases, generate new one</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No model available for generating initial solution&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="c1"># Format prompt for initial solution</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="n">initial_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format initial solution prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="c1"># Run initial model</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">initial_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">initial_prompt</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">initial_prompt</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">initial_result</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">initial_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;initial_solution&quot;</span><span class="p">}</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="k">return</span> <span class="n">initial_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate initial solution: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_critique</span><span class="p">(</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">solution</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a critique of the current solution.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">            solution: The current solution.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">            Critique text.</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">            CollaborationError: If critique generation fails.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating critique&quot;</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No model available for generating critique&quot;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="c1"># Format prompt for critique</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">}</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">critique_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_critique_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format critique prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="c1"># Run critique model</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">critique_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">critique_prompt</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">critique_prompt</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">critique_result</span><span class="p">,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">critique_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;critique&quot;</span><span class="p">}</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="k">return</span> <span class="n">critique_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate critique: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_improvement</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">solution</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="n">critique</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an improved solution based on critique.</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">            solution: The current solution.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">            critique: The critique of the current solution.</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">            Improved solution text.</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">            CollaborationError: If improvement generation fails.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating improvement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No model available for generating improvement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="c1"># Format prompt for improvement</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="p">,</span> <span class="s2">&quot;critique&quot;</span><span class="p">:</span> <span class="n">critique</span><span class="p">}</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">improvement_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_improvement_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format improvement prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="c1"># Run improvement model</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">improvement_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span><span class="p">,</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">improvement_prompt</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">improvement_prompt</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">improvement_result</span><span class="p">,</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">improvement_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;improvement&quot;</span><span class="p">}</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                <span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="k">return</span> <span class="n">improvement_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate improvement: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.AdversarialImprovement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the adversarial improvement phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\adversarial_improvement.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the adversarial improvement phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Get number of iterations</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iterations&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid iterations (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="s2">&quot;using default: 3&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="c1"># Get template names</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_initial_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adversarial_initial&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_critique_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critique_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adversarial_critique&quot;</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvement_template&quot;</span><span class="p">,</span> <span class="s2">&quot;adversarial_improvement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># Get model roles</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;critique_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;improvement_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># If roles not specified, assign them based on available models</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_critique_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span><span class="p">:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_improvement_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_model</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized AdversarialImprovement phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="si">}</span><span class="s2"> iterations&quot;</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.AdversarialImprovement.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Adversarial Improvement phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The final improved response.
context: Updated context with iteration history.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\adversarial_improvement.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Adversarial Improvement phase.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            output: The final improved response.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">            context: Updated context with iteration history.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="c1"># Step 1: Generate initial solution</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">initial_solution</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_initial_solution</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="c1"># Initialize iteration history</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">iterations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">current_solution</span> <span class="o">=</span> <span class="n">initial_solution</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="c1"># Step 2: Iterative improvement</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="p">):</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting adversarial iteration </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># Generate critique</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">critique</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_critique</span><span class="p">(</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">current_solution</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="c1"># Generate improvement</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">improved_solution</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_improvement</span><span class="p">(</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">current_solution</span><span class="p">,</span> <span class="n">critique</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="c1"># Store iteration</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">iterations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="s2">&quot;solution&quot;</span><span class="p">:</span> <span class="n">current_solution</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="s2">&quot;critique&quot;</span><span class="p">:</span> <span class="n">critique</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="s2">&quot;improvement&quot;</span><span class="p">:</span> <span class="n">improved_solution</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="p">})</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="c1"># Update current solution for next iteration</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">current_solution</span> <span class="o">=</span> <span class="n">improved_solution</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="sa">f</span><span class="s2">&quot;AdversarialImprovement phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="p">}</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                    <span class="s2">&quot;initial_solution&quot;</span><span class="p">:</span> <span class="n">initial_solution</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">iterations</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                    <span class="s2">&quot;final_solution&quot;</span><span class="p">:</span> <span class="n">current_solution</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="p">},</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">current_solution</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="s2">&quot;initial_solution&quot;</span><span class="p">:</span> <span class="n">initial_solution</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">iterations</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.7</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterations</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># Confidence increases with iterations</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="p">}</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="sa">f</span><span class="s2">&quot;AdversarialImprovement phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.AsyncThinking" class="doc doc-heading">
            <code>AsyncThinking</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Asynchronous Thinking collaboration phase.</p>
<p>Models work independently on a problem before their outputs are collected.
This is the simplest form of collaboration where multiple models process
the same prompt concurrently.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\async_thinking.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncThinking</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchronous Thinking collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models work independently on a problem before their outputs are collected.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    This is the simplest form of collaboration where multiple models process</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    the same prompt concurrently.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Asynchronous Thinking phase.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">                output: Dictionary mapping model IDs to their responses.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">                context: Updated context for the next phase.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="c1"># Get prompt template or use the query directly</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                    <span class="c1"># Format prompt with query and any inputs from previous phases</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                    <span class="n">context_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                    <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context_vars</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                    <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="c1"># Run models concurrently</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="c1"># Process outputs for simpler consumption by next phases</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="n">processed_outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="n">processed_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="c1"># Select the primary output for single model case</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">primary_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="c1"># Use the first model in the model_ids list as primary if available</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>                <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">processed_outputs</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                    <span class="n">primary_output</span> <span class="o">=</span> <span class="n">processed_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="sa">f</span><span class="s2">&quot;AsyncThinking phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                    <span class="s2">&quot;model_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_results</span><span class="p">),</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="p">}</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">processed_outputs</span><span class="p">},</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="c1"># Calculate a combined confidence score (average of all models)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                        <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                        <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">confidence_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">,</span>  
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">processed_outputs</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence_score</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span>  <span class="c1"># Include full model results for advanced use</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="p">}</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="sa">f</span><span class="s2">&quot;AsyncThinking phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.AsyncThinking.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Asynchronous Thinking phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: Dictionary mapping model IDs to their responses.
context: Updated context for the next phase.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\async_thinking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Asynchronous Thinking phase.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            output: Dictionary mapping model IDs to their responses.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            context: Updated context for the next phase.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="c1"># Get prompt template or use the query directly</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="c1"># Format prompt with query and any inputs from previous phases</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="n">context_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context_vars</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="c1"># Run models concurrently</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="c1"># Process outputs for simpler consumption by next phases</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">processed_outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">processed_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># Select the primary output for single model case</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">primary_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="c1"># Use the first model in the model_ids list as primary if available</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">processed_outputs</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="n">processed_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="sa">f</span><span class="s2">&quot;AsyncThinking phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="s2">&quot;model_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_results</span><span class="p">),</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="p">}</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">processed_outputs</span><span class="p">},</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="c1"># Calculate a combined confidence score (average of all models)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">confidence_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">,</span>  
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">processed_outputs</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence_score</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span>  <span class="c1"># Include full model results for advanced use</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="p">}</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="sa">f</span><span class="s2">&quot;AsyncThinking phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.Bagging" class="doc doc-heading">
            <code>Bagging</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Bagging (Bootstrap Aggregating) collaboration phase.</p>
<p>Models process different variations of the same input, then their outputs
are aggregated to produce a more robust result. This reduces variance and
increases stability in the ensemble's output.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\bagging.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">Bagging</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bagging (Bootstrap Aggregating) collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models process different variations of the same input, then their outputs</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    are aggregated to produce a more robust result. This reduces variance and</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    increases stability in the ensemble&#39;s output.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Bagging collaboration phase.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="c1"># Load bagging-specific configuration</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_ratio&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;variation_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;token_sampling&quot;</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregation_method&quot;</span><span class="p">,</span> <span class="s2">&quot;voting&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_variations&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">))</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bagging phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; requires at least 1 variation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="sa">f</span><span class="s2">&quot;Configured Bagging phase with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span><span class="si">}</span><span class="s2"> variations using &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span><span class="si">}</span><span class="s2">&#39; strategy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span><span class="p">,</span> <span class="s2">&quot;sample_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span><span class="p">}</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_variations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate input variations using the configured strategy.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            text: The original input text.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            n: Number of variations to generate.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            List of text variations.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">variations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span> <span class="o">==</span> <span class="s2">&quot;token_sampling&quot;</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="c1"># Sample tokens from the original text</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="c1"># Sample ~sample_ratio proportion of words</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>                <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span><span class="p">))</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>                <span class="n">sampled_words</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                <span class="n">variations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sampled_words</span><span class="p">))</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span> <span class="o">==</span> <span class="s2">&quot;segment_focus&quot;</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="c1"># Focus on different segments of the text</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># For short texts, use token sampling instead</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_variations</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">segments</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># At least 3 segments</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">segment_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">//</span> <span class="n">segments</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="c1"># Focus on a primary segment but include some context</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="n">primary_segment</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">segments</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">primary_segment</span> <span class="o">*</span> <span class="n">segment_length</span> <span class="o">-</span> <span class="n">segment_length</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="p">(</span><span class="n">primary_segment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">segment_length</span> <span class="o">+</span> <span class="n">segment_length</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="n">variations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span> <span class="o">==</span> <span class="s2">&quot;instruction_variation&quot;</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="c1"># Create variations with different instructions/framing</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="n">instruction_variations</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="sa">f</span><span class="s2">&quot;Please answer this question: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="sa">f</span><span class="s2">&quot;Analyze the following: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="sa">f</span><span class="s2">&quot;Consider this query: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="sa">f</span><span class="s2">&quot;Respond to this input: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="sa">f</span><span class="s2">&quot;Evaluate this statement: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="p">]</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="n">variations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instruction_variations</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruction_variations</span><span class="p">)])</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default or &quot;none&quot; - just use the original text repeated</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">variations</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">return</span> <span class="n">variations</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate multiple outputs into a single result.</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">            outputs: List of model outputs to aggregate.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">            Aggregated output string.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span> <span class="o">==</span> <span class="s2">&quot;voting&quot;</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="c1"># Simple majority voting - works best for classification or short responses</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="k">return</span> <span class="n">counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="c1"># For longer texts, voting might not make sense</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="c1"># Fall back to the first output</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Voting aggregation not suitable for long texts, using primary output instead&quot;</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span> <span class="o">==</span> <span class="s2">&quot;concatenation&quot;</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Join all outputs with a delimiter</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">===== NEXT RESPONSE =====</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span> <span class="o">==</span> <span class="s2">&quot;summarization&quot;</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="c1"># This would require an additional model call to summarize</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="c1"># For now, we&#39;ll use a simple combination approach</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="c1"># Take the first sentence from each output for a quick summary</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">summary_parts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="n">first_sentence</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">else</span> <span class="n">output</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_sentence</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_parts</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default to first output</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">outputs</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Bagging phase.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">                output: The aggregated output from all variations.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">                outputs: Dictionary mapping variation IDs to individual responses.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">                context: Updated context for the next phase.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="c1"># Prepare the base prompt</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                    <span class="n">context_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                    <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context_vars</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                    <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="c1"># Generate variations of the prompt</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="n">variations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_variations</span><span class="p">(</span><span class="n">base_prompt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="c1"># Execute each variation with a model</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">all_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">raw_results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variant_prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variations</span><span class="p">):</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="c1"># Use modulo in case we have more variations than models</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="n">model_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="n">model_idx</span><span class="p">]</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="c1"># Run individual model on this variation</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">variant_prompt</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="n">model_ids</span><span class="o">=</span><span class="p">[</span><span class="n">model_id</span><span class="p">],</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                <span class="c1"># Store the result</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                <span class="n">variation_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;variation_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="n">all_outputs</span><span class="p">[</span><span class="n">variation_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="n">raw_results</span><span class="p">[</span><span class="n">variation_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="c1"># Add trace for this variation if collector is provided</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                        <span class="n">model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">_bagging_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                        <span class="n">input_prompt</span><span class="o">=</span><span class="n">variant_prompt</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                        <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">],</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                        <span class="n">execution_time</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;variation_id&quot;</span><span class="p">:</span> <span class="n">variation_id</span><span class="p">}</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                    <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1"># Aggregate the outputs into a single result</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">aggregated_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_outputs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="c1"># Calculate agreement score as a confidence measure</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="c1"># Count matching words across outputs</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="n">word_sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">all_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="n">union_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">word_sets</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="n">agreement_score</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="c1"># Count how many outputs contain each word</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                        <span class="n">word_counts</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">word_sets</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="c1"># Average agreement across all words</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">avg_agreement</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_outputs</span><span class="p">))</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">agreement_score</span> <span class="o">=</span> <span class="n">avg_agreement</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="n">agreement_score</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                <span class="sa">f</span><span class="s2">&quot;Bagging phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="s2">&quot;variation_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variations</span><span class="p">),</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="s2">&quot;agreement_score&quot;</span><span class="p">:</span> <span class="n">agreement_score</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                <span class="p">}</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;base_prompt&quot;</span><span class="p">:</span> <span class="n">base_prompt</span><span class="p">},</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;aggregated_output&quot;</span><span class="p">:</span> <span class="n">aggregated_output</span><span class="p">,</span> <span class="s2">&quot;variation_outputs&quot;</span><span class="p">:</span> <span class="n">all_outputs</span><span class="p">},</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                        <span class="s2">&quot;variation_strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                        <span class="s2">&quot;sample_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                        <span class="s2">&quot;aggregation_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                        <span class="s2">&quot;num_variations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                    <span class="p">}</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">aggregated_output</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">all_outputs</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">agreement_score</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">raw_results</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                <span class="s2">&quot;variation_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variations</span><span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="p">}</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="sa">f</span><span class="s2">&quot;Bagging phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.Bagging.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the Bagging collaboration phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\bagging.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Bagging collaboration phase.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="c1"># Load bagging-specific configuration</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_ratio&quot;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;variation_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;token_sampling&quot;</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aggregation_method&quot;</span><span class="p">,</span> <span class="s2">&quot;voting&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_variations&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">))</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bagging phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; requires at least 1 variation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="sa">f</span><span class="s2">&quot;Configured Bagging phase with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span><span class="si">}</span><span class="s2"> variations using &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span><span class="si">}</span><span class="s2">&#39; strategy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span><span class="p">,</span> <span class="s2">&quot;sample_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span><span class="p">}</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.Bagging.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Bagging phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The aggregated output from all variations.
outputs: Dictionary mapping variation IDs to individual responses.
context: Updated context for the next phase.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\bagging.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Bagging phase.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            output: The aggregated output from all variations.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">            outputs: Dictionary mapping variation IDs to individual responses.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            context: Updated context for the next phase.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="c1"># Prepare the base prompt</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="n">context_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context_vars</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="c1"># Generate variations of the prompt</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">variations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_variations</span><span class="p">(</span><span class="n">base_prompt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="c1"># Execute each variation with a model</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">all_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">raw_results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variant_prompt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variations</span><span class="p">):</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="c1"># Use modulo in case we have more variations than models</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">model_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="n">model_idx</span><span class="p">]</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="c1"># Run individual model on this variation</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">variant_prompt</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="n">model_ids</span><span class="o">=</span><span class="p">[</span><span class="n">model_id</span><span class="p">],</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="c1"># Store the result</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">variation_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;variation_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">all_outputs</span><span class="p">[</span><span class="n">variation_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">raw_results</span><span class="p">[</span><span class="n">variation_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="c1"># Add trace for this variation if collector is provided</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">_bagging_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">variant_prompt</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">],</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;variation_id&quot;</span><span class="p">:</span> <span class="n">variation_id</span><span class="p">}</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="c1"># Aggregate the outputs into a single result</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">aggregated_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_outputs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="c1"># Calculate agreement score as a confidence measure</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># Count matching words across outputs</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">word_sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">all_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">union_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">word_sets</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="n">agreement_score</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="c1"># Count how many outputs contain each word</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                    <span class="n">word_counts</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">word_sets</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="c1"># Average agreement across all words</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">avg_agreement</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_outputs</span><span class="p">))</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="n">agreement_score</span> <span class="o">=</span> <span class="n">avg_agreement</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="n">agreement_score</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="sa">f</span><span class="s2">&quot;Bagging phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="s2">&quot;variation_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variations</span><span class="p">),</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="s2">&quot;agreement_score&quot;</span><span class="p">:</span> <span class="n">agreement_score</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="p">}</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;base_prompt&quot;</span><span class="p">:</span> <span class="n">base_prompt</span><span class="p">},</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;aggregated_output&quot;</span><span class="p">:</span> <span class="n">aggregated_output</span><span class="p">,</span> <span class="s2">&quot;variation_outputs&quot;</span><span class="p">:</span> <span class="n">all_outputs</span><span class="p">},</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                    <span class="s2">&quot;variation_strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_variation_strategy</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="s2">&quot;sample_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_ratio</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                    <span class="s2">&quot;aggregation_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregation_method</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                    <span class="s2">&quot;num_variations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_variations</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="p">}</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">aggregated_output</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">all_outputs</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">agreement_score</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">raw_results</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="s2">&quot;variation_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">variations</span><span class="p">)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="p">}</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="sa">f</span><span class="s2">&quot;Bagging phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase" class="doc doc-heading">
            <code>BaseCollaborationPhase</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for collaboration phases.</p>
<p>Defines the interface for collaboration phases and provides common functionality.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">BaseCollaborationPhase</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for collaboration phases.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Defines the interface for collaboration phases and provides common functionality.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>            <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the collaboration phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="o">=</span> <span class="n">model_manager</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span> <span class="o">=</span> <span class="n">config_manager</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="n">phase_name</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="c1"># Get reference to template manager through model_manager.ensemble</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">ensemble</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_manager</span><span class="o">.</span><span class="n">ensemble</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                                                                                     <span class="s1">&#39;template_manager&#39;</span><span class="p">):</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span> <span class="o">=</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">template_manager</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># Load phase configuration (existing code)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_collaboration_config</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load configuration for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="c1"># Get phase type</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; is missing required field: type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># Get model IDs for this phase</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="c1"># Get input sources (previous phases)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_from&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">]</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="c1"># Get prompt template name</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt_template&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized collaboration phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; of type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">}</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the collaboration phase.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">                output: The phase output.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">                context: Updated context for the next phase.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">pass</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the phase configuration.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">            Dictionary containing the phase configuration.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the phase name.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">            The phase name.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the phase type.</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">            The phase type.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the models required by this phase.</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            Set of model IDs required by this phase.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the input phases this phase depends on.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">            List of phase names this phase takes input from.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">render_template</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render a template using Jinja2 templating.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">            template_name: The name of the template to render.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">            context: Dictionary of context variables for rendering.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">            The rendered template string.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">            ConfigurationError: If template is not found.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">            ValueError: If template rendering fails.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="c1"># Use the template manager if available</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="c1"># def format_prompt(</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="c1">#         self,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="c1">#         template_name: str,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="c1">#         **kwargs: Any</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="c1"># ) -&gt; str:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="c1">#     &quot;&quot;&quot;Format a prompt template with the provided values using simple substitution.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="c1">#</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="c1">#     Note:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="c1">#         For more advanced templating features, use render_template() instead.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="c1">#</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>    <span class="c1">#     Args:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="c1">#         template_name: The name of the template to format.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="c1">#         **kwargs: Values to format the template with.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="c1">#</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="c1">#     Returns:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="c1">#         The formatted prompt.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="c1">#</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="c1">#     Raises:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="c1">#         ConfigurationError: If the template does not exist.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="c1">#     &quot;&quot;&quot;</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="c1">#     template = self._config_manager.get_template(template_name)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="c1">#     if template is None:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="c1">#         raise ConfigurationError(f&quot;Template not found: {template_name}&quot;)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="c1">#</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="c1">#     return format_prompt(template, **kwargs)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">model_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run inference on specific models or all phase models.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">            prompt: The prompt to send to the models.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">            model_ids: Optional list of model IDs to use. If None, uses all phase models.</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a><span class="sd">            **kwargs: Additional parameters for model inference.</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">            Dictionary mapping model IDs to their outputs.</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">            CollaborationError: If model inference fails.</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="n">ids_to_use</span> <span class="o">=</span> <span class="n">model_ids</span> <span class="k">if</span> <span class="n">model_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids_to_use</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No models specified for phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_all_models</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">ids_to_use</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1"># Add traces if collector is provided</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                    <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                        <span class="n">input_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                        <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                        <span class="n">execution_time</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                        <span class="n">parameters</span><span class="o">=</span><span class="n">kwargs</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                    <span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to run models for phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_inputs_from_context</span><span class="p">(</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract inputs from context based on input_from configuration.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">            context: The context dictionary containing previous phase outputs.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            Dictionary containing inputs for this phase.</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">            CollaborationError: If a required input is missing.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="c1"># If no input_from is specified, return empty inputs</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">return</span> <span class="n">inputs</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="c1"># Extract inputs from context</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires input from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                    <span class="s2">&quot;but it is not available in the context&quot;</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                <span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">inputs</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">return</span> <span class="n">inputs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the collaboration phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the collaboration phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="o">=</span> <span class="n">model_manager</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span> <span class="o">=</span> <span class="n">config_manager</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span> <span class="o">=</span> <span class="n">phase_name</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Get reference to template manager through model_manager.ensemble</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="s1">&#39;ensemble&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">ensemble</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_manager</span><span class="o">.</span><span class="n">ensemble</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                                                                                 <span class="s1">&#39;template_manager&#39;</span><span class="p">):</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span> <span class="o">=</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">ensemble</span><span class="o">.</span><span class="n">template_manager</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="c1"># Load phase configuration (existing code)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_collaboration_config</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load configuration for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># Get phase type</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; is missing required field: type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># Get model IDs for this phase</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="c1"># Get input sources (previous phases)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_from&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">]</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="c1"># Get prompt template name</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt_template&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized collaboration phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; of type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">}</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the collaboration phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The phase output.
context: Updated context for the next phase.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span>
<span class="normal"><a href="#__codelineno-0-92">92</a></span>
<span class="normal"><a href="#__codelineno-0-93">93</a></span>
<span class="normal"><a href="#__codelineno-0-94">94</a></span>
<span class="normal"><a href="#__codelineno-0-95">95</a></span>
<span class="normal"><a href="#__codelineno-0-96">96</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="nd">@abstractmethod</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the collaboration phase.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            output: The phase output.</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            context: Updated context for the next phase.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the phase configuration.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing the phase configuration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the phase configuration.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        Dictionary containing the phase configuration.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_input_phases" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_input_phases</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the input phases this phase depends on.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of phase names this phase takes input from.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_input_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the input phases this phase depends on.</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        List of phase names this phase takes input from.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_name</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the phase name.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The phase name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-106" name="__codelineno-0-106"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the phase name.</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        The phase name.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_required_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_required_models</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the models required by this phase.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Set">Set</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Set of model IDs required by this phase.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_required_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the models required by this phase.</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        Set of model IDs required by this phase.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.get_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_type</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the phase type.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The phase type.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the phase type.</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">        The phase type.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_type</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseCollaborationPhase.render_template" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Render a template using Jinja2 templating.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>template_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the template to render.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of context variables for rendering.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The rendered template string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If template is not found.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If template rendering fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="k">def</span><span class="w"> </span><span class="nf">render_template</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Render a template using Jinja2 templating.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        template_name: The name of the template to render.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        context: Dictionary of context variables for rendering.</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        The rendered template string.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        ConfigurationError: If template is not found.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        ValueError: If template rendering fails.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="c1"># Use the template manager if available</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_manager</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.BaseDebate" class="doc doc-heading">
            <code>BaseDebate</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Base class for structured debate collaboration phases.</p>
<p>Provides common functionality for different debate patterns.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\base_debate.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">BaseDebate</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for structured debate collaboration phases.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Provides common functionality for different debate patterns.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the base debate phase.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="c1"># Get debate-specific configuration</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;critique&quot;</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="c1"># Get debate rounds (default to 1)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rounds&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="c1"># Validate rounds</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                <span class="sa">f</span><span class="s2">&quot;Invalid rounds value for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, defaulting to 1&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="c1"># Track rounds in debugging</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized debate phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with subtype &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="si">}</span><span class="s2"> rounds&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the debate phase.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">                output: The debate output (typically from the final round).</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">                context: Updated context including intermediate debate exchanges.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                    <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires inputs from &quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                    <span class="sa">f</span><span class="s2">&quot;previous phases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="c1"># Get or create the initial response that will be critiqued</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">initial_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_response</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_response</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; could not determine &quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="s2">&quot;an initial response to critique&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="c1"># Execute the appropriate debate pattern</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">debate_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_debate_pattern</span><span class="p">(</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="n">query</span><span class="p">,</span> 
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="n">initial_response</span><span class="p">,</span> 
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="n">inputs</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="n">trace_collector</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                    <span class="s2">&quot;debate_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="p">}</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> 
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                        <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                        <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                    <span class="p">},</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="n">debate_results</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="c1"># Return results - ensure we include an &quot;output&quot; key for consistent interface</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">debate_results</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="c1"># Default to the final critique or perspective as the output</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="k">if</span> <span class="s2">&quot;critique&quot;</span> <span class="ow">in</span> <span class="n">debate_results</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;critique&quot;</span><span class="p">]</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="k">elif</span> <span class="s2">&quot;final_perspective&quot;</span> <span class="ow">in</span> <span class="n">debate_results</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;final_perspective&quot;</span><span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="k">elif</span> <span class="s2">&quot;exchanges&quot;</span> <span class="ow">in</span> <span class="n">debate_results</span> <span class="ow">and</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                    <span class="c1"># Take the last exchange as the output</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                    <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                    <span class="c1"># Fallback to empty string</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="k">return</span> <span class="n">debate_results</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_initial_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the initial response that will be critiqued.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            The initial response as a string.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="c1"># Check input_from configuration to determine source</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="c1"># Typically the first input source is the initial response</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">source_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="c1"># Check if the source phase exists in inputs</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">if</span> <span class="n">source_phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="sa">f</span><span class="s2">&quot;Initial response source &#39;</span><span class="si">{</span><span class="n">source_phase</span><span class="si">}</span><span class="s2">&#39; not found in inputs&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># Extract the response from the source phase</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">source</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">source_phase</span><span class="p">]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="c1"># Handle different input formats</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="c1"># Direct string response</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="k">return</span> <span class="n">source</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="c1"># Dictionary response - try to get the output field</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="k">return</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="c1"># If no output field, try to find any string field</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                    <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="c1"># Fallback to empty string if no suitable response found</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="sa">f</span><span class="s2">&quot;Could not extract initial response from source &#39;</span><span class="si">{</span><span class="n">source_phase</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_key_points</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract key points from a text.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        This is a simple implementation that finds sentences containing strong indicators.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">            text: The text to extract points from.</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">            max_points: Maximum number of points to extract.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">            List of key points extracted from the text.</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="c1"># List of indicator phrases for key points</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="sa">r</span><span class="s1">&#39;important&#39;</span><span class="p">,</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="sa">r</span><span class="s1">&#39;significant&#39;</span><span class="p">,</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="sa">r</span><span class="s1">&#39;key&#39;</span><span class="p">,</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="sa">r</span><span class="s1">&#39;critical&#39;</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="sa">r</span><span class="s1">&#39;essential&#39;</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="sa">r</span><span class="s1">&#39;main&#39;</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="sa">r</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="sa">r</span><span class="s1">&#39;fundamental&#39;</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="sa">r</span><span class="s1">&#39;primarily&#39;</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="sa">r</span><span class="s1">&#39;notably&#39;</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="sa">r</span><span class="s1">&#39;specifically&#39;</span><span class="p">,</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="sa">r</span><span class="s1">&#39;particularly&#39;</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="sa">r</span><span class="s1">&#39;must&#39;</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="sa">r</span><span class="s1">&#39;should&#39;</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="sa">r</span><span class="s1">&#39;need to&#39;</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="sa">r</span><span class="s1">&#39;\d+\.&#39;</span><span class="p">,</span>  <span class="c1"># Numbered points like &quot;1.&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="sa">r</span><span class="s1">&#39;firstly&#39;</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="sa">r</span><span class="s1">&#39;secondly&#39;</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="sa">r</span><span class="s1">&#39;lastly&#39;</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="sa">r</span><span class="s1">&#39;finally&#39;</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="sa">r</span><span class="s1">&#39;in conclusion&#39;</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="p">]</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="c1"># Split text into sentences</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">sentences</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;=[.!?])\s+&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="c1"># Filter sentences containing indicators</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">key_sentences</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">indicator</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="n">key_sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="k">break</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="c1"># Limit to max_points</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">key_sentences</span><span class="p">[:</span><span class="n">max_points</span><span class="p">]</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="c1"># If no points found, take the first few sentences</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">points</span> <span class="ow">and</span> <span class="n">sentences</span><span class="p">:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">points</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">max_points</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">))]</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="k">return</span> <span class="n">points</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_debate_pattern</span><span class="p">(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">initial_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the specific debate pattern defined by the subtype.</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        This method should be implemented by subclasses.</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">            initial_response: The initial response to critique.</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">            Dictionary containing debate results.</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">            NotImplementedError: If not implemented by subclass.</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="sa">f</span><span class="s2">&quot;Debate pattern &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span><span class="si">}</span><span class="s2">&#39; not implemented in base class&quot;</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseDebate.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the base debate phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\base_debate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the base debate phase.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="c1"># Get debate-specific configuration</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subtype&quot;</span><span class="p">,</span> <span class="s2">&quot;critique&quot;</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Get debate rounds (default to 1)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rounds&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="c1"># Validate rounds</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid rounds value for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, defaulting to 1&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="c1"># Track rounds in debugging</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized debate phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with subtype &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="si">}</span><span class="s2"> rounds&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.BaseDebate.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the debate phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The debate output (typically from the final round).
context: Updated context including intermediate debate exchanges.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\base_debate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the debate phase.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            output: The debate output (typically from the final round).</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            context: Updated context including intermediate debate exchanges.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires inputs from &quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="sa">f</span><span class="s2">&quot;previous phases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="c1"># Get or create the initial response that will be critiqued</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">initial_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_response</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_response</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; could not determine &quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="s2">&quot;an initial response to critique&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="c1"># Execute the appropriate debate pattern</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">debate_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_debate_pattern</span><span class="p">(</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">query</span><span class="p">,</span> 
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">initial_response</span><span class="p">,</span> 
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">inputs</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">trace_collector</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="s2">&quot;debate_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtype</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="p">}</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> 
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                    <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                    <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="p">},</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="n">output_data</span><span class="o">=</span><span class="n">debate_results</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="c1"># Return results - ensure we include an &quot;output&quot; key for consistent interface</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">debate_results</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="c1"># Default to the final critique or perspective as the output</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">if</span> <span class="s2">&quot;critique&quot;</span> <span class="ow">in</span> <span class="n">debate_results</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;critique&quot;</span><span class="p">]</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="k">elif</span> <span class="s2">&quot;final_perspective&quot;</span> <span class="ow">in</span> <span class="n">debate_results</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;final_perspective&quot;</span><span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">elif</span> <span class="s2">&quot;exchanges&quot;</span> <span class="ow">in</span> <span class="n">debate_results</span> <span class="ow">and</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="c1"># Take the last exchange as the output</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="c1"># Fallback to empty string</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">debate_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">return</span> <span class="n">debate_results</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="sa">f</span><span class="s2">&quot;Debate phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.ChainOfThoughtBranching" class="doc doc-heading">
            <code>ChainOfThoughtBranching</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Chain of Thought Branching collaboration phase.</p>
<p>Models trace through multiple reasoning paths, then evaluate
and select the most promising path.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\chain_of_thought.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">ChainOfThoughtBranching</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chain of Thought Branching collaboration phase.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Models trace through multiple reasoning paths, then evaluate</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    and select the most promising path.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>            <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the chain of thought branching phase.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="c1"># Get branch count</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_count&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="sa">f</span><span class="s2">&quot;Invalid branch_count (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="s2">&quot;using default: 3&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="c1"># Get branch depth</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_depth&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="sa">f</span><span class="s2">&quot;Invalid branch_depth (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="s2">&quot;using default: 2&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span> <span class="o">=</span> <span class="mi">2</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># Get template names</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_template&quot;</span><span class="p">,</span> <span class="s2">&quot;cot_initial&quot;</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_branch_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_template&quot;</span><span class="p">,</span> <span class="s2">&quot;cot_branch&quot;</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_template&quot;</span><span class="p">,</span> <span class="s2">&quot;cot_evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="c1"># Get evaluation model (default to first model)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized ChainOfThoughtBranching phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="si">}</span><span class="s2"> branches of depth </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Chain of Thought Branching phase.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">                output: The final response after evaluating reasoning branches.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">                context: Updated context with branch information.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="c1"># Step 1: Generate initial thoughts</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">initial_thoughts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_initial_thoughts</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="c1"># Step 2: Develop reasoning branches</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">branches</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_develop_branches</span><span class="p">(</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">initial_thoughts</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="c1"># Step 3: Evaluate branches</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">evaluation_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_branches</span><span class="p">(</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="sa">f</span><span class="s2">&quot;ChainOfThoughtBranching phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">),</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="p">}</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">},</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                        <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">initial_thoughts</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                        <span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="n">branches</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                        <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                    <span class="p">},</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="c1"># Get final output</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">final_output</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;best_branch_conclusion&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_output</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">final_output</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="c1"># Calculate confidence</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">final_output</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">initial_thoughts</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="n">branches</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="sa">f</span><span class="s2">&quot;ChainOfThoughtBranching phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_initial_thoughts</span><span class="p">(</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate initial thoughts on the query.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">            Dictionary with initial thoughts.</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">            CollaborationError: If generation fails.</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating initial thoughts&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Format initial prompt</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">initial_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format initial thoughts prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="c1"># Select model for initial thoughts (first model)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">initial_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_model</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No models available for generating initial thoughts&quot;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="c1"># Run model</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">initial_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="n">model_id</span><span class="o">=</span><span class="n">initial_model</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">initial_prompt</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="n">initial_model</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">initial_prompt</span><span class="p">,</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">initial_result</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">initial_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">initial_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="n">initial_model</span><span class="p">,</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="s2">&quot;raw_result&quot;</span><span class="p">:</span> <span class="n">initial_result</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="p">}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate initial thoughts: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_develop_branches</span><span class="p">(</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">initial_thoughts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Develop multiple reasoning branches from initial thoughts.</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">            initial_thoughts: Results from initial thoughts step.</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">            List of branch dictionaries.</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">            CollaborationError: If branch development fails.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Developing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="si">}</span><span class="s2"> reasoning branches&quot;</span><span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">initial_text</span> <span class="o">=</span> <span class="n">initial_thoughts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_thoughts&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="n">branches</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="c1"># Distribute models across branches</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">model_assignments</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="p">):</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">model_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">model_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="n">model_idx</span><span class="p">])</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="c1"># Create initial branches</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="k">for</span> <span class="n">branch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="p">):</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="n">branch</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="s2">&quot;branch_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;branch_</span><span class="si">{</span><span class="n">branch_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">initial_text</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="n">model_assignments</span><span class="p">[</span><span class="n">branch_idx</span><span class="p">]</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="p">}</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="c1"># Develop each branch step by step</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">for</span> <span class="n">step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="p">):</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Developing step </span><span class="si">{</span><span class="n">step_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                <span class="c1"># Format branch prompt</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                    <span class="c1"># Gather previous steps for context</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                    <span class="n">previous_steps</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                    <span class="k">for</span> <span class="n">prev_step</span> <span class="ow">in</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                        <span class="n">previous_steps</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step </span><span class="si">{</span><span class="n">prev_step</span><span class="p">[</span><span class="s1">&#39;step_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">prev_step</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                        <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;initial_thoughts&quot;</span><span class="p">],</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                        <span class="s2">&quot;previous_steps&quot;</span><span class="p">:</span> <span class="n">previous_steps</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                        <span class="s2">&quot;step_number&quot;</span><span class="p">:</span> <span class="n">step_idx</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="p">}</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="n">branch_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to format prompt for branch </span><span class="si">{</span><span class="n">branch</span><span class="p">[</span><span class="s1">&#39;branch_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                        <span class="sa">f</span><span class="s2">&quot;step </span><span class="si">{</span><span class="n">step_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                    <span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                <span class="c1"># Run model for this branch step</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                    <span class="n">model_id</span> <span class="o">=</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;model_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                    <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">branch_prompt</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                    <span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                    <span class="c1"># Add step to branch</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                    <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                        <span class="s2">&quot;step_number&quot;</span><span class="p">:</span> <span class="n">step_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">step_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                        <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="n">model_id</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                    <span class="p">})</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                        <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                            <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                            <span class="n">input_prompt</span><span class="o">=</span><span class="n">branch_prompt</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                            <span class="n">output</span><span class="o">=</span><span class="n">step_result</span><span class="p">,</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                            <span class="n">execution_time</span><span class="o">=</span><span class="n">step_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                                <span class="s2">&quot;branch_id&quot;</span><span class="p">:</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;branch_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                                <span class="s2">&quot;step_number&quot;</span><span class="p">:</span> <span class="n">step_idx</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                            <span class="p">}</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                        <span class="p">)</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                        <span class="sa">f</span><span class="s2">&quot;Failed to develop step </span><span class="si">{</span><span class="n">step_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> for branch </span><span class="si">{</span><span class="n">branch</span><span class="p">[</span><span class="s1">&#39;branch_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                    <span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="c1"># Extract conclusions from final steps</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="k">if</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                <span class="n">final_step</span> <span class="o">=</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;conclusion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_step</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;conclusion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No conclusion reached.&quot;</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="k">return</span> <span class="n">branches</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_branches</span><span class="p">(</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">branches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate reasoning branches and select the best one.</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">            branches: List of developed reasoning branches.</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">            Dictionary with evaluation results.</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">            CollaborationError: If evaluation fails.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Evaluating reasoning branches&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="c1"># Check if evaluation model is available</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span><span class="p">:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No evaluation model specified&quot;</span><span class="p">)</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="c1"># Format branches for evaluation</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">formatted_branches</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">formatted_branches</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## Branch </span><span class="si">{</span><span class="n">branch</span><span class="p">[</span><span class="s1">&#39;branch_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="n">formatted_branches</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Initial thoughts:</span><span class="se">\n</span><span class="si">{</span><span class="n">branch</span><span class="p">[</span><span class="s1">&#39;initial_thoughts&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                <span class="n">formatted_branches</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;step_number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="n">formatted_branches</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Conclusion: </span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conclusion&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="c1"># Format evaluation prompt</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="n">formatted_branches</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="p">}</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format evaluation prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="c1"># Run evaluation model</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">evaluation_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span><span class="p">,</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">evaluation_prompt</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span><span class="p">,</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">evaluation_prompt</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">evaluation_result</span><span class="p">,</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">evaluation_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;evaluator&quot;</span><span class="p">}</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="c1"># Default values in case evaluation_result is None</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="n">evaluation_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="k">if</span> <span class="n">evaluation_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="n">evaluation_text</span> <span class="o">=</span> <span class="n">evaluation_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>            <span class="c1"># Try to identify best branch</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">best_branch_id</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="n">branch_id</span> <span class="o">=</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;branch_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">evaluation_text</span> <span class="ow">and</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;best branch is </span><span class="si">{</span><span class="n">branch_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">evaluation_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>                         <span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="n">branch_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">evaluation_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                         <span class="sa">f</span><span class="s2">&quot;choose </span><span class="si">{</span><span class="n">branch_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">evaluation_text</span><span class="o">.</span><span class="n">lower</span><span class="p">())):</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                    <span class="n">best_branch_id</span> <span class="o">=</span> <span class="n">branch_id</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                    <span class="k">break</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="c1"># If explicit selection not found, look for branch numbers</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">best_branch_id</span> <span class="ow">and</span> <span class="n">evaluation_text</span><span class="p">:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                    <span class="n">branch_num</span> <span class="o">=</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;branch_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                    <span class="k">if</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;branch </span><span class="si">{</span><span class="n">branch_num</span><span class="si">}</span><span class="s2"> provides&quot;</span> <span class="ow">in</span> <span class="n">evaluation_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                            <span class="sa">f</span><span class="s2">&quot;branch </span><span class="si">{</span><span class="n">branch_num</span><span class="si">}</span><span class="s2"> is&quot;</span> <span class="ow">in</span> <span class="n">evaluation_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                        <span class="n">best_branch_id</span> <span class="o">=</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;branch_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                        <span class="k">break</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="c1"># Get best branch conclusion</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="n">best_branch_conclusion</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="k">if</span> <span class="n">best_branch_id</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                    <span class="k">if</span> <span class="n">branch</span><span class="p">[</span><span class="s2">&quot;branch_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">best_branch_id</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                        <span class="n">best_branch_conclusion</span> <span class="o">=</span> <span class="n">branch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conclusion&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                        <span class="k">break</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="c1"># If no best branch identified, use the evaluation text itself or first branch</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                <span class="k">if</span> <span class="n">evaluation_text</span><span class="p">:</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                    <span class="n">best_branch_conclusion</span> <span class="o">=</span> <span class="n">evaluation_text</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="k">elif</span> <span class="n">branches</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                    <span class="c1"># Fallback to first branch if no evaluation text</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                    <span class="n">best_branch_id</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;branch_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                    <span class="n">best_branch_conclusion</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conclusion&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="c1"># Safely extract confidence value</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">confidence_score</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># Default confidence</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>            <span class="k">if</span> <span class="n">evaluation_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evaluation_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                <span class="n">confidence_data</span> <span class="o">=</span> <span class="n">evaluation_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confidence_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">confidence_data</span><span class="p">:</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                    <span class="n">confidence_score</span> <span class="o">=</span> <span class="n">confidence_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confidence_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                    <span class="n">confidence_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">confidence_data</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>                <span class="s2">&quot;evaluation_text&quot;</span><span class="p">:</span> <span class="n">evaluation_text</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                <span class="s2">&quot;best_branch_id&quot;</span><span class="p">:</span> <span class="n">best_branch_id</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                <span class="s2">&quot;best_branch_conclusion&quot;</span><span class="p">:</span> <span class="n">best_branch_conclusion</span><span class="p">,</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span><span class="p">,</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                <span class="s2">&quot;raw_result&quot;</span><span class="p">:</span> <span class="n">evaluation_result</span><span class="p">,</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence_score</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>            <span class="p">}</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="c1"># More robust error handling to provide default values even on failure</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during branch evaluation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="c1"># Provide default fallback values</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="n">best_branch_id</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;branch_id&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">branches</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="n">best_branch_conclusion</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conclusion&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">branches</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                <span class="s2">&quot;evaluation_text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Evaluation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                <span class="s2">&quot;best_branch_id&quot;</span><span class="p">:</span> <span class="n">best_branch_id</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="s2">&quot;best_branch_conclusion&quot;</span><span class="p">:</span> <span class="n">best_branch_conclusion</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span><span class="p">,</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="s2">&quot;raw_result&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Lower confidence due to failure</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.ChainOfThoughtBranching.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the chain of thought branching phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\chain_of_thought.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the chain of thought branching phase.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="c1"># Get branch count</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_count&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid branch_count (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="s2">&quot;using default: 3&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># Get branch depth</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_depth&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid branch_depth (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="s2">&quot;using default: 2&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span> <span class="o">=</span> <span class="mi">2</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># Get template names</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_initial_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_template&quot;</span><span class="p">,</span> <span class="s2">&quot;cot_initial&quot;</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_branch_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_template&quot;</span><span class="p">,</span> <span class="s2">&quot;cot_branch&quot;</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_template&quot;</span><span class="p">,</span> <span class="s2">&quot;cot_evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="c1"># Get evaluation model (default to first model)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized ChainOfThoughtBranching phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_count</span><span class="si">}</span><span class="s2"> branches of depth </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.ChainOfThoughtBranching.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Chain of Thought Branching phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The final response after evaluating reasoning branches.
context: Updated context with branch information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\chain_of_thought.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Chain of Thought Branching phase.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            output: The final response after evaluating reasoning branches.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            context: Updated context with branch information.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="c1"># Step 1: Generate initial thoughts</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">initial_thoughts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_initial_thoughts</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="c1"># Step 2: Develop reasoning branches</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="n">branches</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_develop_branches</span><span class="p">(</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">initial_thoughts</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="c1"># Step 3: Evaluate branches</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_branches</span><span class="p">(</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="sa">f</span><span class="s2">&quot;ChainOfThoughtBranching phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">),</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_branch_depth</span><span class="p">}</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">},</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">initial_thoughts</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="n">branches</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="p">},</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="c1"># Get final output</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">final_output</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;best_branch_conclusion&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_output</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">final_output</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="c1"># Calculate confidence</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">final_output</span><span class="p">,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="s2">&quot;initial_thoughts&quot;</span><span class="p">:</span> <span class="n">initial_thoughts</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="s2">&quot;branches&quot;</span><span class="p">:</span> <span class="n">branches</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="p">}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="sa">f</span><span class="s2">&quot;ChainOfThoughtBranching phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.CompetitiveEvaluation" class="doc doc-heading">
            <code>CompetitiveEvaluation</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Competitive Evaluation collaboration phase.</p>
<p>Models are pitted against each other in a competition, with each evaluating
the others' outputs and a winner being determined.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\competitive_evaluation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">CompetitiveEvaluation</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Competitive Evaluation collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models are pitted against each other in a competition, with each evaluating</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    the others&#39; outputs and a winner being determined.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the competitive evaluation phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Get evaluation criteria</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_criteria&quot;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="p">])</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="c1"># Get competitors (default to all models)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_competitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;competitors&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># Get judge (default to first model)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;judge&quot;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="c1"># Get template names</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_competitor_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;competitor_template&quot;</span><span class="p">,</span> <span class="s2">&quot;competitor&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_template&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized CompetitiveEvaluation phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_competitors</span><span class="p">)</span><span class="si">}</span><span class="s2"> competitors and judge: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Competitive Evaluation phase.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">                output: The winning response.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">                context: Updated context with competition results.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="c1"># Step 1: Have competitors generate responses</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">competitor_responses</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_competitor_responses</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="c1"># Step 2: Judge evaluates the responses</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">evaluation_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_responses</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">competitor_responses</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="c1"># Step 3: Determine the winner</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">winner</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_winner</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">competitor_responses</span><span class="p">,</span> <span class="n">evaluation_results</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="sa">f</span><span class="s2">&quot;CompetitiveEvaluation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span> <span class="s2">&quot;competitors&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">competitor_responses</span><span class="p">)}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> 
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                        <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="p">},</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                        <span class="s2">&quot;competitor_responses&quot;</span><span class="p">:</span> <span class="n">competitor_responses</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                        <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                        <span class="s2">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                        <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="p">},</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Get winning response</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">winning_response</span> <span class="o">=</span> <span class="n">competitor_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">winning_response</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="s2">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="s2">&quot;competitor_responses&quot;</span><span class="p">:</span> <span class="n">competitor_responses</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Use winner&#39;s score as confidence</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="p">}</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="sa">f</span><span class="s2">&quot;CompetitiveEvaluation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_competitor_responses</span><span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate responses from all competitors.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            Dictionary mapping competitor IDs to their responses.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            CollaborationError: If generation fails.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating responses from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_competitors</span><span class="p">)</span><span class="si">}</span><span class="s2"> competitors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="c1"># Get competitor template</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_competitor_template</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="sa">f</span><span class="s2">&quot;No competitor template specified, using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;single_query&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_competitor_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="ow">or</span> <span class="s2">&quot;single_query&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="c1"># Format prompt</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">competitor_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_competitor_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format competitor prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="c1"># Run competitors</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">competitor_prompt</span><span class="p">,</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">model_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_competitors</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="c1"># Extract responses</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">competitor_responses</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">competitor_responses</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">return</span> <span class="n">competitor_responses</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_responses</span><span class="p">(</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">competitor_responses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate competitor responses using the judge.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">            competitor_responses: Responses from competitors.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">            Dictionary with evaluation results.</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">            CollaborationError: If evaluation fails.</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating competitor responses using judge: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="c1"># Check if judge is available</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No judge specified for evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="c1"># Format the responses for evaluation</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">formatted_responses</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">competitor_responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">formatted_responses</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## Response from Competitor </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="c1"># Create criteria string</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">criteria_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="c1"># Format evaluation prompt</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">formatted_responses</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="n">criteria_str</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="p">}</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="n">evaluation_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format evaluation prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="c1"># Run judge</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="n">judge_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">evaluation_prompt</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">evaluation_prompt</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">judge_results</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">judge_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                <span class="s2">&quot;evaluation_text&quot;</span><span class="p">:</span> <span class="n">judge_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="s2">&quot;judge_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="s2">&quot;raw_result&quot;</span><span class="p">:</span> <span class="n">judge_results</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="p">}</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to run judge evaluation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_winner</span><span class="p">(</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">competitor_responses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">evaluation_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the winner based on evaluation results.</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">            competitor_responses: Responses from competitors.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">            evaluation_results: Evaluation results from judge.</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">            Tuple of (winner_id, score_dict) where score_dict maps</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">            competitor IDs to their scores.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">            CollaborationError: If winner determination fails.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">evaluation_text</span> <span class="o">=</span> <span class="n">evaluation_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="c1"># Parse scores for each competitor</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="k">for</span> <span class="n">competitor_id</span> <span class="ow">in</span> <span class="n">competitor_responses</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="c1"># Look for score patterns for this competitor</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">score_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;(?:Competitor|Model|Response)\s+</span><span class="si">{</span><span class="n">competitor_id</span><span class="si">}</span><span class="s1">[^\d]*?(\d+(?:\.\d+)?)/10&#39;</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern</span><span class="p">,</span> <span class="n">evaluation_text</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                <span class="c1"># Found explicit score</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="n">scores</span><span class="p">[</span><span class="n">competitor_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">10.0</span>  <span class="c1"># Normalize to 0-1 range</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="c1"># Try alternative pattern (looking for overall rating)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="n">alt_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;(?:Competitor|Model|Response)\s+</span><span class="si">{</span><span class="n">competitor_id</span><span class="si">}</span><span class="s1">.*?overall.*?(\d+(?:\.\d+)?)/10&#39;</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">alt_pattern</span><span class="p">,</span> <span class="n">evaluation_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="n">scores</span><span class="p">[</span><span class="n">competitor_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">10.0</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                    <span class="c1"># No explicit score found, try to determine from text</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                    <span class="n">competitor_mentions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                        <span class="sa">rf</span><span class="s1">&#39;(?:Competitor|Model|Response)\s+</span><span class="si">{</span><span class="n">competitor_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                        <span class="n">evaluation_text</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                    <span class="p">))</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                    <span class="c1"># Set a default score based on mentions</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                    <span class="n">scores</span><span class="p">[</span><span class="n">competitor_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">competitor_mentions</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="c1"># Look for explicit winner declaration</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="n">winner_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?:winner|best|highest)[^\w]+(Competitor|Model|Response)\s+([a-zA-Z0-9_]+)&#39;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">winner_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">winner_pattern</span><span class="p">,</span> <span class="n">evaluation_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">if</span> <span class="n">winner_match</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="n">winner_id</span> <span class="o">=</span> <span class="n">winner_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="c1"># Ensure winner_id is a valid competitor</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">if</span> <span class="n">winner_id</span> <span class="ow">in</span> <span class="n">competitor_responses</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="c1"># Ensure winner has the highest score</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                <span class="n">scores</span><span class="p">[</span><span class="n">winner_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mf">0.1</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Declared winner &#39;</span><span class="si">{</span><span class="n">winner_id</span><span class="si">}</span><span class="s2">&#39; is not a valid competitor&quot;</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="c1"># If no scores were found, assign default scores</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">scores</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No scores could be extracted from evaluation text&quot;</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">competitor_id</span><span class="p">:</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">competitor_id</span> <span class="ow">in</span> <span class="n">competitor_responses</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="c1"># Determine winner (highest score)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">winner</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">scores</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">winner</span> <span class="ow">and</span> <span class="n">competitor_responses</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="c1"># Fallback to first competitor</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="n">winner</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">competitor_responses</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="k">return</span> <span class="n">winner</span><span class="p">,</span> <span class="n">scores</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.CompetitiveEvaluation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the competitive evaluation phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\competitive_evaluation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the competitive evaluation phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Get evaluation criteria</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_criteria&quot;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="p">])</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="c1"># Get competitors (default to all models)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_competitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;competitors&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="c1"># Get judge (default to first model)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;judge&quot;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_judge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="c1"># Get template names</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_competitor_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;competitor_template&quot;</span><span class="p">,</span> <span class="s2">&quot;competitor&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_template&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized CompetitiveEvaluation phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_competitors</span><span class="p">)</span><span class="si">}</span><span class="s2"> competitors and judge: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_judge</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.CompetitiveEvaluation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Competitive Evaluation phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The winning response.
context: Updated context with competition results.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\competitive_evaluation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Competitive Evaluation phase.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            output: The winning response.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            context: Updated context with competition results.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="c1"># Step 1: Have competitors generate responses</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">competitor_responses</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_competitor_responses</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="c1"># Step 2: Judge evaluates the responses</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">evaluation_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_responses</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">competitor_responses</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="c1"># Step 3: Determine the winner</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">winner</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_winner</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">competitor_responses</span><span class="p">,</span> <span class="n">evaluation_results</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="sa">f</span><span class="s2">&quot;CompetitiveEvaluation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span> <span class="s2">&quot;competitors&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">competitor_responses</span><span class="p">)}</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> 
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="p">},</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="s2">&quot;competitor_responses&quot;</span><span class="p">:</span> <span class="n">competitor_responses</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="s2">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="p">},</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="c1"># Get winning response</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">winning_response</span> <span class="o">=</span> <span class="n">competitor_responses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">winning_response</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="s2">&quot;winner&quot;</span><span class="p">:</span> <span class="n">winner</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="s2">&quot;competitor_responses&quot;</span><span class="p">:</span> <span class="n">competitor_responses</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="s2">&quot;evaluation_results&quot;</span><span class="p">:</span> <span class="n">evaluation_results</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Use winner&#39;s score as confidence</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="p">}</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="sa">f</span><span class="s2">&quot;CompetitiveEvaluation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.ExpertCommittee" class="doc doc-heading">
            <code>ExpertCommittee</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Expert Committee collaboration phase.</p>
<p>Final processing/structuring of model outputs before aggregation.
Organizes information and evaluates the quality of responses.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\expert_committee.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpertCommittee</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Expert Committee collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Final processing/structuring of model outputs before aggregation.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Organizes information and evaluates the quality of responses.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the expert committee phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Get committee-specific configuration</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;committee_type&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluative&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_criteria&quot;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="p">])</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format_output&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="c1"># Log configuration</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized Expert Committee phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="sa">f</span><span class="s2">&quot;type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span><span class="si">}</span><span class="s2">&#39; and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span><span class="p">)</span><span class="si">}</span><span class="s2"> criteria&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Expert Committee phase.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">                output: The committee&#39;s final output.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">                context: Updated context including evaluations and structured output.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                    <span class="sa">f</span><span class="s2">&quot;Expert Committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires inputs from &quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                    <span class="sa">f</span><span class="s2">&quot;previous phases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="c1"># Find the content to evaluate based on inputs and committee type</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">processing_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="c1"># If evaluative committee, perform evaluation</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span> <span class="o">==</span> <span class="s2">&quot;evaluative&quot;</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="n">evaluation_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_inputs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processing_results</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="n">processing_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">evaluation_results</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="c1"># If formatting is enabled, format the final output</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="n">formatted_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_final_output</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                    <span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processing_results</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="n">processing_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_output</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="sa">f</span><span class="s2">&quot;Expert Committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                    <span class="s2">&quot;committee_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="p">}</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="n">processing_results</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="k">return</span> <span class="n">processing_results</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="sa">f</span><span class="s2">&quot;Expert Committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_inputs</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process and organize inputs from previous phases.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">            Dictionary containing processing results.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">            CollaborationError: If processing fails.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="c1"># Get or create processing template</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="ow">or</span> <span class="s2">&quot;committee_processing&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="c1"># Prepare inputs for processing</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">organized_inputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="c1"># Convert inputs to a format suitable for the template</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_output</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="c1"># Direct string output</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="n">organized_inputs</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_output</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_output</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="c1"># Dictionary output - extract the most relevant field</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">in</span> <span class="n">phase_output</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="n">organized_inputs</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_output</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="k">elif</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">phase_output</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                    <span class="n">organized_inputs</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_output</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="k">elif</span> <span class="s2">&quot;response&quot;</span> <span class="ow">in</span> <span class="n">phase_output</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">organized_inputs</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_output</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="c1"># Try to find any string field</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">phase_output</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                            <span class="n">organized_inputs</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                            <span class="k">break</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="c1"># If no suitable output found, log warning</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">organized_inputs</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract output from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="c1"># Format prompt with organized inputs</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="c1"># Create a single combined input if there are multiple organized inputs</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">organized_inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="n">combined_input</span> <span class="o">=</span> <span class="s2">&quot;# Inputs from Previous Phases</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">organized_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                    <span class="n">combined_input</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;## From </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">combined_input</span><span class="p">}</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="c1"># Also add individual inputs</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">organized_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="n">context</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="c1"># Single input case</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="n">phase_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">organized_inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="n">content</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">organized_inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">processing_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format processing prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="c1"># Run processing models</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">processing_prompt</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="c1"># Process outputs</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">processed_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="n">processed_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="c1"># Determine the primary processed output</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">primary_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1"># Single model case</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">processed_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="c1"># Use the first model as primary</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">processed_outputs</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="n">processed_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="c1"># Fallback to first result</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">processed_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="c1"># Calculate confidence score (average from all models)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="c1"># Return processing results</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="s2">&quot;processed_outputs&quot;</span><span class="p">:</span> <span class="n">processed_outputs</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="s2">&quot;organized_inputs&quot;</span><span class="p">:</span> <span class="n">organized_inputs</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="p">}</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_inputs</span><span class="p">(</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">processing_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate inputs based on specified criteria.</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">            processing_results: Results from processing step.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">            Dictionary containing evaluation results.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">            CollaborationError: If evaluation fails.</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="c1"># Use a specific evaluation template if available</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">eval_template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_template&quot;</span><span class="p">,</span> <span class="s2">&quot;committee_evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="c1"># Get content to evaluate (priority: processed output &gt; inputs)</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">content_to_evaluate</span> <span class="o">=</span> <span class="n">processing_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_to_evaluate</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="c1"># Try to get from organized inputs</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="n">organized_inputs</span> <span class="o">=</span> <span class="n">processing_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;organized_inputs&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="k">if</span> <span class="n">organized_inputs</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="c1"># Combine all inputs</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">content_to_evaluate</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">organized_inputs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="c1"># If still no content, log warning and return empty results</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_to_evaluate</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No content to evaluate in committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="s2">&quot;evaluations&quot;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="s2">&quot;evaluation_summary&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="s2">&quot;overall_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="p">}</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="c1"># Format evaluation prompt</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="c1"># Create criteria string</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">criteria_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content_to_evaluate</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                <span class="s2">&quot;criteria&quot;</span><span class="p">:</span> <span class="n">criteria_str</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="p">}</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">eval_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">eval_template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format evaluation prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="c1"># Run evaluation models</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">eval_prompt</span><span class="p">,</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="c1"># Process outputs</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">eval_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">eval_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="c1"># Determine the primary evaluation output</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="n">eval_summary</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eval_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="c1"># Single model case</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">eval_summary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">eval_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="c1"># Use the first model as primary</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">eval_outputs</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                <span class="n">eval_summary</span> <span class="o">=</span> <span class="n">eval_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="c1"># Fallback to first result</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                <span class="n">eval_summary</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">eval_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="c1"># Parse scores from evaluation text</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">evaluations</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">overall_score</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="c1"># Try to extract scores for each criterion</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">for</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">score_pattern</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;(?i)</span><span class="si">{</span><span class="n">criterion</span><span class="si">}</span><span class="s1">[^\d]*?(\d+(?:\.\d+)?)/10&#39;</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">score_pattern</span><span class="p">,</span> <span class="n">eval_summary</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">10.0</span>  <span class="c1"># Normalize to 0-1 range</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="n">evaluations</span><span class="p">[</span><span class="n">criterion</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="c1"># Calculate overall score as average of individual scores</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="k">if</span> <span class="n">evaluations</span><span class="p">:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">overall_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">evaluations</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="c1"># Return evaluation results</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="s2">&quot;evaluations&quot;</span><span class="p">:</span> <span class="n">evaluations</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="s2">&quot;evaluation_summary&quot;</span><span class="p">:</span> <span class="n">eval_summary</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="s2">&quot;overall_score&quot;</span><span class="p">:</span> <span class="n">overall_score</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="s2">&quot;evaluation_outputs&quot;</span><span class="p">:</span> <span class="n">eval_outputs</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="p">}</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_format_final_output</span><span class="p">(</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format the final output based on processing and evaluation.</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">            results: Results from processing and evaluation.</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">            Formatted final output.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">            CollaborationError: If formatting fails.</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="c1"># Use a specific formatting template if available</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">format_template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formatting_template&quot;</span><span class="p">,</span> <span class="s2">&quot;committee_formatting&quot;</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="c1"># Get processed output and evaluation summary</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="n">processed_output</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">evaluation_summary</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_summary&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="c1"># If no processed output, return empty string</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">processed_output</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No processed output to format in committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="c1"># If no formatting template, just return the processed output</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">format_template_name</span><span class="p">):</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="k">return</span> <span class="n">processed_output</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="c1"># Format the output</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">processed_output</span><span class="p">,</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                <span class="s2">&quot;evaluation&quot;</span><span class="p">:</span> <span class="n">evaluation_summary</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="p">}</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>            <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">format_template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="c1"># Log warning and return unformatted output</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format output: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="k">return</span> <span class="n">processed_output</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="c1"># Run formatting models</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">formatted_prompt</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="c1"># Get the first result</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="k">if</span> <span class="n">model_results</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="n">first_model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">model_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="n">formatted_output</span> <span class="o">=</span> <span class="n">model_results</span><span class="p">[</span><span class="n">first_model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="k">return</span> <span class="n">formatted_output</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="c1"># Fallback to unformatted output</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="k">return</span> <span class="n">processed_output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.ExpertCommittee.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the expert committee phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\expert_committee.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the expert committee phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Get committee-specific configuration</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;committee_type&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluative&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;evaluation_criteria&quot;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;completeness&quot;</span><span class="p">,</span> <span class="s2">&quot;clarity&quot;</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="p">])</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format_output&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Log configuration</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized Expert Committee phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="sa">f</span><span class="s2">&quot;type &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span><span class="si">}</span><span class="s2">&#39; and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evaluation_criteria</span><span class="p">)</span><span class="si">}</span><span class="s2"> criteria&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.ExpertCommittee.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Expert Committee phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The committee's final output.
context: Updated context including evaluations and structured output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\expert_committee.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Expert Committee phase.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">            output: The committee&#39;s final output.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            context: Updated context including evaluations and structured output.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="sa">f</span><span class="s2">&quot;Expert Committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires inputs from &quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="sa">f</span><span class="s2">&quot;previous phases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="p">)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="c1"># Find the content to evaluate based on inputs and committee type</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">processing_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_inputs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="c1"># If evaluative committee, perform evaluation</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span> <span class="o">==</span> <span class="s2">&quot;evaluative&quot;</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="n">evaluation_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_inputs</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processing_results</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="n">processing_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">evaluation_results</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="c1"># If formatting is enabled, format the final output</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_output</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">formatted_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_final_output</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">processing_results</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">processing_results</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_output</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="sa">f</span><span class="s2">&quot;Expert Committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="s2">&quot;committee_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_committee_type</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="p">}</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="n">output_data</span><span class="o">=</span><span class="n">processing_results</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="k">return</span> <span class="n">processing_results</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="sa">f</span><span class="s2">&quot;Expert Committee phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.HierarchicalReview" class="doc doc-heading">
            <code>HierarchicalReview</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Hierarchical Review collaboration phase.</p>
<p>Content is progressively reviewed and refined by models in a hierarchical
structure, with specialists focusing on different aspects of the content.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\hierarchical_review.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalReview</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Hierarchical Review collaboration phase.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    Content is progressively reviewed and refined by models in a hierarchical</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    structure, with specialists focusing on different aspects of the content.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the hierarchical review phase.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="c1"># Get review levels and reviewers</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;review_levels&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="sa">f</span><span class="s2">&quot;No valid &#39;review_levels&#39; list specified for HierarchicalReview phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="s2">&quot;using default configuration based on available models.&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="c1"># Set default review levels based on available models</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="c1"># Ensure _model_ids is available from super().__init__</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="n">available_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_model_ids&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_models</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="c1"># Generate default levels only if models are available</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">if</span> <span class="n">num_models</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;technical_review&quot;</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                     <span class="c1"># Use first model</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                    <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">available_models</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;hierarchical_technical_review&quot;</span> <span class="c1"># Default template name</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="p">})</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="k">if</span> <span class="n">num_models</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;clarity_review&quot;</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                     <span class="c1"># Use second model</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                    <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">available_models</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;hierarchical_clarity_review&quot;</span> <span class="c1"># Default template name</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                 <span class="p">})</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="c1"># Require at least 3 models for a separate final refinement step</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="c1"># Otherwise, the previous step is effectively the final one</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="k">if</span> <span class="n">num_models</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                 <span class="n">refinement_model_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Use the last model</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                 <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;final_refinement&quot;</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                     <span class="c1"># Use last model</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">available_models</span><span class="p">[</span><span class="n">refinement_model_index</span><span class="p">]],</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;hierarchical_final_refinement&quot;</span> <span class="c1"># Default template name</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                 <span class="p">})</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create default review levels for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; as no models are assigned.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="c1"># Further validation of review levels structure</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="c1"># Allow phase to potentially run with no review levels if draft is generated,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="c1"># but log a warning. The execute method should handle this.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="sa">f</span><span class="s2">&quot;HierarchicalReview phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; has no review levels configured or generated. It might only produce a draft.&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="c1"># Validate each level&#39;s structure</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">all_level_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">phase_models_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="c1"># Models configured for the overall phase</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">model_manager_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model_ids</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                 <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; must be a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>             <span class="c1"># Ensure &#39;name&#39; exists and is a string</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>             <span class="n">level_name</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="n">level_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                  <span class="n">default_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;level_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> missing valid &#39;name&#39;, using default &#39;</span><span class="si">{</span><span class="n">default_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                  <span class="n">level</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_name</span> <span class="c1"># Assign default name back into the config dict for this instance</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>             <span class="c1"># Ensure &#39;models&#39; exists, is a list, and models are valid</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>             <span class="n">level_models</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_models</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                  <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; must have &#39;models&#39; as a list.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="n">level_models</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has an empty &#39;models&#39; list. It will be skipped.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>             <span class="c1"># Check if models in level exist in ModelManager</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>             <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">level_models</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                  <span class="k">if</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_manager_models</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                      <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; specified in review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not found in ModelManager.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                  <span class="n">all_level_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>             <span class="c1"># Ensure &#39;template&#39; exists and is a string</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>             <span class="n">level_template</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>             <span class="k">if</span> <span class="ow">not</span> <span class="n">level_template</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_template</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; missing &#39;template&#39; string. Will attempt fallback to phase default or named template.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                  <span class="c1"># No need to assign here, execute logic handles fallback</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="c1"># Check if models used in levels are actually available in *this phase&#39;s* config list</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">missing_in_phase_config</span> <span class="o">=</span> <span class="n">all_level_models</span> <span class="o">-</span> <span class="n">phase_models_set</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">if</span> <span class="n">missing_in_phase_config</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                 <span class="sa">f</span><span class="s2">&quot;Models </span><span class="si">{</span><span class="n">missing_in_phase_config</span><span class="si">}</span><span class="s2"> used in review_levels are not listed &quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                 <span class="sa">f</span><span class="s2">&quot;in the main &#39;models&#39; list (</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">phase_models_set</span><span class="p">)</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                 <span class="s2">&quot;Ensure these models are loaded by the ModelManager.&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>             <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>             <span class="c1"># This might be intentional (using models not explicitly listed for the phase), or an error.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized HierarchicalReview phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">)</span><span class="si">}</span><span class="s2"> review levels.&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Hierarchical Review phase.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">                output: The final reviewed and refined content.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">                reviews: Dictionary mapping level names to their outputs/status.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">                initial_content: The content before the review process started.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">                review_progression: List tracking content changes after each level.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">                confidence: Estimated confidence score for the final output.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="c1"># Get inputs from previous phases this phase depends on</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="c1"># Step 1: Get initial content to review (either from inputs or generate a draft)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">initial_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_content</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span> <span class="c1"># Pass tracer</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_content</span> <span class="ow">and</span> <span class="n">inputs</span><span class="p">:</span> <span class="c1"># If draft failed but inputs exist, maybe use first input?</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No draft generated for phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;, trying to use primary input.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                 <span class="c1"># Try to extract from the first input specified in &#39;input_from&#39;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                 <span class="n">primary_input_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                 <span class="k">if</span> <span class="n">primary_input_phase</span> <span class="ow">and</span> <span class="n">primary_input_phase</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                      <span class="n">input_val</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">primary_input_phase</span><span class="p">]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                      <span class="n">extracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_input_content</span><span class="p">(</span><span class="n">input_val</span><span class="p">)</span> <span class="c1"># Use helper</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                      <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                           <span class="n">initial_content</span> <span class="o">=</span> <span class="n">extracted</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                           <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using content from input phase &#39;</span><span class="si">{</span><span class="n">primary_input_phase</span><span class="si">}</span><span class="s2">&#39; as initial content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="c1"># Create review process context, starting with the initial content</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">review_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                <span class="s2">&quot;initial_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="s2">&quot;current_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span> <span class="c1"># This will be updated</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># Store output of each review step keyed by level name</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="o">**</span><span class="n">inputs</span> <span class="c1"># Include inputs from previous phases for template formatting</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="p">}</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="c1"># Track content changes (start with initial content)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">review_progression</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_content</span><span class="p">]</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="c1"># Check if there are any review levels to execute</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; has no review levels. Output will be the initial content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                 <span class="n">last_valid_output</span> <span class="o">=</span> <span class="n">initial_content</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                 <span class="c1"># Process each review level defined in the configuration</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                 <span class="n">last_valid_output</span> <span class="o">=</span> <span class="n">initial_content</span> <span class="c1"># Keep track of the last successful output</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                 <span class="k">for</span> <span class="n">level_idx</span><span class="p">,</span> <span class="n">level_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="n">level_name</span> <span class="o">=</span> <span class="n">level_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="c1"># Should exist due to __init__ validation</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="n">level_models</span> <span class="o">=</span> <span class="n">level_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="n">level_template</span> <span class="o">=</span> <span class="n">level_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">)</span> <span class="c1"># Template name for this level</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39; (Level </span><span class="si">{</span><span class="n">level_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                    <span class="c1"># If no models specified for this level, skip it</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">level_models</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No models specified for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                        <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no models&quot;</span><span class="p">}</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                        <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content doesn&#39;t change</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                    <span class="c1"># Determine the template name to use</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                    <span class="c1"># Priority: level-specific template &gt; phase default template &gt; constructed fallback</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="n">template_to_use</span> <span class="o">=</span> <span class="n">level_template</span> <span class="c1"># From level config</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">template_to_use</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                        <span class="n">template_to_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="c1"># From phase config (via Base class)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">template_to_use</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                         <span class="c1"># Construct a fallback template name if none specified anywhere</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                         <span class="n">template_to_use</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hierarchical_</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># e.g., hierarchical_technical_review</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No template specified for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;, trying fallback name &#39;</span><span class="si">{</span><span class="n">template_to_use</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="c1"># Format prompt for this review level, ensuring current content is passed</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">review_context</span><span class="p">}</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                        <span class="c1"># Ensure &#39;current_content&#39; key exists even if empty</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                        <span class="n">context</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;current_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                        <span class="c1"># Add a specific key for the content being reviewed *in this step* for clarity in templates</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;content_to_review&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">review_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                        <span class="c1"># Format using BaseCollaborationPhase method</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                        <span class="n">review_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_to_use</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">CollaborationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catch formatting or template errors</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39; using template &#39;</span><span class="si">{</span><span class="n">template_to_use</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping level.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                        <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;prompt formatting error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                        <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content doesn&#39;t change</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catch other unexpected formatting errors</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error formatting prompt for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                         <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;unexpected prompt error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                         <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                         <span class="k">continue</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                    <span class="c1"># Run the specified models for this review level</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                        <span class="c1"># Use _run_models which handles multiple models and tracing internally</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                        <span class="c1"># Pass role info for tracing</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                        <span class="n">level_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                            <span class="n">prompt</span><span class="o">=</span><span class="n">review_prompt</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                            <span class="n">model_ids</span><span class="o">=</span><span class="n">level_models</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                            <span class="n">role</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;reviewer_</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Add role context for tracing</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                        <span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                    <span class="k">except</span> <span class="p">(</span><span class="n">CollaborationError</span><span class="p">,</span> <span class="n">ModelError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to run models for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping level.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                         <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;model execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                         <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content doesn&#39;t change</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                         <span class="k">continue</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error running models for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                         <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;unexpected model error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                         <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                         <span class="k">continue</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                    <span class="c1"># --- Process outputs from the level&#39;s models ---</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="c1"># Extract text outputs from model results, handling potential errors</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="n">level_outputs_text</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="n">failed_models</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">level_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; failed during review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                                 <span class="n">failed_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                                 <span class="n">level_outputs_text</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected result type from model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                             <span class="n">failed_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                    <span class="c1"># Combine outputs if multiple models contributed *successfully* to this level</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                    <span class="n">successful_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">mid</span><span class="p">:</span> <span class="n">txt</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">level_outputs_text</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">mid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">failed_models</span> <span class="ow">and</span> <span class="n">txt</span><span class="p">}</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                    <span class="n">level_output_final</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Initialize final output for the level</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successful_outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> outputs for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                        <span class="c1"># Combine outputs with headers - simple concatenation for now</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                        <span class="n">combined_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# Combined Review/Refinement from Level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">output_text</span> <span class="ow">in</span> <span class="n">successful_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                            <span class="n">combined_output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;## Contribution from </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                        <span class="n">level_output_final</span> <span class="o">=</span> <span class="n">combined_output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># Use combined text</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                        <span class="c1"># Just use the single successful model&#39;s output text</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                        <span class="n">level_output_final</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">successful_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                        <span class="c1"># No valid successful outputs from this level</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid text output received from models for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;. Keeping previous content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                        <span class="n">level_output_final</span> <span class="o">=</span> <span class="n">last_valid_output</span> <span class="c1"># Keep the content from before this level</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                        <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no text output from models&quot;</span><span class="p">}</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                    <span class="c1"># Update &#39;current_content&#39; and store results *only if* new content was generated</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                    <span class="k">if</span> <span class="n">level_output_final</span> <span class="o">!=</span> <span class="n">last_valid_output</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                         <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                             <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                             <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">level_output_final</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                             <span class="s2">&quot;raw_model_results&quot;</span><span class="p">:</span> <span class="n">level_results</span> <span class="c1"># Store raw results too</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                         <span class="p">}</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                         <span class="c1"># Add role-specific key in context for easier access in subsequent steps/templates</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                         <span class="n">review_context</span><span class="p">[</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_output_final</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                         <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;current_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_output_final</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                         <span class="n">last_valid_output</span> <span class="o">=</span> <span class="n">level_output_final</span> <span class="c1"># Update tracker</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                         <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level_output_final</span><span class="p">)</span> <span class="c1"># Add to progression</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                         <span class="c1"># If content didn&#39;t change (e.g., no output), just record the status</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                         <span class="k">if</span> <span class="n">level_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">]:</span> <span class="c1"># Avoid overwriting previous status</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                              <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;no_change&quot;</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Output matched previous content or was empty.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                                    <span class="s2">&quot;raw_model_results&quot;</span><span class="p">:</span> <span class="n">level_results</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                              <span class="p">}</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                         <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content didn&#39;t change</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="c1"># --- Post-loop ---</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="sa">f</span><span class="s2">&quot;HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">)</span><span class="si">}</span><span class="s2"> levels in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="c1"># Calculate final confidence score (e.g., average confidence from the *last active* level)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="c1"># Default confidence</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">last_active_level_name</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="c1"># Find the last level that actually completed or resulted in no change</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>            <span class="k">for</span> <span class="n">level_config</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">):</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                 <span class="n">lname</span> <span class="o">=</span> <span class="n">level_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                 <span class="k">if</span> <span class="n">lname</span> <span class="ow">in</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">lname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;no_change&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                      <span class="n">last_active_level_name</span> <span class="o">=</span> <span class="n">lname</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                      <span class="k">break</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="k">if</span> <span class="n">last_active_level_name</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                 <span class="n">final_review_data</span> <span class="o">=</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">last_active_level_name</span><span class="p">]</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                 <span class="n">final_level_raw_results</span> <span class="o">=</span> <span class="n">final_review_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raw_model_results&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                 <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                 <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">final_level_raw_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                       <span class="c1"># Extract confidence from the result dict (using &#39;combined&#39; if available)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>                       <span class="n">model_conf</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span> <span class="c1"># Should be dict from run_inference</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_conf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                           <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="c1"># Use combined or 0</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                       <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                            <span class="c1"># Less likely, but handle direct score</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                           <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_conf</span><span class="p">))))</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                 <span class="k">if</span> <span class="n">confidence_values</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                     <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                <span class="c1"># Create output data, potentially trimming large fields</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                <span class="n">output_trace_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                     <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">last_valid_output</span><span class="p">,</span> <span class="c1"># Final content</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                     <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="n">review_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reviews&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1"># Status/outputs of levels</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                     <span class="s2">&quot;initial_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                     <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                     <span class="c1"># Consider not tracing full progression if very long</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                     <span class="c1"># &quot;review_progression&quot;: review_progression</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                <span class="p">}</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="c1"># Clean potentially large raw results from trace output</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="k">if</span> <span class="s2">&quot;reviews&quot;</span> <span class="ow">in</span> <span class="n">output_trace_data</span><span class="p">:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                     <span class="k">for</span> <span class="n">level_name</span><span class="p">,</span> <span class="n">level_data</span> <span class="ow">in</span> <span class="n">output_trace_data</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                          <span class="k">if</span> <span class="s2">&quot;raw_model_results&quot;</span> <span class="ow">in</span> <span class="n">level_data</span><span class="p">:</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                               <span class="n">level_data</span><span class="p">[</span><span class="s2">&quot;raw_model_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span> <span class="c1"># Placeholder</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())},</span> <span class="c1"># Initial inputs keys</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="n">output_trace_data</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="c1"># Include phase config (review levels etc.)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                <span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="c1"># Return the final results</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">last_valid_output</span><span class="p">,</span> <span class="c1"># The content after the last successful level</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="n">review_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reviews&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1"># Details of each level</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                <span class="s2">&quot;initial_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="s2">&quot;review_progression&quot;</span><span class="p">:</span> <span class="n">review_progression</span><span class="p">,</span> <span class="c1"># History of content state</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="p">}</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="k">except</span> <span class="n">CollaborationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>             <span class="c1"># Log and re-raise known collaboration errors</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collaboration error in HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>             <span class="k">raise</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="c1"># Catch-all for unexpected errors during execution</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="c1"># Wrap in CollaborationError for consistent handling upstream</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_initial_content</span><span class="p">(</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Added tracer</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get or generate the initial content to be reviewed by the hierarchy.</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a><span class="sd">            inputs: Inputs from previous phases (if specified by &#39;input_from&#39;).</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a><span class="sd">            String containing the initial content, or empty string if none found/generated.</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="c1"># --- Priority 1: Check if specified inputs already provide content ---</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="c1"># Use input_from defined in the phase config</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking inputs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="si">}</span><span class="s2"> for initial content...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="k">for</span> <span class="n">source_phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>                <span class="k">if</span> <span class="n">source_phase_name</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                    <span class="n">source_data</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">source_phase_name</span><span class="p">]</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                    <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_input_content</span><span class="p">(</span><span class="n">source_data</span><span class="p">)</span> <span class="c1"># Use helper</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                    <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using initial content from previous phase: &#39;</span><span class="si">{</span><span class="n">source_phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                         <span class="k">return</span> <span class="n">content</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No suitable initial content found in configured inputs.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="c1"># --- Priority 2: Generate a draft if configured ---</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="n">draft_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;draft_template&quot;</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="k">if</span> <span class="n">draft_template</span><span class="p">:</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to generate initial draft using template: &#39;</span><span class="si">{</span><span class="n">draft_template</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                <span class="c1"># Combine query and any available inputs for the draft prompt</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                <span class="c1"># Use render_template from Base Collaboration class</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                <span class="n">draft_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">draft_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="c1"># Determine which model(s) to use for drafting</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                <span class="n">draft_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;draft_model&quot;</span><span class="p">)</span> <span class="c1"># Explicit draft model?</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="n">draft_models</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                <span class="k">if</span> <span class="n">draft_model_id</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">draft_model_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                    <span class="c1"># Ensure specified draft model is managed</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                    <span class="k">if</span> <span class="n">draft_model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model_ids</span><span class="p">():</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                         <span class="n">draft_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">draft_model_id</span><span class="p">]</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specified draft_model &#39;</span><span class="si">{</span><span class="n">draft_model_id</span><span class="si">}</span><span class="s2">&#39; not found in ModelManager. Cannot use for drafting.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span> <span class="c1"># Use first model assigned to the phase?</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                    <span class="n">draft_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">draft_models</span><span class="p">:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No models specified or available for drafting in phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;. Cannot generate draft.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                    <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Cannot generate draft</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating draft using model(s): </span><span class="si">{</span><span class="n">draft_models</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                <span class="c1"># Run drafting model(s)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                <span class="c1"># *** FIX: Use await directly, remove asyncio.run() ***</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="c1"># Use _run_models from BaseCollaborationPhase</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                <span class="n">draft_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">draft_prompt</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                    <span class="n">model_ids</span><span class="o">=</span><span class="n">draft_models</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                    <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span><span class="p">,</span> <span class="c1"># Pass tracer</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                    <span class="n">role</span><span class="o">=</span><span class="s2">&quot;draft_generator&quot;</span> <span class="c1"># Add role for tracing</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                <span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>                <span class="c1"># Extract the first successful result&#39;s text</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                <span class="k">if</span> <span class="n">draft_results</span><span class="p">:</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">draft_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># Iterate to find first success</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                              <span class="n">draft_content</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                              <span class="k">if</span> <span class="n">draft_content</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                                   <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated initial draft using model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                                   <span class="k">return</span> <span class="n">draft_content</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                              <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                                   <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Draft generation by &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; resulted in empty content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                         <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                              <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Draft generation failed for model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                    <span class="c1"># If loop finishes without finding good content</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Draft generation ran but produced no valid content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Draft generation failed or returned no results.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">CollaborationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format or run draft generation using template &#39;</span><span class="si">{</span><span class="n">draft_template</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error generating draft content: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="c1"># --- Fallback: No content found or generated ---</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No initial content could be found or generated for HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;. Proceeding with empty content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_input_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to extract string content from various input types.&quot;&quot;&quot;</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">source_data</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>             <span class="c1"># Try common keys for output text</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">source_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                      <span class="n">source_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                      <span class="n">source_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span> <span class="ow">or</span> \
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                      <span class="n">source_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_output&quot;</span><span class="p">)</span> <span class="c1"># Add other likely keys</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="c1"># Add handling for other potential types if necessary</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="c1"># else: logger.debug(...)</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.HierarchicalReview.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the hierarchical review phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelManager (ai_ensemble_suite.models.ModelManager)" href="../models/#ai_ensemble_suite.models.ModelManager">ModelManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConfigManager (ai_ensemble_suite.config.ConfigManager)" href="../configuration/#ai_ensemble_suite.config.ConfigManager">ConfigManager</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\hierarchical_review.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the hierarchical review phase.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Get review levels and reviewers</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;review_levels&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="sa">f</span><span class="s2">&quot;No valid &#39;review_levels&#39; list specified for HierarchicalReview phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="s2">&quot;using default configuration based on available models.&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="c1"># Set default review levels based on available models</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="c1"># Ensure _model_ids is available from super().__init__</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">available_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_model_ids&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">num_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_models</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># Generate default levels only if models are available</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">if</span> <span class="n">num_models</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;technical_review&quot;</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                 <span class="c1"># Use first model</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">available_models</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;hierarchical_technical_review&quot;</span> <span class="c1"># Default template name</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="p">})</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="k">if</span> <span class="n">num_models</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>             <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;clarity_review&quot;</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>                 <span class="c1"># Use second model</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">available_models</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;hierarchical_clarity_review&quot;</span> <span class="c1"># Default template name</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>             <span class="p">})</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="c1"># Require at least 3 models for a separate final refinement step</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="c1"># Otherwise, the previous step is effectively the final one</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">if</span> <span class="n">num_models</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>             <span class="n">refinement_model_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Use the last model</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>             <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;final_refinement&quot;</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                 <span class="c1"># Use last model</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">available_models</span><span class="p">[</span><span class="n">refinement_model_index</span><span class="p">]],</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;hierarchical_final_refinement&quot;</span> <span class="c1"># Default template name</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>             <span class="p">})</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create default review levels for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; as no models are assigned.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="c1"># Further validation of review levels structure</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="c1"># Allow phase to potentially run with no review levels if draft is generated,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="c1"># but log a warning. The execute method should handle this.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="sa">f</span><span class="s2">&quot;HierarchicalReview phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; has no review levels configured or generated. It might only produce a draft.&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="c1"># Validate each level&#39;s structure</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">all_level_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">phase_models_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="c1"># Models configured for the overall phase</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">model_manager_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model_ids</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>             <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; must be a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>         <span class="c1"># Ensure &#39;name&#39; exists and is a string</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>         <span class="n">level_name</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>         <span class="k">if</span> <span class="ow">not</span> <span class="n">level_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>              <span class="n">default_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;level_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>              <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> missing valid &#39;name&#39;, using default &#39;</span><span class="si">{</span><span class="n">default_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>              <span class="n">level</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_name</span> <span class="c1"># Assign default name back into the config dict for this instance</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>         <span class="c1"># Ensure &#39;models&#39; exists, is a list, and models are valid</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>         <span class="n">level_models</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_models</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>              <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; must have &#39;models&#39; as a list.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>         <span class="k">if</span> <span class="ow">not</span> <span class="n">level_models</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>              <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; has an empty &#39;models&#39; list. It will be skipped.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>         <span class="c1"># Check if models in level exist in ModelManager</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>         <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">level_models</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>              <span class="k">if</span> <span class="n">model_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_manager_models</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                  <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; specified in review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; not found in ModelManager.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>              <span class="n">all_level_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>         <span class="c1"># Ensure &#39;template&#39; exists and is a string</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>         <span class="n">level_template</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>         <span class="k">if</span> <span class="ow">not</span> <span class="n">level_template</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level_template</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>              <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Review level &#39;</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; missing &#39;template&#39; string. Will attempt fallback to phase default or named template.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>              <span class="c1"># No need to assign here, execute logic handles fallback</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="c1"># Check if models used in levels are actually available in *this phase&#39;s* config list</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">missing_in_phase_config</span> <span class="o">=</span> <span class="n">all_level_models</span> <span class="o">-</span> <span class="n">phase_models_set</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">if</span> <span class="n">missing_in_phase_config</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>             <span class="sa">f</span><span class="s2">&quot;Models </span><span class="si">{</span><span class="n">missing_in_phase_config</span><span class="si">}</span><span class="s2"> used in review_levels are not listed &quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>             <span class="sa">f</span><span class="s2">&quot;in the main &#39;models&#39; list (</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">phase_models_set</span><span class="p">)</span><span class="si">}</span><span class="s2">) for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>             <span class="s2">&quot;Ensure these models are loaded by the ModelManager.&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>         <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>         <span class="c1"># This might be intentional (using models not explicitly listed for the phase), or an error.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized HierarchicalReview phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">)</span><span class="si">}</span><span class="s2"> review levels.&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.HierarchicalReview.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Hierarchical Review phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The final reviewed and refined content.
reviews: Dictionary mapping level names to their outputs/status.
initial_content: The content before the review process started.
review_progression: List tracking content changes after each level.
confidence: Estimated confidence score for the final output.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\hierarchical_review.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Hierarchical Review phase.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">            output: The final reviewed and refined content.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            reviews: Dictionary mapping level names to their outputs/status.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">            initial_content: The content before the review process started.</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">            review_progression: List tracking content changes after each level.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">            confidence: Estimated confidence score for the final output.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="c1"># Get inputs from previous phases this phase depends on</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># Step 1: Get initial content to review (either from inputs or generate a draft)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">initial_content</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_content</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span> <span class="c1"># Pass tracer</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_content</span> <span class="ow">and</span> <span class="n">inputs</span><span class="p">:</span> <span class="c1"># If draft failed but inputs exist, maybe use first input?</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No draft generated for phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;, trying to use primary input.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>             <span class="c1"># Try to extract from the first input specified in &#39;input_from&#39;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>             <span class="n">primary_input_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>             <span class="k">if</span> <span class="n">primary_input_phase</span> <span class="ow">and</span> <span class="n">primary_input_phase</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                  <span class="n">input_val</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">primary_input_phase</span><span class="p">]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                  <span class="n">extracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_input_content</span><span class="p">(</span><span class="n">input_val</span><span class="p">)</span> <span class="c1"># Use helper</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                  <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                       <span class="n">initial_content</span> <span class="o">=</span> <span class="n">extracted</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                       <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using content from input phase &#39;</span><span class="si">{</span><span class="n">primary_input_phase</span><span class="si">}</span><span class="s2">&#39; as initial content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="c1"># Create review process context, starting with the initial content</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">review_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="s2">&quot;initial_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="s2">&quot;current_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span> <span class="c1"># This will be updated</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1"># Store output of each review step keyed by level name</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="o">**</span><span class="n">inputs</span> <span class="c1"># Include inputs from previous phases for template formatting</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="p">}</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="c1"># Track content changes (start with initial content)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">review_progression</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_content</span><span class="p">]</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="c1"># Check if there are any review levels to execute</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; has no review levels. Output will be the initial content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>             <span class="n">last_valid_output</span> <span class="o">=</span> <span class="n">initial_content</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>             <span class="c1"># Process each review level defined in the configuration</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>             <span class="n">last_valid_output</span> <span class="o">=</span> <span class="n">initial_content</span> <span class="c1"># Keep track of the last successful output</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>             <span class="k">for</span> <span class="n">level_idx</span><span class="p">,</span> <span class="n">level_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="n">level_name</span> <span class="o">=</span> <span class="n">level_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="c1"># Should exist due to __init__ validation</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">level_models</span> <span class="o">=</span> <span class="n">level_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="n">level_template</span> <span class="o">=</span> <span class="n">level_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">)</span> <span class="c1"># Template name for this level</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39; (Level </span><span class="si">{</span><span class="n">level_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="c1"># If no models specified for this level, skip it</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">level_models</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No models specified for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;, skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                    <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;skipped&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no models&quot;</span><span class="p">}</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                    <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content doesn&#39;t change</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="c1"># Determine the template name to use</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="c1"># Priority: level-specific template &gt; phase default template &gt; constructed fallback</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="n">template_to_use</span> <span class="o">=</span> <span class="n">level_template</span> <span class="c1"># From level config</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">template_to_use</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="n">template_to_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="c1"># From phase config (via Base class)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">template_to_use</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                     <span class="c1"># Construct a fallback template name if none specified anywhere</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                     <span class="n">template_to_use</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hierarchical_</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># e.g., hierarchical_technical_review</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No template specified for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;, trying fallback name &#39;</span><span class="si">{</span><span class="n">template_to_use</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="c1"># Format prompt for this review level, ensuring current content is passed</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">review_context</span><span class="p">}</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                    <span class="c1"># Ensure &#39;current_content&#39; key exists even if empty</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                    <span class="n">context</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;current_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="c1"># Add a specific key for the content being reviewed *in this step* for clarity in templates</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;content_to_review&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">review_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;current_content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                    <span class="c1"># Format using BaseCollaborationPhase method</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="n">review_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_to_use</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">CollaborationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catch formatting or template errors</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39; using template &#39;</span><span class="si">{</span><span class="n">template_to_use</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping level.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;prompt formatting error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                    <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content doesn&#39;t change</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># Catch other unexpected formatting errors</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error formatting prompt for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                     <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;unexpected prompt error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                     <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                     <span class="k">continue</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="c1"># Run the specified models for this review level</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="c1"># Use _run_models which handles multiple models and tracing internally</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                    <span class="c1"># Pass role info for tracing</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                    <span class="n">level_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">review_prompt</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                        <span class="n">model_ids</span><span class="o">=</span><span class="n">level_models</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                        <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                        <span class="n">role</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;reviewer_</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Add role context for tracing</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                    <span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">CollaborationError</span><span class="p">,</span> <span class="n">ModelError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to run models for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping level.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                     <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;model execution error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                     <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content doesn&#39;t change</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                     <span class="k">continue</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error running models for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                     <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;unexpected model error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                     <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                     <span class="k">continue</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="c1"># --- Process outputs from the level&#39;s models ---</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="c1"># Extract text outputs from model results, handling potential errors</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="n">level_outputs_text</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="n">failed_models</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">level_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; failed during review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                             <span class="n">failed_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                             <span class="n">level_outputs_text</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected result type from model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39; for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                         <span class="n">failed_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                <span class="c1"># Combine outputs if multiple models contributed *successfully* to this level</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="n">successful_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">mid</span><span class="p">:</span> <span class="n">txt</span> <span class="k">for</span> <span class="n">mid</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">level_outputs_text</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">mid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">failed_models</span> <span class="ow">and</span> <span class="n">txt</span><span class="p">}</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                <span class="n">level_output_final</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># Initialize final output for the level</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combining </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successful_outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> outputs for level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                    <span class="c1"># Combine outputs with headers - simple concatenation for now</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                    <span class="n">combined_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# Combined Review/Refinement from Level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">output_text</span> <span class="ow">in</span> <span class="n">successful_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                        <span class="n">combined_output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;## Contribution from </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="n">level_output_final</span> <span class="o">=</span> <span class="n">combined_output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># Use combined text</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                    <span class="c1"># Just use the single successful model&#39;s output text</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                    <span class="n">level_output_final</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">successful_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                    <span class="c1"># No valid successful outputs from this level</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid text output received from models for review level &#39;</span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&#39;. Keeping previous content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                    <span class="n">level_output_final</span> <span class="o">=</span> <span class="n">last_valid_output</span> <span class="c1"># Keep the content from before this level</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                    <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no text output from models&quot;</span><span class="p">}</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                <span class="c1"># Update &#39;current_content&#39; and store results *only if* new content was generated</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                <span class="k">if</span> <span class="n">level_output_final</span> <span class="o">!=</span> <span class="n">last_valid_output</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                     <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                         <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                         <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">level_output_final</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                         <span class="s2">&quot;raw_model_results&quot;</span><span class="p">:</span> <span class="n">level_results</span> <span class="c1"># Store raw results too</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                     <span class="p">}</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                     <span class="c1"># Add role-specific key in context for easier access in subsequent steps/templates</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                     <span class="n">review_context</span><span class="p">[</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_output_final</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                     <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;current_content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_output_final</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                     <span class="n">last_valid_output</span> <span class="o">=</span> <span class="n">level_output_final</span> <span class="c1"># Update tracker</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                     <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level_output_final</span><span class="p">)</span> <span class="c1"># Add to progression</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                     <span class="c1"># If content didn&#39;t change (e.g., no output), just record the status</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                     <span class="k">if</span> <span class="n">level_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">]:</span> <span class="c1"># Avoid overwriting previous status</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                          <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">level_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;no_change&quot;</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Output matched previous content or was empty.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                                <span class="s2">&quot;raw_model_results&quot;</span><span class="p">:</span> <span class="n">level_results</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                          <span class="p">}</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                     <span class="n">review_progression</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_valid_output</span><span class="p">)</span> <span class="c1"># Content didn&#39;t change</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="c1"># --- Post-loop ---</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="sa">f</span><span class="s2">&quot;HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">)</span><span class="si">}</span><span class="s2"> levels in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="c1"># Calculate final confidence score (e.g., average confidence from the *last active* level)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="c1"># Default confidence</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">last_active_level_name</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="c1"># Find the last level that actually completed or resulted in no change</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">for</span> <span class="n">level_config</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_review_levels</span><span class="p">):</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>             <span class="n">lname</span> <span class="o">=</span> <span class="n">level_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>             <span class="k">if</span> <span class="n">lname</span> <span class="ow">in</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">lname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;no_change&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                  <span class="n">last_active_level_name</span> <span class="o">=</span> <span class="n">lname</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                  <span class="k">break</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="k">if</span> <span class="n">last_active_level_name</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>             <span class="n">final_review_data</span> <span class="o">=</span> <span class="n">review_context</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">][</span><span class="n">last_active_level_name</span><span class="p">]</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>             <span class="n">final_level_raw_results</span> <span class="o">=</span> <span class="n">final_review_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raw_model_results&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>             <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>             <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">final_level_raw_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                   <span class="c1"># Extract confidence from the result dict (using &#39;combined&#39; if available)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>                   <span class="n">model_conf</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">)</span> <span class="c1"># Should be dict from run_inference</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                   <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_conf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                       <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="c1"># Use combined or 0</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                   <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_conf</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                        <span class="c1"># Less likely, but handle direct score</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>                       <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_conf</span><span class="p">))))</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>             <span class="k">if</span> <span class="n">confidence_values</span><span class="p">:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                 <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="c1"># Create output data, potentially trimming large fields</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="n">output_trace_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                 <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">last_valid_output</span><span class="p">,</span> <span class="c1"># Final content</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                 <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="n">review_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reviews&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1"># Status/outputs of levels</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                 <span class="s2">&quot;initial_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                 <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                 <span class="c1"># Consider not tracing full progression if very long</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                 <span class="c1"># &quot;review_progression&quot;: review_progression</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="p">}</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="c1"># Clean potentially large raw results from trace output</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="k">if</span> <span class="s2">&quot;reviews&quot;</span> <span class="ow">in</span> <span class="n">output_trace_data</span><span class="p">:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                 <span class="k">for</span> <span class="n">level_name</span><span class="p">,</span> <span class="n">level_data</span> <span class="ow">in</span> <span class="n">output_trace_data</span><span class="p">[</span><span class="s2">&quot;reviews&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                      <span class="k">if</span> <span class="s2">&quot;raw_model_results&quot;</span> <span class="ow">in</span> <span class="n">level_data</span><span class="p">:</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                           <span class="n">level_data</span><span class="p">[</span><span class="s2">&quot;raw_model_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span> <span class="c1"># Placeholder</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())},</span> <span class="c1"># Initial inputs keys</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                <span class="n">output_data</span><span class="o">=</span><span class="n">output_trace_data</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="c1"># Include phase config (review levels etc.)</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="p">)</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="c1"># Return the final results</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">last_valid_output</span><span class="p">,</span> <span class="c1"># The content after the last successful level</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>            <span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="n">review_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reviews&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="c1"># Details of each level</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="s2">&quot;initial_content&quot;</span><span class="p">:</span> <span class="n">initial_content</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="s2">&quot;review_progression&quot;</span><span class="p">:</span> <span class="n">review_progression</span><span class="p">,</span> <span class="c1"># History of content state</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="p">}</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="k">except</span> <span class="n">CollaborationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>         <span class="c1"># Log and re-raise known collaboration errors</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collaboration error in HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>         <span class="k">raise</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="c1"># Catch-all for unexpected errors during execution</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="c1"># Wrap in CollaborationError for consistent handling upstream</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HierarchicalReview phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed unexpectedly: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.Integration" class="doc doc-heading">
            <code>Integration</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Integration/Refinement collaboration phase.</p>
<p>Models refine responses based on feedback and insights from previous phases,
integrating multiple perspectives into a coherent response.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\integration.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">Integration</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration/Refinement collaboration phase.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Models refine responses based on feedback and insights from previous phases,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    integrating multiple perspectives into a coherent response.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Integration phase.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">                output: The integrated/refined response.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">                context: Updated context for the next phase.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                    <span class="sa">f</span><span class="s2">&quot;Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires inputs from &quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                    <span class="sa">f</span><span class="s2">&quot;previous phases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="c1"># Get prompt template or use default integration prompt</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                    <span class="sa">f</span><span class="s2">&quot;No prompt template specified for Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                    <span class="s2">&quot;using default integration prompt&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="o">=</span> <span class="s2">&quot;refinement&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="c1"># Format prompt with query and inputs</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="n">integration_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format integration prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="c1"># Run models</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">integration_prompt</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="c1"># Process outputs</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">integrated_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="n">integrated_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="c1"># Determine the primary integrated output</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="n">primary_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">integrated_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="c1"># Single model case</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">integrated_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="c1"># Use the first model as primary</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">integrated_outputs</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                    <span class="n">primary_output</span> <span class="o">=</span> <span class="n">integrated_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                    <span class="c1"># Fallback to first result</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                    <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">integrated_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="sa">f</span><span class="s2">&quot;Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                    <span class="s2">&quot;model_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_results</span><span class="p">),</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="p">}</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">integration_prompt</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">integrated_outputs</span><span class="p">,</span> <span class="s2">&quot;primary_output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">},</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="c1"># Calculate confidence score (average from all models)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                        <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                        <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="s2">&quot;integrated_outputs&quot;</span><span class="p">:</span> <span class="n">integrated_outputs</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="p">}</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="sa">f</span><span class="s2">&quot;Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.Integration.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Integration phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The integrated/refined response.
context: Updated context for the next phase.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\integration.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Integration phase.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            output: The integrated/refined response.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            context: Updated context for the next phase.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># Validate inputs</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="sa">f</span><span class="s2">&quot;Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; requires inputs from &quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="sa">f</span><span class="s2">&quot;previous phases: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_from</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="c1"># Get prompt template or use default integration prompt</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                <span class="sa">f</span><span class="s2">&quot;No prompt template specified for Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="s2">&quot;using default integration prompt&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span> <span class="o">=</span> <span class="s2">&quot;refinement&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="c1"># Format prompt with query and inputs</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="n">integration_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format integration prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># Run models</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">integration_prompt</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="c1"># Process outputs</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">integrated_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">integrated_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="c1"># Determine the primary integrated output</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">primary_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">integrated_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="c1"># Single model case</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">integrated_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="c1"># Use the first model as primary</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">integrated_outputs</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="n">integrated_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="c1"># Fallback to first result</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="n">primary_output</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">integrated_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="sa">f</span><span class="s2">&quot;Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="s2">&quot;model_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_results</span><span class="p">),</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="p">}</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">integration_prompt</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">integrated_outputs</span><span class="p">,</span> <span class="s2">&quot;primary_output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">},</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="c1"># Calculate confidence score (average from all models)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">primary_output</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="s2">&quot;integrated_outputs&quot;</span><span class="p">:</span> <span class="n">integrated_outputs</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="p">}</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="sa">f</span><span class="s2">&quot;Integration phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.PerspectiveRotation" class="doc doc-heading">
            <code>PerspectiveRotation</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Perspective Rotation collaboration phase.</p>
<p>Models iterate on a problem by assuming different perspectives
or stakeholder viewpoints in sequence.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\perspective_rotation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">PerspectiveRotation</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Perspective Rotation collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models iterate on a problem by assuming different perspectives</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    or stakeholder viewpoints in sequence.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the perspective rotation phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Get perspectives to rotate through</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perspectives&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="c1"># If no perspectives defined, use default set</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="s2">&quot;technical&quot;</span><span class="p">,</span> <span class="s2">&quot;ethical&quot;</span><span class="p">,</span> <span class="s2">&quot;practical&quot;</span><span class="p">,</span> <span class="s2">&quot;creative&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                <span class="sa">f</span><span class="s2">&quot;No perspectives specified for PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="sa">f</span><span class="s2">&quot;using defaults: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="c1"># Get template name</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_perspective_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perspective_template&quot;</span><span class="p">,</span> <span class="s2">&quot;perspective&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="c1"># Get synthesis template</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesis_template&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># Get synthesis model (default to first model)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesis_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)</span><span class="si">}</span><span class="s2"> perspectives&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Perspective Rotation phase.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">                output: The synthesized response.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">                context: Updated context with perspectives and synthesis.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="c1"># Step 1: Generate responses from each perspective</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">perspective_responses</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_perspective_responses</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="c1"># Step 2: Synthesize the perspectives</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">synthesis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_perspectives</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="n">query</span><span class="p">,</span> <span class="n">perspective_responses</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="sa">f</span><span class="s2">&quot;PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perspectives&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)}</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">},</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                        <span class="s2">&quot;perspective_responses&quot;</span><span class="p">:</span> <span class="n">perspective_responses</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                        <span class="s2">&quot;synthesis&quot;</span><span class="p">:</span> <span class="n">synthesis</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="p">},</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Calculate confidence score</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="n">synthesis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">synthesis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="s2">&quot;perspective_responses&quot;</span><span class="p">:</span> <span class="n">perspective_responses</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="s2">&quot;synthesis&quot;</span><span class="p">:</span> <span class="n">synthesis</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="s2">&quot;perspectives&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="p">}</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="sa">f</span><span class="s2">&quot;PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_generate_perspective_responses</span><span class="p">(</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate responses from each perspective.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            Dictionary mapping perspective names to their responses.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            CollaborationError: If generation fails.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating responses from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)</span><span class="si">}</span><span class="s2"> perspectives&quot;</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="c1"># Distribute models across perspectives</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">):</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="c1"># If we have enough models, assign one per perspective</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="n">model_assignments</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="n">perspective</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)]</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">perspective</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="p">}</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="c1"># Otherwise, use available models in rotation</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">model_assignments</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="n">perspective</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">)]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">perspective</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="p">}</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="c1"># Generate response for each perspective</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">perspective_responses</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">for</span> <span class="n">perspective</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="c1"># Get template (try perspective-specific first, then default)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">template_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">perspective</span><span class="si">}</span><span class="s2">_perspective&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">):</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="n">template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perspective_template</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="c1"># Format prompt</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="s2">&quot;perspective&quot;</span><span class="p">:</span> <span class="n">perspective</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="o">**</span><span class="n">inputs</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="p">}</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="n">perspective_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt for perspective &#39;</span><span class="si">{</span><span class="n">perspective</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                <span class="k">continue</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="c1"># Get model for this perspective</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">model_id</span> <span class="o">=</span> <span class="n">model_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">perspective</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_id</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model assigned for perspective &#39;</span><span class="si">{</span><span class="n">perspective</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="k">continue</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="c1"># Run model</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="n">model_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">perspective_prompt</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="c1"># Extract response</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="n">perspective_responses</span><span class="p">[</span><span class="n">perspective</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                    <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                        <span class="n">input_prompt</span><span class="o">=</span><span class="n">perspective_prompt</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                        <span class="n">output</span><span class="o">=</span><span class="n">model_result</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                        <span class="n">execution_time</span><span class="o">=</span><span class="n">model_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perspective&quot;</span><span class="p">:</span> <span class="n">perspective</span><span class="p">}</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate response for perspective &#39;</span><span class="si">{</span><span class="n">perspective</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">return</span> <span class="n">perspective_responses</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_synthesize_perspectives</span><span class="p">(</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">perspective_responses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synthesize the perspectives into a final response.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            query: The user query.</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">            perspective_responses: Responses from different perspectives.</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            Dictionary containing synthesis results.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">            CollaborationError: If synthesis fails.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Synthesizing perspectives&quot;</span><span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="c1"># Check if synthesis model is available</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span><span class="p">:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No synthesis model specified&quot;</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="c1"># Format perspectives for synthesis</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">formatted_perspectives</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="k">for</span> <span class="n">perspective</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">perspective_responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">formatted_perspectives</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## </span><span class="si">{</span><span class="n">perspective</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Perspective</span><span class="se">\n\n</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="c1"># Format synthesis prompt</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="s2">&quot;perspectives&quot;</span><span class="p">:</span> <span class="n">formatted_perspectives</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="p">}</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">synthesis_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format synthesis prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="c1"># Run synthesis model</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="n">synthesis_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">synthesis_prompt</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">synthesis_prompt</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">synthesis_result</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">synthesis_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;synthesizer&quot;</span><span class="p">}</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="k">return</span> <span class="n">synthesis_result</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to synthesize perspectives: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.PerspectiveRotation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the perspective rotation phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\perspective_rotation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the perspective rotation phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Get perspectives to rotate through</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perspectives&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># If no perspectives defined, use default set</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="s2">&quot;technical&quot;</span><span class="p">,</span> <span class="s2">&quot;ethical&quot;</span><span class="p">,</span> <span class="s2">&quot;practical&quot;</span><span class="p">,</span> <span class="s2">&quot;creative&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="p">]</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="sa">f</span><span class="s2">&quot;No perspectives specified for PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="sa">f</span><span class="s2">&quot;using defaults: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="c1"># Get template name</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_perspective_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perspective_template&quot;</span><span class="p">,</span> <span class="s2">&quot;perspective&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="c1"># Get synthesis template</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesis_template&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesis&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="c1"># Get synthesis model (default to first model)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesis_model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_synthesis_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)</span><span class="si">}</span><span class="s2"> perspectives&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.PerspectiveRotation.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Perspective Rotation phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The synthesized response.
context: Updated context with perspectives and synthesis.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\perspective_rotation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Perspective Rotation phase.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            output: The synthesized response.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            context: Updated context with perspectives and synthesis.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="c1"># Step 1: Generate responses from each perspective</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">perspective_responses</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_perspective_responses</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="c1"># Step 2: Synthesize the perspectives</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">synthesis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_perspectives</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">query</span><span class="p">,</span> <span class="n">perspective_responses</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="sa">f</span><span class="s2">&quot;PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;perspectives&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">)}</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">},</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="s2">&quot;perspective_responses&quot;</span><span class="p">:</span> <span class="n">perspective_responses</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="s2">&quot;synthesis&quot;</span><span class="p">:</span> <span class="n">synthesis</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="p">},</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="c1"># Calculate confidence score</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="n">synthesis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">synthesis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="s2">&quot;perspective_responses&quot;</span><span class="p">:</span> <span class="n">perspective_responses</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="s2">&quot;synthesis&quot;</span><span class="p">:</span> <span class="n">synthesis</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="s2">&quot;perspectives&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perspectives</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="p">}</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="sa">f</span><span class="s2">&quot;PerspectiveRotation phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.RoleBasedDebate" class="doc doc-heading">
            <code>RoleBasedDebate</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDebate (ai_ensemble_suite.collaboration.structured_debate.base_debate.BaseDebate)" href="#ai_ensemble_suite.collaboration.BaseDebate">BaseDebate</a></code></p>


        <p>Role-Based Debate pattern.</p>
<p>Models interact according to assigned specialized roles such as
Critic, Advocate, Synthesizer, and Fact-Checker.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\role_based.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">RoleBasedDebate</span><span class="p">(</span><span class="n">BaseDebate</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Role-Based Debate pattern.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models interact according to assigned specialized roles such as</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Critic, Advocate, Synthesizer, and Fact-Checker.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the role-based debate phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Get role assignments</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role_assignments&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="c1"># If no explicit role assignments, try to use model roles</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_use_model_roles</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                <span class="sa">f</span><span class="s2">&quot;No explicit role assignments for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                <span class="s2">&quot;will use model roles&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_use_model_roles</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="sa">f</span><span class="s2">&quot;Using explicit role assignments for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="c1"># Get debate turn order (optional)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;turn_order&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="c1"># Get standard roles if not explicitly configured</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;critic&quot;</span><span class="p">,</span> <span class="s2">&quot;advocate&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesizer&quot;</span><span class="p">,</span> <span class="s2">&quot;fact_checker&quot;</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default turn order for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="c1"># Get role-specific prompt templates</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_role_templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role_templates&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_debate_pattern</span><span class="p">(</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">initial_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the role-based debate pattern.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            initial_response: The initial response to debate.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            Dictionary containing debate results.</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            CollaborationError: If execution fails.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="c1"># Map models to roles</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">role_to_models</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map_roles_to_models</span><span class="p">()</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="c1"># If no roles mapped to models, raise an error</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">role_to_models</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="sa">f</span><span class="s2">&quot;Role-based debate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; has no valid role-model mappings&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="c1"># Start with the initial context</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">debate_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="s2">&quot;exchanges&quot;</span><span class="p">:</span> <span class="p">[]</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="p">}</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="c1"># Add inputs from previous phases</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">debate_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="c1"># Execute debate rounds</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="k">for</span> <span class="n">round_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting debate round </span><span class="si">{</span><span class="n">round_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rounds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="c1"># Process each role in turn order</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="c1"># Skip if no models assigned to this role</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_to_models</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">role_to_models</span><span class="p">[</span><span class="n">role</span><span class="p">]:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping role &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39; (no models assigned)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="c1"># Get the template for this role</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template_for_role</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">template_name</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                        <span class="sa">f</span><span class="s2">&quot;No template found for role &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39;, using default template&quot;</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                    <span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                    <span class="n">template_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="c1"># If still no template, skip this role</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">template_name</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping role &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39; (no template available)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="c1"># Format prompt for this role</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                    <span class="n">role_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">debate_context</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt for role &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="c1"># Run models for this role</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="n">models_for_role</span> <span class="o">=</span> <span class="n">role_to_models</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">role_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">role_prompt</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                    <span class="n">model_ids</span><span class="o">=</span><span class="n">models_for_role</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                    <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="c1"># Process outputs</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="n">responses</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">role_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="n">responses</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="c1"># Combine responses if multiple models for this role</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="n">combined_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# Combined </span><span class="si">{</span><span class="n">role</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Perspective</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                        <span class="n">combined_response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;## From </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                    <span class="n">role_response</span> <span class="o">=</span> <span class="n">combined_response</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="k">elif</span> <span class="n">responses</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                    <span class="c1"># Just use the single response</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                    <span class="n">role_response</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                    <span class="n">role_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="c1"># Add to exchanges</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="k">if</span> <span class="n">role_response</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                    <span class="n">debate_context</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">role_response</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                        <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="n">round_num</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="p">})</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                    <span class="c1"># Also add role-specific key in context</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="n">debate_context</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">_perspective&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">role_response</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                    <span class="c1"># Update for the next role</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="n">debate_context</span><span class="p">[</span><span class="s2">&quot;latest_exchange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">role_response</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="c1"># Determine the final output</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">final_perspective</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="c1"># Prioritize the synthesizer role if present</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">if</span> <span class="s2">&quot;synthesizer_perspective&quot;</span> <span class="ow">in</span> <span class="n">debate_context</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="n">final_perspective</span> <span class="o">=</span> <span class="n">debate_context</span><span class="p">[</span><span class="s2">&quot;synthesizer_perspective&quot;</span><span class="p">]</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Otherwise use the last exchange</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">elif</span> <span class="n">debate_context</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">final_perspective</span> <span class="o">=</span> <span class="n">debate_context</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="c1"># Calculate confidence (average from all model results across all roles)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">all_confidences</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">role_models</span> <span class="ow">in</span> <span class="n">role_to_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">role_models</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                <span class="c1"># Find all results for this model</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="k">for</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="n">debate_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exchanges&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="k">if</span> <span class="n">exchange</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">role</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                        <span class="c1"># Look for confidence in the raw results</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                        <span class="k">for</span> <span class="n">round_results</span> <span class="ow">in</span> <span class="n">exchange</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raw_results&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">round_results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">round_results</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">round_results</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">round_results</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                                    <span class="n">all_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">round_results</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">round_results</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                                    <span class="n">all_confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">round_results</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">all_confidences</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_confidences</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_confidences</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">final_perspective</span><span class="p">,</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="s2">&quot;final_perspective&quot;</span><span class="p">:</span> <span class="n">final_perspective</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="s2">&quot;exchanges&quot;</span><span class="p">:</span> <span class="n">debate_context</span><span class="p">[</span><span class="s2">&quot;exchanges&quot;</span><span class="p">],</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="s2">&quot;role_perspectives&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">role</span><span class="p">:</span> <span class="n">debate_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">_perspective&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">role_to_models</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="p">},</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="p">}</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_map_roles_to_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Map roles to model IDs based on configuration.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">            Dictionary mapping role names to lists of model IDs.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">            CollaborationError: If role mapping fails.</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">role_to_models</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="c1"># Check if using explicit role assignments</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_model_roles</span><span class="p">:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="c1"># Use explicit assignments from configuration</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">model_ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="c1"># Single model ID</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">role_to_models</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_ids</span><span class="p">]</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                    <span class="c1"># List of model IDs</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                    <span class="n">role_to_models</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_ids</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="k">return</span> <span class="n">role_to_models</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="c1"># Otherwise use model roles</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="n">role</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_role</span><span class="p">()</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="k">if</span> <span class="n">role</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                    <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_to_models</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                        <span class="n">role_to_models</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                    <span class="n">role_to_models</span><span class="p">[</span><span class="n">role</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get role for model &#39;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="k">return</span> <span class="n">role_to_models</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_template_for_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the template name for a specific role.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">            role: The role to get template for.</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">            Template name or None if not found.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="c1"># First check role-specific templates in this phase&#39;s config</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role_templates</span> <span class="ow">and</span> <span class="n">role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role_templates</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role_templates</span><span class="p">[</span><span class="n">role</span><span class="p">]</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="c1"># Then check for a template with the role name</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">role_template_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">_template&quot;</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">if</span> <span class="n">role_template_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">role_template_name</span><span class="p">]</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="c1"># Then look for a standard template with the role name pattern</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">standard_template</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;role_</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_manager</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">standard_template</span><span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="k">return</span> <span class="n">standard_template</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="c1"># Fall back to the default prompt template</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.RoleBasedDebate.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the role-based debate phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\role_based.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the role-based debate phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Get role assignments</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role_assignments&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># If no explicit role assignments, try to use model roles</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_use_model_roles</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="sa">f</span><span class="s2">&quot;No explicit role assignments for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="s2">&quot;will use model roles&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_use_model_roles</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="sa">f</span><span class="s2">&quot;Using explicit role assignments for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;: &quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_role_assignments</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="c1"># Get debate turn order (optional)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;turn_order&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="c1"># Get standard roles if not explicitly configured</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_turn_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;critic&quot;</span><span class="p">,</span> <span class="s2">&quot;advocate&quot;</span><span class="p">,</span> <span class="s2">&quot;synthesizer&quot;</span><span class="p">,</span> <span class="s2">&quot;fact_checker&quot;</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default turn order for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="c1"># Get role-specific prompt templates</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_role_templates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role_templates&quot;</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.RoleBasedWorkflow" class="doc doc-heading">
            <code>RoleBasedWorkflow</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Role-Based Workflow collaboration phase.</p>
<p>Models function in specialized roles like researcher, analyst,
and writer to create a structured workflow for complex tasks.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\role_based_workflow.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">RoleBasedWorkflow</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Role-Based Workflow collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Models function in specialized roles like researcher, analyst,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    and writer to create a structured workflow for complex tasks.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the role-based workflow phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Get workflow steps</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_steps&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="c1"># If no workflow steps defined, use default workflow</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="p">{</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;researcher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                    <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;research&quot;</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Gather comprehensive information on the topic&quot;</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_researcher&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="p">},</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="p">{</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;analyst&quot;</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                    <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;analyze&quot;</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Analyze the research and identify key insights&quot;</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_analyst&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="p">},</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                <span class="p">{</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;writer&quot;</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                    <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Create a well-structured response based on the analysis&quot;</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_writer&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="p">},</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="p">{</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;editor&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                    <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;edit&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Review and refine the written content for clarity and accuracy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                    <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_editor&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>                <span class="p">}</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                <span class="sa">f</span><span class="s2">&quot;No workflow steps defined for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, using default workflow&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="c1"># Validate workflow steps</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">):</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="k">if</span> <span class="s2">&quot;role&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;role_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing role, using &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="k">if</span> <span class="s2">&quot;task&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing task, using &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="k">if</span> <span class="s2">&quot;template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;role_</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing template, using &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="sa">f</span><span class="s2">&quot;Initialized RoleBasedWorkflow phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">)</span><span class="si">}</span><span class="s2"> workflow steps&quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Role-Based Workflow phase.&quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="c1"># Map models to roles</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">role_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_models_to_roles</span><span class="p">()</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="c1"># Initialize workflow context</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">workflow_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="s2">&quot;final_output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="o">**</span><span class="n">inputs</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="p">}</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="c1"># Execute workflow steps in sequence</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="k">for</span> <span class="n">step_idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">role</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">task</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">template_name</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing workflow step </span><span class="si">{</span><span class="n">step_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="c1"># Get model for this role</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">model_id</span> <span class="o">=</span> <span class="n">role_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">model_id</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model assigned for role &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39;, skipping step&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="c1"># Format prompt for this step - IMPROVED VARIABLE HANDLING</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                    <span class="c1"># Start with a clean set of variables for this step</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                    <span class="n">prompt_vars</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                    <span class="c1"># Always include the query</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="n">prompt_vars</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="c1"># Include inputs from previous phases</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                    <span class="n">prompt_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                    <span class="c1"># Handle input_from parameter for this step</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                    <span class="n">input_from_list</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_from&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_from_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                        <span class="n">input_from_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_from_list</span><span class="p">]</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                    <span class="c1"># If no input_from specified but not first step, use all previous steps</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_from_list</span> <span class="ow">and</span> <span class="n">step_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                        <span class="n">input_from_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">prev_step</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">prev_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">[:</span><span class="n">step_idx</span><span class="p">]]</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                    <span class="c1"># Add the specified inputs from workflow context AS DIRECT VARIABLES</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                    <span class="k">for</span> <span class="n">input_task</span> <span class="ow">in</span> <span class="n">input_from_list</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                        <span class="k">if</span> <span class="n">input_task</span> <span class="ow">in</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                            <span class="n">prompt_vars</span><span class="p">[</span><span class="n">input_task</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">input_task</span><span class="p">]</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39; requires input from &#39;</span><span class="si">{</span><span class="n">input_task</span><span class="si">}</span><span class="s2">&#39;, but it is not available&quot;</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                    <span class="c1"># Format the prompt with the prepared variables</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                    <span class="n">step_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">prompt_vars</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt for step &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="c1"># Run model with the formatted prompt</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                    <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">step_prompt</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                    <span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                        <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                            <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                            <span class="n">input_prompt</span><span class="o">=</span><span class="n">step_prompt</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                            <span class="n">output</span><span class="o">=</span><span class="n">step_result</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                            <span class="n">execution_time</span><span class="o">=</span><span class="n">step_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">}</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                        <span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="c1"># Extract output</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="n">step_output</span> <span class="o">=</span> <span class="n">step_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                    <span class="c1"># Store step results in workflow context by task name</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                    <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_output</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="c1"># Also store by role name for easier reference</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="n">workflow_context</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_output</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                    <span class="c1"># Update final output (always use the latest step)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                    <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;final_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_output</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to execute step &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                <span class="sa">f</span><span class="s2">&quot;RoleBasedWorkflow phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">)}</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="n">workflow_context</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1"># Get final output</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">final_output</span> <span class="o">=</span> <span class="n">workflow_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_output&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_output</span> <span class="ow">and</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="c1"># Use the last step&#39;s output</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">final_step</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="n">final_output</span> <span class="o">=</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">final_step</span><span class="p">]</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># Calculate confidence (average from step results that have confidence)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="k">for</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">step_result</span> <span class="ow">in</span> <span class="n">workflow_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">step_result</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                        <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                        <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">final_output</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="s2">&quot;workflow_steps&quot;</span><span class="p">:</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">],</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="p">}</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="sa">f</span><span class="s2">&quot;RoleBasedWorkflow phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_assign_models_to_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign models to roles in the workflow.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            Dictionary mapping roles to model IDs.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="c1"># Check for explicit role assignments in configuration</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">role_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role_assignments&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="c1"># If explicit assignments provided, use them</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="k">if</span> <span class="n">role_assignments</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">return</span> <span class="n">role_assignments</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="c1"># Otherwise, try to use model roles</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">role_to_model</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="c1"># First try to match roles based on model metadata</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="n">model_role</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_role</span><span class="p">()</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                <span class="k">if</span> <span class="n">model_role</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                    <span class="c1"># Check if this role is used in the workflow</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                        <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_role</span> <span class="ow">and</span> <span class="n">model_role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_to_model</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                            <span class="n">role_to_model</span><span class="p">[</span><span class="n">model_role</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_id</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                            <span class="k">break</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="k">pass</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="c1"># For any unassigned roles, distribute remaining models</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">available_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_to_model</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">model_idx</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">role</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">role_to_model</span> <span class="ow">and</span> <span class="n">available_models</span><span class="p">:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="n">role_to_model</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="n">available_models</span><span class="p">[</span><span class="n">model_idx</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_models</span><span class="p">)]</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="n">model_idx</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="c1"># Log assignments</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Role assignments: </span><span class="si">{</span><span class="n">role_to_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">return</span> <span class="n">role_to_model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.RoleBasedWorkflow.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the role-based workflow phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.ConfigurationError">ConfigurationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase configuration is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\role_based_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span>
<span class="normal"><a href="#__codelineno-0-90">90</a></span>
<span class="normal"><a href="#__codelineno-0-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the role-based workflow phase.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        ConfigurationError: If phase configuration is invalid.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="c1"># Get workflow steps</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;workflow_steps&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># If no workflow steps defined, use default workflow</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="p">{</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;researcher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;research&quot;</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Gather comprehensive information on the topic&quot;</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_researcher&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="p">},</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="p">{</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;analyst&quot;</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;analyze&quot;</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Analyze the research and identify key insights&quot;</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_analyst&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="p">},</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="p">{</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;writer&quot;</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Create a well-structured response based on the analysis&quot;</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_writer&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="p">},</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="p">{</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;editor&quot;</span><span class="p">,</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;edit&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Review and refine the written content for clarity and accuracy&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="s2">&quot;role_editor&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="p">}</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="p">]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="sa">f</span><span class="s2">&quot;No workflow steps defined for phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;, using default workflow&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="c1"># Validate workflow steps</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">):</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">if</span> <span class="s2">&quot;role&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">step</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;role_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing role, using &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">if</span> <span class="s2">&quot;task&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="n">step</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing task, using &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">if</span> <span class="s2">&quot;template&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">step</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;role_</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing template, using &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="sa">f</span><span class="s2">&quot;Initialized RoleBasedWorkflow phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; with &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">)</span><span class="si">}</span><span class="s2"> workflow steps&quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.RoleBasedWorkflow.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Role-Based Workflow phase.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\role_based_workflow.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Role-Based Workflow phase.&quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="c1"># Get inputs from previous phases</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="c1"># Map models to roles</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">role_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_models_to_roles</span><span class="p">()</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="c1"># Initialize workflow context</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">workflow_context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">{},</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="s2">&quot;final_output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="o">**</span><span class="n">inputs</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="p">}</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="c1"># Execute workflow steps in sequence</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">for</span> <span class="n">step_idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">role</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">task</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">template_name</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing workflow step </span><span class="si">{</span><span class="n">step_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="c1"># Get model for this role</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">model_id</span> <span class="o">=</span> <span class="n">role_assignments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_id</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No model assigned for role &#39;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#39;, skipping step&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="k">continue</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="c1"># Format prompt for this step - IMPROVED VARIABLE HANDLING</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="c1"># Start with a clean set of variables for this step</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">prompt_vars</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="c1"># Always include the query</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">prompt_vars</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="c1"># Include inputs from previous phases</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">prompt_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="c1"># Handle input_from parameter for this step</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">input_from_list</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_from&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_from_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="n">input_from_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_from_list</span><span class="p">]</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="c1"># If no input_from specified but not first step, use all previous steps</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">input_from_list</span> <span class="ow">and</span> <span class="n">step_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="n">input_from_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">prev_step</span><span class="p">[</span><span class="s2">&quot;task&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">prev_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">[:</span><span class="n">step_idx</span><span class="p">]]</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="c1"># Add the specified inputs from workflow context AS DIRECT VARIABLES</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="k">for</span> <span class="n">input_task</span> <span class="ow">in</span> <span class="n">input_from_list</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                    <span class="k">if</span> <span class="n">input_task</span> <span class="ow">in</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                        <span class="n">prompt_vars</span><span class="p">[</span><span class="n">input_task</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">input_task</span><span class="p">]</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39; requires input from &#39;</span><span class="si">{</span><span class="n">input_task</span><span class="si">}</span><span class="s2">&#39;, but it is not available&quot;</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="c1"># Format the prompt with the prepared variables</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">step_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">prompt_vars</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt for step &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="k">continue</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="c1"># Run model with the formatted prompt</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">step_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">run_inference</span><span class="p">(</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">step_prompt</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                    <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                        <span class="n">input_prompt</span><span class="o">=</span><span class="n">step_prompt</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                        <span class="n">output</span><span class="o">=</span><span class="n">step_result</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                        <span class="n">execution_time</span><span class="o">=</span><span class="n">step_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                        <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">}</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                    <span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="c1"># Extract output</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="n">step_output</span> <span class="o">=</span> <span class="n">step_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="c1"># Store step results in workflow context by task name</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_output</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="c1"># Also store by role name for easier reference</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="n">workflow_context</span><span class="p">[</span><span class="n">role</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_output</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                <span class="c1"># Update final output (always use the latest step)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;final_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_output</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to execute step &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="sa">f</span><span class="s2">&quot;RoleBasedWorkflow phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow_steps</span><span class="p">)}</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">},</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="n">output_data</span><span class="o">=</span><span class="n">workflow_context</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="c1"># Get final output</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">final_output</span> <span class="o">=</span> <span class="n">workflow_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_output&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_output</span> <span class="ow">and</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="c1"># Use the last step&#39;s output</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">final_step</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">final_output</span> <span class="o">=</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">final_step</span><span class="p">]</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="c1"># Calculate confidence (average from step results that have confidence)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="k">for</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">step_result</span> <span class="ow">in</span> <span class="n">workflow_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">step_result</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">final_output</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="s2">&quot;workflow_steps&quot;</span><span class="p">:</span> <span class="n">workflow_context</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">],</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="p">}</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="sa">f</span><span class="s2">&quot;RoleBasedWorkflow phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.StackedGeneralization" class="doc doc-heading">
            <code>StackedGeneralization</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Stacked Generalization collaboration phase.</p>
<p>Base models first process the input, then a meta-model combines their outputs
to produce a more accurate result. This learns the strengths and weaknesses
of each base model to produce optimal combinations.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\stackedgeneralization.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">StackedGeneralization</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stacked Generalization collaboration phase.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Base models first process the input, then a meta-model combines their outputs</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    to produce a more accurate result. This learns the strengths and weaknesses</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    of each base model to produce optimal combinations.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>            <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Stacked Generalization collaboration phase.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="c1"># Load stacking-specific configuration</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_models&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta_model&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_combination_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combination_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_rounds&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_feedback_loop&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="c1"># Validate configuration</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; requires at least one base model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; requires a meta model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="c1"># Ensure meta model is in the list of model_ids</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Meta model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="si">}</span><span class="s2">&#39; not found in available models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="c1"># Ensure all base models are in the list of model_ids</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base model &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; not found in available models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="sa">f</span><span class="s2">&quot;Configured Stacked Generalization phase with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> base models and &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="si">}</span><span class="s2">&#39; as the meta model&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="s2">&quot;combination_strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combination_strategy</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="s2">&quot;max_rounds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="s2">&quot;use_feedback_loop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="p">}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_base_models</span><span class="p">(</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all base models on the prompt.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            prompt: The input prompt.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            Dictionary mapping model IDs to their outputs.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="c1"># Run each base model on the prompt</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">model_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                    <span class="n">model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">_base&quot;</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                    <span class="n">input_prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                    <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">],</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;base_model&quot;</span><span class="p">}</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_meta_model</span><span class="p">(</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">original_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">base_outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">round_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the meta model to combine base model outputs.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">            original_prompt: The original input prompt.</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">            base_outputs: Dictionary mapping model IDs to their outputs.</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><span class="sd">            round_num: Current round number for multi-round stacking.</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">            Meta model&#39;s output.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="c1"># Extract text outputs from each model</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">base_text_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_id</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                             <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">base_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="c1"># Format the meta-prompt that includes base model outputs</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">meta_prompt_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta_prompt_template&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="c1"># Default meta prompt if none is specified</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">meta_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;As a meta-model, your task is to combine and synthesize the outputs from multiple AI models </span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="s2">into a single, coherent, and accurate response. Here is the original query and the outputs from each model:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="s2">ORIGINAL QUERY:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="si">{</span><span class="n">original_prompt</span><span class="si">}</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="s2">MODEL OUTPUTS:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">base_text_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="n">meta_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> ---</span><span class="se">\n</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">meta_prompt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="s2">Please analyze these outputs and create a comprehensive response that:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="s2">1. Integrates the strengths of each model&#39;s response</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="s2">2. Resolves any contradictions between models</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="s2">3. Provides a coherent, well-structured answer to the original query</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="s2">4. Improves upon any weaknesses or gaps in the individual responses</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="s2">Your synthesized response:&quot;&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="c1"># Format custom meta prompt template</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="s2">&quot;original_prompt&quot;</span><span class="p">:</span> <span class="n">original_prompt</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="s2">&quot;base_outputs&quot;</span><span class="p">:</span> <span class="n">base_text_outputs</span><span class="p">,</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="n">round_num</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">meta_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="n">meta_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="c1"># Run the meta model</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">meta_prompt</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">model_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">],</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="c1"># Add trace if collector is provided</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_model_trace</span><span class="p">(</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="si">}</span><span class="s2">_meta_round</span><span class="si">{</span><span class="n">round_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">input_prompt</span><span class="o">=</span><span class="n">meta_prompt</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">output</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">],</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;meta_model&quot;</span><span class="p">,</span> <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="n">round_num</span><span class="p">}</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">]</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Stacked Generalization phase.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">            context: Context information from previous phases.</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">            trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">            Dictionary containing:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">                output: The final meta-model output.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">                base_outputs: Dictionary mapping base model IDs to their outputs.</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">                meta_output: The meta model&#39;s output.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">                rounds: Number of rounds performed.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">                context: Updated context for the next phase.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">            CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="c1"># Prepare the base prompt</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="c1"># Run the base models</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="n">base_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_base_models</span><span class="p">(</span><span class="n">base_prompt</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="c1"># Extract text outputs for easier processing</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="n">base_text_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_id</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                                 <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">base_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="c1"># Initialize meta output and round counter</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">meta_result</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">meta_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">all_round_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">all_round_results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="c1"># Iterative refinement through multiple rounds if configured</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">current_base_results</span> <span class="o">=</span> <span class="n">base_results</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="k">for</span> <span class="n">round_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="n">rounds</span> <span class="o">=</span> <span class="n">round_num</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="c1"># Run the meta model</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="n">meta_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_meta_model</span><span class="p">(</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                    <span class="n">original_prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">base_outputs</span><span class="o">=</span><span class="n">current_base_results</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">round_num</span><span class="o">=</span><span class="n">round_num</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="n">meta_output</span> <span class="o">=</span> <span class="n">meta_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="n">all_round_outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;round_</span><span class="si">{</span><span class="n">round_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_output</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                <span class="n">all_round_results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;round_</span><span class="si">{</span><span class="n">round_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_result</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="c1"># If feedback loop is enabled and we&#39;re not at the last round,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="c1"># use the meta output to inform the next round</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span> <span class="ow">and</span> <span class="n">round_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="c1"># For feedback loop, we provide the meta model&#39;s output back to base models</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="n">feedback_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Previous synthesis: </span><span class="si">{</span><span class="n">meta_output</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                    <span class="c1"># Re-run base models with feedback from meta model</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                    <span class="n">current_base_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_base_models</span><span class="p">(</span><span class="n">feedback_prompt</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                    <span class="c1"># We&#39;re done with all rounds</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                    <span class="k">break</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="c1"># Calculate confidence metrics</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="c1"># Confidence could be based on agreement between base models</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_text_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="c1"># Simple agreement metric - count words that appear in multiple outputs</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="n">word_sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">base_text_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                <span class="n">union_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">word_sets</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="k">if</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                    <span class="c1"># Count how many outputs contain each word</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                    <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                        <span class="n">word_counts</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">word_sets</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                    <span class="c1"># Average agreement across all words</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                    <span class="n">avg_agreement</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_text_outputs</span><span class="p">))</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                    <span class="n">confidence</span> <span class="o">=</span> <span class="n">avg_agreement</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="s2">&quot;base_model_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">),</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="p">}</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;base_prompt&quot;</span><span class="p">:</span> <span class="n">base_prompt</span><span class="p">},</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                        <span class="s2">&quot;base_outputs&quot;</span><span class="p">:</span> <span class="n">base_text_outputs</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                        <span class="s2">&quot;meta_output&quot;</span><span class="p">:</span> <span class="n">meta_output</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                        <span class="s2">&quot;all_round_outputs&quot;</span><span class="p">:</span> <span class="n">all_round_outputs</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                    <span class="p">},</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                        <span class="s2">&quot;base_models&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                        <span class="s2">&quot;meta_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                        <span class="s2">&quot;combination_strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combination_strategy</span><span class="p">,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                        <span class="s2">&quot;max_rounds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                        <span class="s2">&quot;rounds_completed&quot;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                        <span class="s2">&quot;use_feedback_loop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="p">}</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                <span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="c1"># Return results</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">meta_output</span><span class="p">,</span>  <span class="c1"># The final output</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="s2">&quot;base_outputs&quot;</span><span class="p">:</span> <span class="n">base_text_outputs</span><span class="p">,</span>  <span class="c1"># All base model outputs</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                <span class="s2">&quot;base_results&quot;</span><span class="p">:</span> <span class="n">base_results</span><span class="p">,</span>  <span class="c1"># Raw base model results</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                <span class="s2">&quot;meta_output&quot;</span><span class="p">:</span> <span class="n">meta_output</span><span class="p">,</span>  <span class="c1"># Meta model output</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                <span class="s2">&quot;meta_result&quot;</span><span class="p">:</span> <span class="n">meta_result</span><span class="p">,</span>  <span class="c1"># Raw meta model result</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                <span class="s2">&quot;all_round_outputs&quot;</span><span class="p">:</span> <span class="n">all_round_outputs</span><span class="p">,</span>  <span class="c1"># Outputs from each round</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                <span class="s2">&quot;all_round_results&quot;</span><span class="p">:</span> <span class="n">all_round_results</span><span class="p">,</span>  <span class="c1"># Raw results from each round</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span>  <span class="c1"># Number of rounds performed</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>  <span class="c1"># Agreement-based confidence</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                <span class="s2">&quot;execution_time&quot;</span><span class="p">:</span> <span class="n">execution_time</span>  <span class="c1"># Execution time</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="p">}</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.StackedGeneralization.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the Stacked Generalization collaboration phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_manager</code>
            </td>
            <td>
                  <code><span title="ModelManager">ModelManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config_manager</code>
            </td>
            <td>
                  <code><span title="ConfigManager">ConfigManager</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConfigManager instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>phase_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the phase for configuration lookup.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\stackedgeneralization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Stacked Generalization collaboration phase.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        model_manager: The ModelManager instance.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        config_manager: The ConfigManager instance.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        phase_name: The name of the phase for configuration lookup.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="c1"># Load stacking-specific configuration</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_models&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta_model&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_combination_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combination_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted&quot;</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_rounds&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_feedback_loop&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="c1"># Validate configuration</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; requires at least one base model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; requires a meta model&quot;</span><span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># Ensure meta model is in the list of model_ids</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Meta model &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="si">}</span><span class="s2">&#39; not found in available models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># Ensure all base models are in the list of model_ids</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base model &#39;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; not found in available models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="sa">f</span><span class="s2">&quot;Configured Stacked Generalization phase with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> base models and &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="si">}</span><span class="s2">&#39; as the meta model&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="s2">&quot;combination_strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combination_strategy</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="s2">&quot;max_rounds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="s2">&quot;use_feedback_loop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="p">}</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.StackedGeneralization.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Stacked Generalization phase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user query to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Context information from previous phases.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>trace_collector</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="TraceCollector (ai_ensemble_suite.utils.tracing.TraceCollector)" href="../utilities/#ai_ensemble_suite.utils.TraceCollector">TraceCollector</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional trace collector for gathering execution details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing:
output: The final meta-model output.
base_outputs: Dictionary mapping base model IDs to their outputs.
meta_output: The meta model's output.
rounds: Number of rounds performed.
context: Updated context for the next phase.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ai_ensemble_suite.exceptions.CollaborationError">CollaborationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If phase execution fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\stackedgeneralization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Stacked Generalization phase.</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        query: The user query to process.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a><span class="sd">        context: Context information from previous phases.</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="sd">        trace_collector: Optional trace collector for gathering execution details.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        Dictionary containing:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">            output: The final meta-model output.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">            base_outputs: Dictionary mapping base model IDs to their outputs.</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">            meta_output: The meta model&#39;s output.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">            rounds: Number of rounds performed.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">            context: Updated context for the next phase.</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        CollaborationError: If phase execution fails.</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="c1"># Prepare the base prompt</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="c1"># Run the base models</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">base_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_base_models</span><span class="p">(</span><span class="n">base_prompt</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="c1"># Extract text outputs for easier processing</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="n">base_text_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_id</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                             <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">base_results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="c1"># Initialize meta output and round counter</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">meta_result</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="n">meta_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">rounds</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">all_round_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">all_round_results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="c1"># Iterative refinement through multiple rounds if configured</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">current_base_results</span> <span class="o">=</span> <span class="n">base_results</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">for</span> <span class="n">round_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="n">rounds</span> <span class="o">=</span> <span class="n">round_num</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="c1"># Run the meta model</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">meta_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_meta_model</span><span class="p">(</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="n">original_prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="n">base_outputs</span><span class="o">=</span><span class="n">current_base_results</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">round_num</span><span class="o">=</span><span class="n">round_num</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="n">meta_output</span> <span class="o">=</span> <span class="n">meta_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">all_round_outputs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;round_</span><span class="si">{</span><span class="n">round_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_output</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="n">all_round_results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;round_</span><span class="si">{</span><span class="n">round_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_result</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="c1"># If feedback loop is enabled and we&#39;re not at the last round,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="c1"># use the meta output to inform the next round</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span> <span class="ow">and</span> <span class="n">round_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="c1"># For feedback loop, we provide the meta model&#39;s output back to base models</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                <span class="n">feedback_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Previous synthesis: </span><span class="si">{</span><span class="n">meta_output</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="c1"># Re-run base models with feedback from meta model</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="n">current_base_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_base_models</span><span class="p">(</span><span class="n">feedback_prompt</span><span class="p">,</span> <span class="n">trace_collector</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="c1"># We&#39;re done with all rounds</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="k">break</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="c1"># Calculate confidence metrics</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.0</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="c1"># Confidence could be based on agreement between base models</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_text_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="c1"># Simple agreement metric - count words that appear in multiple outputs</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">word_sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">base_text_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">union_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">word_sets</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="k">if</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="c1"># Count how many outputs contain each word</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                <span class="n">word_counts</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">union_words</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                    <span class="n">word_counts</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">word_sets</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                <span class="c1"># Average agreement across all words</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="n">avg_agreement</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_text_outputs</span><span class="p">))</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">avg_agreement</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="s2">&quot;base_model_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">),</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="p">}</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;base_prompt&quot;</span><span class="p">:</span> <span class="n">base_prompt</span><span class="p">},</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                <span class="n">output_data</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                    <span class="s2">&quot;base_outputs&quot;</span><span class="p">:</span> <span class="n">base_text_outputs</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                    <span class="s2">&quot;meta_output&quot;</span><span class="p">:</span> <span class="n">meta_output</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                    <span class="s2">&quot;all_round_outputs&quot;</span><span class="p">:</span> <span class="n">all_round_outputs</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                <span class="p">},</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                    <span class="s2">&quot;base_models&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_models</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                    <span class="s2">&quot;meta_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_model</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                    <span class="s2">&quot;combination_strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combination_strategy</span><span class="p">,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                    <span class="s2">&quot;max_rounds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rounds</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                    <span class="s2">&quot;rounds_completed&quot;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="s2">&quot;use_feedback_loop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_feedback_loop</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                <span class="p">}</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">meta_output</span><span class="p">,</span>  <span class="c1"># The final output</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="s2">&quot;base_outputs&quot;</span><span class="p">:</span> <span class="n">base_text_outputs</span><span class="p">,</span>  <span class="c1"># All base model outputs</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="s2">&quot;base_results&quot;</span><span class="p">:</span> <span class="n">base_results</span><span class="p">,</span>  <span class="c1"># Raw base model results</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="s2">&quot;meta_output&quot;</span><span class="p">:</span> <span class="n">meta_output</span><span class="p">,</span>  <span class="c1"># Meta model output</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="s2">&quot;meta_result&quot;</span><span class="p">:</span> <span class="n">meta_result</span><span class="p">,</span>  <span class="c1"># Raw meta model result</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="s2">&quot;all_round_outputs&quot;</span><span class="p">:</span> <span class="n">all_round_outputs</span><span class="p">,</span>  <span class="c1"># Outputs from each round</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="s2">&quot;all_round_results&quot;</span><span class="p">:</span> <span class="n">all_round_results</span><span class="p">,</span>  <span class="c1"># Raw results from each round</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="s2">&quot;rounds&quot;</span><span class="p">:</span> <span class="n">rounds</span><span class="p">,</span>  <span class="c1"># Number of rounds performed</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>  <span class="c1"># Agreement-based confidence</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="s2">&quot;execution_time&quot;</span><span class="p">:</span> <span class="n">execution_time</span>  <span class="c1"># Execution time</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="p">}</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="sa">f</span><span class="s2">&quot;Stacked Generalization phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.StructuredCritique" class="doc doc-heading">
            <code>StructuredCritique</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDebate (ai_ensemble_suite.collaboration.structured_debate.base_debate.BaseDebate)" href="#ai_ensemble_suite.collaboration.BaseDebate">BaseDebate</a></code></p>


        <p>Structured Critique debate pattern.</p>
<p>Models evaluate others' responses using structured formats with
specific critique dimensions like accuracy, clarity, and completeness.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\critique.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">StructuredCritique</span><span class="p">(</span><span class="n">BaseDebate</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Structured Critique debate pattern.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Models evaluate others&#39; responses using structured formats with</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    specific critique dimensions like accuracy, clarity, and completeness.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_debate_pattern</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">initial_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the structured critique debate pattern.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            initial_response: The initial response to critique.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            Dictionary containing debate results.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            CollaborationError: If execution fails.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="c1"># Get prompt template</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="sa">f</span><span class="s2">&quot;Critique phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; missing prompt template&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># Format prompt</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="o">**</span><span class="n">inputs</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="p">}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="n">critique_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format critique prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># Run critique models</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">critique_prompt</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="c1"># Process outputs</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">critiques</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">critiques</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># Combine critiques if multiple critics</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">critiques</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">combined_critique</span> <span class="o">=</span> <span class="s2">&quot;# Combined Critiques</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">critique</span> <span class="ow">in</span> <span class="n">critiques</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                <span class="n">combined_critique</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;## Critique from </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">critique</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">critique_text</span> <span class="o">=</span> <span class="n">combined_critique</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">elif</span> <span class="n">critiques</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="c1"># Just use the single critique</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">critique_text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">critiques</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">critique_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="c1"># Extract key points from the critique</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">key_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_key_points</span><span class="p">(</span><span class="n">critique_text</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="c1"># Calculate confidence score (average from all models)</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">critique_text</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="s2">&quot;critique&quot;</span><span class="p">:</span> <span class="n">critique_text</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="s2">&quot;key_points&quot;</span><span class="p">:</span> <span class="n">key_points</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="s2">&quot;model_critiques&quot;</span><span class="p">:</span> <span class="n">critiques</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.SynthesisOriented" class="doc doc-heading">
            <code>SynthesisOriented</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDebate (ai_ensemble_suite.collaboration.structured_debate.base_debate.BaseDebate)" href="#ai_ensemble_suite.collaboration.BaseDebate">BaseDebate</a></code></p>


        <p>Synthesis-Oriented debate pattern.</p>
<p>Models focus on finding common ground and integrating perspectives
rather than critique. This pattern is more collaborative than adversarial.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\structured_debate\synthesis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">SynthesisOriented</span><span class="p">(</span><span class="n">BaseDebate</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Synthesis-Oriented debate pattern.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Models focus on finding common ground and integrating perspectives</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    rather than critique. This pattern is more collaborative than adversarial.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_debate_pattern</span><span class="p">(</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">initial_response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the synthesis-oriented debate pattern.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            query: The user query to process.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            initial_response: The initial response to synthesize with.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            inputs: Inputs from previous phases.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            trace_collector: Optional trace collector.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            Dictionary containing debate results.</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            CollaborationError: If execution fails.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="c1"># Get prompt template</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="sa">f</span><span class="s2">&quot;Synthesis phase &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="si">}</span><span class="s2">&#39; missing prompt template&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># Format prompt</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="o">**</span><span class="n">inputs</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="p">}</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="n">synthesis_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format synthesis prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="c1"># Run synthesis models</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">model_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">synthesis_prompt</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="c1"># Process outputs</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">synthesis_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">synthesis_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># Combine syntheses if multiple models</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synthesis_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="c1"># Determine the primary model (first in model_ids list)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">primary_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="c1"># Use the primary model&#39;s synthesis if available</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="k">if</span> <span class="n">primary_model</span> <span class="ow">and</span> <span class="n">primary_model</span> <span class="ow">in</span> <span class="n">synthesis_outputs</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>                <span class="n">synthesis_text</span> <span class="o">=</span> <span class="n">synthesis_outputs</span><span class="p">[</span><span class="n">primary_model</span><span class="p">]</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="c1"># Or combine all syntheses</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="n">combined_synthesis</span> <span class="o">=</span> <span class="s2">&quot;# Integrated Perspectives</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">synthesis</span> <span class="ow">in</span> <span class="n">synthesis_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="n">combined_synthesis</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;## Perspective from </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">synthesis</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="n">synthesis_text</span> <span class="o">=</span> <span class="n">combined_synthesis</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">elif</span> <span class="n">synthesis_outputs</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="c1"># Just use the single synthesis</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">synthesis_text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">synthesis_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">synthesis_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="c1"># Calculate confidence score (average from all models)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">confidence_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">model_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="k">if</span> <span class="s2">&quot;confidence&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">][</span><span class="s2">&quot;combined&quot;</span><span class="p">])</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="n">confidence_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">])</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">confidence</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_values</span> <span class="k">else</span> <span class="mf">0.7</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="c1"># Return results</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">synthesis_text</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="s2">&quot;synthesis&quot;</span><span class="p">:</span> <span class="n">synthesis_text</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="s2">&quot;initial_response&quot;</span><span class="p">:</span> <span class="n">initial_response</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="s2">&quot;individual_syntheses&quot;</span><span class="p">:</span> <span class="n">synthesis_outputs</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="s2">&quot;raw_results&quot;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">confidence</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration" class="doc doc-heading">
            <code>UncertaintyBasedCollaboration</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseCollaborationPhase (ai_ensemble_suite.collaboration.base.BaseCollaborationPhase)" href="#ai_ensemble_suite.collaboration.BaseCollaborationPhase">BaseCollaborationPhase</a></code></p>


        <p>Uncertainty-Based Collaboration phase.</p>
<p>This collaborative phase uses uncertainty measurements to guide model interactions.
Initial model outputs are analyzed for uncertainty, then the collaboration adapts
by using more confident models to refine uncertain outputs or by selecting the
most reliable outputs from multiple models.</p>







              <details class="quote">
                <summary>Source code in <code>src\ai_ensemble_suite\collaboration\uncertaintybased.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">UncertaintyBasedCollaboration</span><span class="p">(</span><span class="n">BaseCollaborationPhase</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Uncertainty-Based Collaboration phase.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    This collaborative phase uses uncertainty measurements to guide model interactions.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    Initial model outputs are analyzed for uncertainty, then the collaboration adapts</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    by using more confident models to refine uncertain outputs or by selecting the</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    most reliable outputs from multiple models.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>            <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Uncertainty-Based Collaboration phase.&quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="c1"># Load uncertainty-specific configuration</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uncertainty_metric&quot;</span><span class="p">,</span> <span class="s2">&quot;disagreement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_selection_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selection_method&quot;</span><span class="p">,</span> <span class="s2">&quot;least_uncertain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallback_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refinement_iterations&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adaptive_selection&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="sa">f</span><span class="s2">&quot;Configured UncertaintyBasedCollaboration phase with metric: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty_metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                <span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_method</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="s2">&quot;refinement_iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="p">}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_uncertainty_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate uncertainty metrics between multiple outputs.&quot;&quot;&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="s2">&quot;disagreement&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">1.0</span>  <span class="c1"># Start with high confidence</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="p">}</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="c1"># Can&#39;t calculate uncertainty with fewer than 2 outputs</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">return</span> <span class="n">metrics</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="c1"># Calculate word-level disagreement</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">word_sets</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="c1"># Create sets of significant words for comparison</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="n">words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">word_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># Calculate average Jaccard distance between all pairs</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">jaccard_distances</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_sets</span><span class="p">)):</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_sets</span><span class="p">)):</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                <span class="c1"># Jaccard distance = 1 - (intersection / union)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_sets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">word_sets</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_sets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">word_sets</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>                <span class="k">if</span> <span class="n">union</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="n">jaccard_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">if</span> <span class="n">jaccard_distances</span><span class="p">:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;disagreement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jaccard_distances</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">jaccard_distances</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="c1"># Calculate word distribution entropy</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">all_words</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="n">all_words</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">word_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">all_words</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">total_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_words</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">if</span> <span class="n">total_words</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="c1"># Calculate normalized entropy</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">count</span> <span class="o">/</span> <span class="n">total_words</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">word_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">entropy</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">probs</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="c1"># Normalize by maximum possible entropy</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="n">max_entropy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_counts</span><span class="p">))</span> <span class="k">if</span> <span class="n">word_counts</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="k">if</span> <span class="n">max_entropy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;entropy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">entropy</span> <span class="o">/</span> <span class="n">max_entropy</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="c1"># Handle numerical issues</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;entropy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="c1"># Calculate output length variance (normalized)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">mean_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">if</span> <span class="n">mean_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">variance</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">length</span> <span class="o">-</span> <span class="n">mean_len</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="c1"># Normalize variance by mean squared to get scale-invariant measure</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">variance</span> <span class="o">/</span> <span class="p">(</span><span class="n">mean_len</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">mean_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="c1"># Calculate overall confidence score (inverse of uncertainty)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="c1"># Weight the metrics based on importance</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="s2">&quot;disagreement&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># Disagreement has highest weight</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># Entropy next</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="mf">0.1</span>  <span class="c1"># Length variance least important</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="p">}</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="n">uncertainty_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span> <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">uncertainty_score</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">return</span> <span class="n">metrics</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_output_disagreement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">other_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate how much a specific output disagrees with others.&quot;&quot;&quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">other_outputs</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="k">return</span> <span class="mf">0.0</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">target_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_output</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">all_disagreements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">other_outputs</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">other_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_words</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">other_words</span><span class="p">))</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">if</span> <span class="n">union</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Both empty</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">all_disagreements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">intersection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_words</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other_words</span><span class="p">))</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="n">disagreement</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span><span class="p">)</span>  <span class="c1"># Jaccard distance</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">all_disagreements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">disagreement</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="c1"># Return average disagreement with all other outputs</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">all_disagreements</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_disagreements</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_disagreements</span> <span class="k">else</span> <span class="mf">0.0</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_output_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely extract text from an output value, handling different formats.&quot;&quot;&quot;</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">output_value</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="k">return</span> <span class="n">output_value</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="k">return</span> <span class="n">output_value</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected output format: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">output_value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_value</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize outputs to a consistent format with &#39;text&#39; key.&quot;&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">normalized</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">normalized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">normalized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected output format for key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="n">normalized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">return</span> <span class="n">normalized</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_model_subset</span><span class="p">(</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">model_outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">uncertainty_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select a subset of models for refinement based on uncertainty metrics.&quot;&quot;&quot;</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">normalized_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_outputs</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized_outputs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">normalized_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="c1"># Calculate per-model disagreement</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">model_scores</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">output_data</span> <span class="ow">in</span> <span class="n">normalized_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">output_text</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">other_outputs</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="n">normalized_outputs</span><span class="p">[</span><span class="n">m_id</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m_id</span> <span class="ow">in</span> <span class="n">normalized_outputs</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="k">if</span> <span class="n">m_id</span> <span class="o">!=</span> <span class="n">model_id</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="p">]</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">disagreement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_output_disagreement</span><span class="p">(</span><span class="n">output_text</span><span class="p">,</span> <span class="n">other_outputs</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">agreement</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">disagreement</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">model_scores</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agreement</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="c1"># If overall confidence is high, use all models</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="k">if</span> <span class="n">uncertainty_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">normalized_outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="c1"># Otherwise, select top models based on agreement</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">sorted_models</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">model_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">model_scores</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="c1"># Take top half of models (at least 1)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">num_to_select</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_models</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="k">return</span> <span class="n">sorted_models</span><span class="p">[:</span><span class="n">num_to_select</span><span class="p">]</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_refinement_prompt</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">base_prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="n">model_outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">uncertainty_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a prompt for the refinement models, incorporating uncertainty information.&quot;&quot;&quot;</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="n">normalized_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_outputs</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">refinement_prompt</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="sa">f</span><span class="s2">&quot;The following question needs a refined answer:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="sa">f</span><span class="s2">&quot;Initial responses have been generated with a confidence of </span><span class="si">{</span><span class="n">uncertainty_metrics</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="c1"># Add information about areas of disagreement</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="k">if</span> <span class="n">uncertainty_metrics</span><span class="p">[</span><span class="s2">&quot;disagreement&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">refinement_prompt</span> <span class="o">+=</span> <span class="s2">&quot;There is significant disagreement between initial responses. &quot;</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">if</span> <span class="n">uncertainty_metrics</span><span class="p">[</span><span class="s2">&quot;entropy&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">refinement_prompt</span> <span class="o">+=</span> <span class="s2">&quot;The responses show high variability in their content. &quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">refinement_prompt</span> <span class="o">+=</span> <span class="s2">&quot;Here are the previous responses:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="c1"># Add model outputs</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">output_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">normalized_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">output_text</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="c1"># Limit text length to avoid excessively long prompts</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="n">output_text</span> <span class="o">=</span> <span class="n">output_text</span><span class="p">[:</span><span class="mi">497</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="n">refinement_prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Response </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">output_text</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">refinement_prompt</span> <span class="o">+=</span> <span class="p">(</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="s2">&quot;Please provide a refined, accurate response that addresses any inconsistencies &quot;</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="s2">&quot;or uncertainties in the previous responses. Focus on generating a comprehensive &quot;</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="s2">&quot;and confident answer.&quot;</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">return</span> <span class="n">refinement_prompt</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_best_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the best output from a set of outputs based on confidence or other metrics.</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">            outputs: Dictionary of outputs to select from</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">            Dictionary containing the selected output information including model_id and text</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;No outputs available.&quot;</span><span class="p">}</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_outputs</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="c1"># If only one output, return it</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">normalized</span><span class="p">))</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="p">}</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="c1"># Otherwise, select based on confidence</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">best_model_id</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="n">best_confidence</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">output_data</span> <span class="ow">in</span> <span class="n">normalized</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">best_confidence</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="n">best_model_id</span> <span class="o">=</span> <span class="n">model_id</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="c1"># Return best output, or first one if all confidences are equal</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">if</span> <span class="n">best_model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="n">best_model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">normalized</span><span class="p">))</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="n">best_model_id</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">[</span><span class="n">best_model_id</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">normalized</span><span class="p">[</span><span class="n">best_model_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="p">}</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the Uncertainty-Based Collaboration phase.&quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="c1"># Prepare the base prompt</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                    <span class="c1"># import json</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                    <span class="c1"># print(&quot;DEBUG CONTEXT STRUCTURE:&quot;, json.dumps(context_dict, default=str, indent=2))</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                    <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                    <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="c1"># Check if we have inputs from previous phases to use</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="n">initial_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="k">if</span> <span class="s1">&#39;input_from&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">and</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;input_from&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                    <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                        <span class="n">phase_data</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                        <span class="k">if</span> <span class="s1">&#39;outputs&#39;</span> <span class="ow">in</span> <span class="n">phase_data</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                            <span class="c1"># Use outputs from previous phase as initial outputs</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                            <span class="n">initial_outputs</span> <span class="o">=</span> <span class="n">phase_data</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> outputs from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                        <span class="k">elif</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="n">phase_data</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                            <span class="c1"># If only a single output is available</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                            <span class="n">initial_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;previous_phase&#39;</span><span class="p">:</span> <span class="n">phase_data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]}</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using single output from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="c1"># If no previous outputs, get initial outputs from all models</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_outputs</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="n">initial_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                    <span class="n">model_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                    <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                <span class="c1"># Extract text outputs</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">initial_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                        <span class="n">initial_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                            <span class="s2">&quot;generation_time&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                        <span class="p">}</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="c1"># If still no outputs, raise an error</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_outputs</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No outputs available from models or previous phases&quot;</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="c1"># Calculate uncertainty metrics for initial outputs - handle both dict and string outputs</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">all_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">initial_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="n">all_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_output_text</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">uncertainty_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_uncertainty_metrics</span><span class="p">(</span><span class="n">all_outputs</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="c1"># Store iterations for tracing</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">iterations</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>                <span class="p">{</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                    <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                    <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">initial_outputs</span><span class="p">,</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                    <span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">:</span> <span class="n">uncertainty_metrics</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                <span class="p">}</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="p">]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>            <span class="c1"># Normalize outputs for consistent processing</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">current_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_outputs</span><span class="p">(</span><span class="n">initial_outputs</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="n">current_metrics</span> <span class="o">=</span> <span class="n">uncertainty_metrics</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="c1"># Determine if refinement is needed based on confidence</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="n">needs_refinement</span> <span class="o">=</span> <span class="n">current_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="n">refinement_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">refinement_success</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="c1"># Perform iterative refinement if needed</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="k">while</span> <span class="p">(</span><span class="n">needs_refinement</span> <span class="ow">and</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                   <span class="n">refinement_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span><span class="p">):</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                <span class="n">refinement_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                    <span class="sa">f</span><span class="s2">&quot;Starting refinement iteration </span><span class="si">{</span><span class="n">refinement_count</span><span class="si">}</span><span class="s2"> due to low confidence &quot;</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                    <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">current_metrics</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">}</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                    <span class="c1"># Select models for refinement</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive_selection</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                        <span class="c1"># Get model IDs that correspond to actual loaded models</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                        <span class="n">available_models</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                        <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">current_outputs</span> <span class="ow">or</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_loaded_models</span><span class="p">():</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                                <span class="n">available_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_models</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No models available for refinement, using all configured models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                            <span class="n">available_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                        <span class="n">refinement_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_model_subset</span><span class="p">(</span><span class="n">current_outputs</span><span class="p">,</span> <span class="n">current_metrics</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                        <span class="c1"># Ensure selected models are available</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                        <span class="n">refinement_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">refinement_models</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">available_models</span><span class="p">]</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                        <span class="c1"># Use all models</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                        <span class="n">refinement_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                    <span class="c1"># Skip refinement if no models available</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">refinement_models</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No models available for refinement, skipping&quot;</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                        <span class="k">break</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                    <span class="c1"># Create refinement prompt with uncertainty information</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                    <span class="n">refinement_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_refinement_prompt</span><span class="p">(</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                        <span class="n">base_prompt</span><span class="p">,</span> <span class="n">current_outputs</span><span class="p">,</span> <span class="n">current_metrics</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                    <span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                    <span class="c1"># Run selected models with refinement prompt</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                    <span class="n">refinement_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">refinement_prompt</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                        <span class="n">model_ids</span><span class="o">=</span><span class="n">refinement_models</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                        <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                    <span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                    <span class="c1"># Extract refined outputs - check if we got any results</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                    <span class="n">refined_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                    <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">refinement_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                        <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                            <span class="n">refined_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                                <span class="s2">&quot;generation_time&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                                <span class="s2">&quot;is_refinement&quot;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                            <span class="p">}</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                    <span class="c1"># If we got no refined outputs, stop refinement</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">refined_outputs</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No refined outputs produced in this iteration, stopping refinement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                        <span class="k">break</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                    <span class="c1"># Calculate uncertainty metrics for refined outputs</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                    <span class="n">refined_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">refined_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                    <span class="n">refined_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_uncertainty_metrics</span><span class="p">(</span><span class="n">refined_texts</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                    <span class="c1"># Store this iteration</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                    <span class="n">iterations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                        <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">refinement_count</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                        <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">refined_outputs</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                        <span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">:</span> <span class="n">refined_metrics</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                        <span class="s2">&quot;refinement_models&quot;</span><span class="p">:</span> <span class="n">refinement_models</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                    <span class="p">})</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                    <span class="c1"># Update current state</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                    <span class="n">current_outputs</span> <span class="o">=</span> <span class="n">refined_outputs</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                    <span class="n">current_metrics</span> <span class="o">=</span> <span class="n">refined_metrics</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                    <span class="n">refinement_success</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                    <span class="c1"># Check if further refinement is needed</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                    <span class="n">needs_refinement</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                        <span class="n">current_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span> <span class="ow">and</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                        <span class="n">refinement_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                    <span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during refinement iteration </span><span class="si">{</span><span class="n">refinement_count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                    <span class="c1"># Continue with the next iteration if available, or exit the loop</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                    <span class="k">if</span> <span class="n">refinement_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                        <span class="k">break</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="c1"># Select final output based on uncertainty metrics across all iterations</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="n">best_iteration</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>            <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iteration_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                <span class="n">confidence</span> <span class="o">=</span> <span class="n">iteration_data</span><span class="p">[</span><span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">best_confidence</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                    <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                    <span class="n">best_iteration</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="c1"># Get outputs from best iteration</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>            <span class="n">best_iteration_data</span> <span class="o">=</span> <span class="n">iterations</span><span class="p">[</span><span class="n">best_iteration</span><span class="p">]</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="n">best_outputs</span> <span class="o">=</span> <span class="n">best_iteration_data</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="c1"># Select best output</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="n">best_output_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_output</span><span class="p">(</span><span class="n">best_outputs</span><span class="p">)</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="c1"># Get final output information</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="n">best_model_id</span> <span class="o">=</span> <span class="n">best_output_info</span><span class="p">[</span><span class="s2">&quot;model_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="n">best_output</span> <span class="o">=</span> <span class="n">best_output_info</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">best_iteration_data</span><span class="p">[</span><span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">]</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="c1"># Log completion</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                <span class="sa">f</span><span class="s2">&quot;Uncertainty-based collaboration phase completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s &quot;</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="n">refinement_count</span><span class="si">}</span><span class="s2"> refinement iterations&quot;</span><span class="p">,</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                    <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                    <span class="s2">&quot;best_iteration&quot;</span><span class="p">:</span> <span class="n">best_iteration</span><span class="p">,</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                    <span class="s2">&quot;best_model&quot;</span><span class="p">:</span> <span class="n">best_model_id</span><span class="p">,</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                    <span class="s2">&quot;refinement_success&quot;</span><span class="p">:</span> <span class="n">refinement_success</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                <span class="p">}</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>            <span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>            <span class="c1"># Prepare result with all outputs and metrics</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>            <span class="n">final_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">best_output</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                <span class="s2">&quot;best_model&quot;</span><span class="p">:</span> <span class="n">best_model_id</span><span class="p">,</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                <span class="s2">&quot;best_iteration&quot;</span><span class="p">:</span> <span class="n">best_iteration</span><span class="p">,</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                <span class="s2">&quot;refinement_count&quot;</span><span class="p">:</span> <span class="n">refinement_count</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                <span class="s2">&quot;refinement_success&quot;</span><span class="p">:</span> <span class="n">refinement_success</span><span class="p">,</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                <span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">:</span> <span class="n">best_metrics</span><span class="p">,</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">iterations</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="p">}</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>                <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>                    <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>                    <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;base_prompt&quot;</span><span class="p">:</span> <span class="n">base_prompt</span><span class="p">},</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                    <span class="n">output_data</span><span class="o">=</span><span class="n">final_result</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                    <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                    <span class="n">phase_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                        <span class="s2">&quot;uncertainty_metric&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty_metric</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                        <span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_method</span><span class="p">,</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                        <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">,</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                        <span class="s2">&quot;refinement_iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                    <span class="p">}</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                <span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="k">return</span> <span class="n">final_result</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in uncertainty-based collaboration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uncertainty-based collaboration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the Uncertainty-Based Collaboration phase.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\uncertaintybased.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">model_manager</span><span class="p">:</span> <span class="s2">&quot;ModelManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">config_manager</span><span class="p">:</span> <span class="s2">&quot;ConfigManager&quot;</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="n">phase_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Uncertainty-Based Collaboration phase.&quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_manager</span><span class="p">,</span> <span class="n">config_manager</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="c1"># Load uncertainty-specific configuration</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uncertainty_metric&quot;</span><span class="p">,</span> <span class="s2">&quot;disagreement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_selection_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selection_method&quot;</span><span class="p">,</span> <span class="s2">&quot;least_uncertain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence_threshold&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fallback_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refinement_iterations&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;adaptive_selection&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="sa">f</span><span class="s2">&quot;Configured UncertaintyBasedCollaboration phase with metric: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty_metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_method</span><span class="p">,</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="s2">&quot;refinement_iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="p">}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ai_ensemble_suite.collaboration.UncertaintyBasedCollaboration.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">trace_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the Uncertainty-Based Collaboration phase.</p>


            <details class="quote">
              <summary>Source code in <code>src\ai_ensemble_suite\collaboration\uncertaintybased.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">trace_collector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TraceCollector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the Uncertainty-Based Collaboration phase.&quot;&quot;&quot;</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="c1"># Prepare the base prompt</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="n">base_prompt</span> <span class="o">=</span> <span class="n">query</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inputs_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                <span class="n">context_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">}</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                <span class="c1"># import json</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                <span class="c1"># print(&quot;DEBUG CONTEXT STRUCTURE:&quot;, json.dumps(context_dict, default=str, indent=2))</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prompt_template</span><span class="p">,</span> <span class="n">context_dict</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="k">except</span> <span class="p">(</span><span class="n">ConfigurationError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to format prompt: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="c1"># Check if we have inputs from previous phases to use</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">initial_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="k">if</span> <span class="s1">&#39;input_from&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">and</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;input_from&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                    <span class="n">phase_data</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>                    <span class="k">if</span> <span class="s1">&#39;outputs&#39;</span> <span class="ow">in</span> <span class="n">phase_data</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                        <span class="c1"># Use outputs from previous phase as initial outputs</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                        <span class="n">initial_outputs</span> <span class="o">=</span> <span class="n">phase_data</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> outputs from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                    <span class="k">elif</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="n">phase_data</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                        <span class="c1"># If only a single output is available</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                        <span class="n">initial_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;previous_phase&#39;</span><span class="p">:</span> <span class="n">phase_data</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]}</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using single output from phase &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="c1"># If no previous outputs, get initial outputs from all models</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_outputs</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="n">initial_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">base_prompt</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="n">model_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="c1"># Extract text outputs</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">initial_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                    <span class="n">initial_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                        <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                        <span class="s2">&quot;generation_time&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                    <span class="p">}</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="c1"># If still no outputs, raise an error</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">initial_outputs</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="s2">&quot;No outputs available from models or previous phases&quot;</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="c1"># Calculate uncertainty metrics for initial outputs - handle both dict and string outputs</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">all_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">initial_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>            <span class="n">all_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_output_text</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">uncertainty_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_uncertainty_metrics</span><span class="p">(</span><span class="n">all_outputs</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="c1"># Store iterations for tracing</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">iterations</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="p">{</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">initial_outputs</span><span class="p">,</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">:</span> <span class="n">uncertainty_metrics</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="p">}</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="p">]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="c1"># Normalize outputs for consistent processing</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">current_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_outputs</span><span class="p">(</span><span class="n">initial_outputs</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">current_metrics</span> <span class="o">=</span> <span class="n">uncertainty_metrics</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="c1"># Determine if refinement is needed based on confidence</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="n">needs_refinement</span> <span class="o">=</span> <span class="n">current_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="n">refinement_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="n">refinement_success</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="c1"># Perform iterative refinement if needed</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">while</span> <span class="p">(</span><span class="n">needs_refinement</span> <span class="ow">and</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>               <span class="n">refinement_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span><span class="p">):</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="n">refinement_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="sa">f</span><span class="s2">&quot;Starting refinement iteration </span><span class="si">{</span><span class="n">refinement_count</span><span class="si">}</span><span class="s2"> due to low confidence &quot;</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">current_metrics</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">}</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                <span class="c1"># Select models for refinement</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adaptive_selection</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                    <span class="c1"># Get model IDs that correspond to actual loaded models</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                    <span class="n">available_models</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                    <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">current_outputs</span> <span class="ow">or</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_manager</span><span class="o">.</span><span class="n">get_loaded_models</span><span class="p">():</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                            <span class="n">available_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">available_models</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No models available for refinement, using all configured models&quot;</span><span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                        <span class="n">available_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                    <span class="n">refinement_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_model_subset</span><span class="p">(</span><span class="n">current_outputs</span><span class="p">,</span> <span class="n">current_metrics</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                    <span class="c1"># Ensure selected models are available</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                    <span class="n">refinement_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">refinement_models</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">available_models</span><span class="p">]</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                    <span class="c1"># Use all models</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                    <span class="n">refinement_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_ids</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="c1"># Skip refinement if no models available</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">refinement_models</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No models available for refinement, skipping&quot;</span><span class="p">)</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                    <span class="k">break</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                <span class="c1"># Create refinement prompt with uncertainty information</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="n">refinement_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_refinement_prompt</span><span class="p">(</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                    <span class="n">base_prompt</span><span class="p">,</span> <span class="n">current_outputs</span><span class="p">,</span> <span class="n">current_metrics</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                <span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="c1"># Run selected models with refinement prompt</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="n">refinement_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_models</span><span class="p">(</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">refinement_prompt</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                    <span class="n">model_ids</span><span class="o">=</span><span class="n">refinement_models</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                    <span class="n">trace_collector</span><span class="o">=</span><span class="n">trace_collector</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="c1"># Extract refined outputs - check if we got any results</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="n">refined_outputs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="k">for</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">refinement_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                    <span class="k">if</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                        <span class="n">refined_outputs</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                            <span class="s2">&quot;generation_time&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;generation_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                            <span class="s2">&quot;is_refinement&quot;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                        <span class="p">}</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                <span class="c1"># If we got no refined outputs, stop refinement</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">refined_outputs</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No refined outputs produced in this iteration, stopping refinement&quot;</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                    <span class="k">break</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="c1"># Calculate uncertainty metrics for refined outputs</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                <span class="n">refined_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">refined_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                <span class="n">refined_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_uncertainty_metrics</span><span class="p">(</span><span class="n">refined_texts</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                <span class="c1"># Store this iteration</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                <span class="n">iterations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                    <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">refinement_count</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                    <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">refined_outputs</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                    <span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">:</span> <span class="n">refined_metrics</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                    <span class="s2">&quot;refinement_models&quot;</span><span class="p">:</span> <span class="n">refinement_models</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                <span class="p">})</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                <span class="c1"># Update current state</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                <span class="n">current_outputs</span> <span class="o">=</span> <span class="n">refined_outputs</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                <span class="n">current_metrics</span> <span class="o">=</span> <span class="n">refined_metrics</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                <span class="n">refinement_success</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                <span class="c1"># Check if further refinement is needed</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                <span class="n">needs_refinement</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                    <span class="n">current_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span> <span class="ow">and</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                    <span class="n">refinement_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                <span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during refinement iteration </span><span class="si">{</span><span class="n">refinement_count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                <span class="c1"># Continue with the next iteration if available, or exit the loop</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                <span class="k">if</span> <span class="n">refinement_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span><span class="p">:</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                    <span class="k">break</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="c1"># Select final output based on uncertainty metrics across all iterations</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="n">best_iteration</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iteration_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="n">confidence</span> <span class="o">=</span> <span class="n">iteration_data</span><span class="p">[</span><span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">][</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">best_confidence</span><span class="p">:</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">confidence</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                <span class="n">best_iteration</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="c1"># Get outputs from best iteration</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="n">best_iteration_data</span> <span class="o">=</span> <span class="n">iterations</span><span class="p">[</span><span class="n">best_iteration</span><span class="p">]</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="n">best_outputs</span> <span class="o">=</span> <span class="n">best_iteration_data</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="c1"># Select best output</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="n">best_output_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_output</span><span class="p">(</span><span class="n">best_outputs</span><span class="p">)</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="c1"># Get final output information</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="n">best_model_id</span> <span class="o">=</span> <span class="n">best_output_info</span><span class="p">[</span><span class="s2">&quot;model_id&quot;</span><span class="p">]</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="n">best_output</span> <span class="o">=</span> <span class="n">best_output_info</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="n">best_metrics</span> <span class="o">=</span> <span class="n">best_iteration_data</span><span class="p">[</span><span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">]</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="c1"># Log completion</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="sa">f</span><span class="s2">&quot;Uncertainty-based collaboration phase completed in </span><span class="si">{</span><span class="n">execution_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s &quot;</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="n">refinement_count</span><span class="si">}</span><span class="s2"> refinement iterations&quot;</span><span class="p">,</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                <span class="s2">&quot;best_iteration&quot;</span><span class="p">:</span> <span class="n">best_iteration</span><span class="p">,</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                <span class="s2">&quot;best_model&quot;</span><span class="p">:</span> <span class="n">best_model_id</span><span class="p">,</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                <span class="s2">&quot;refinement_success&quot;</span><span class="p">:</span> <span class="n">refinement_success</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>            <span class="p">}</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="c1"># Prepare result with all outputs and metrics</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">final_result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">best_output</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">best_metrics</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">],</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="s2">&quot;best_model&quot;</span><span class="p">:</span> <span class="n">best_model_id</span><span class="p">,</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>            <span class="s2">&quot;best_iteration&quot;</span><span class="p">:</span> <span class="n">best_iteration</span><span class="p">,</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>            <span class="s2">&quot;refinement_count&quot;</span><span class="p">:</span> <span class="n">refinement_count</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>            <span class="s2">&quot;refinement_success&quot;</span><span class="p">:</span> <span class="n">refinement_success</span><span class="p">,</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="s2">&quot;uncertainty_metrics&quot;</span><span class="p">:</span> <span class="n">best_metrics</span><span class="p">,</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>            <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">iterations</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="p">}</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="c1"># Add phase trace if collector is provided</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="k">if</span> <span class="n">trace_collector</span><span class="p">:</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>            <span class="n">trace_collector</span><span class="o">.</span><span class="n">add_phase_trace</span><span class="p">(</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>                <span class="n">phase_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_phase_name</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>                <span class="n">input_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;base_prompt&quot;</span><span class="p">:</span> <span class="n">base_prompt</span><span class="p">},</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>                <span class="n">output_data</span><span class="o">=</span><span class="n">final_result</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="n">execution_time</span><span class="o">=</span><span class="n">execution_time</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="n">phase_parameters</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                    <span class="s2">&quot;uncertainty_metric&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uncertainty_metric</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                    <span class="s2">&quot;selection_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_method</span><span class="p">,</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                    <span class="s2">&quot;confidence_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confidence_threshold</span><span class="p">,</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                    <span class="s2">&quot;refinement_iterations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refinement_iterations</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                <span class="p">}</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="k">return</span> <span class="n">final_result</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in uncertainty-based collaboration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="k">raise</span> <span class="n">CollaborationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uncertainty-based collaboration failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>